<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros Resolvidos - SRE GURUPI</title>
    <link rel="stylesheet" href="styles.css">
    
    <style>
        /* Estilos personalizados para os filtros */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .filter-group select:hover,
        .filter-group input:hover {
            border-color: #007bff;
        }
        
        /* Responsividade para dispositivos m√≥veis */
        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Melhorar o visual da se√ß√£o de filtros */
        .filters-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        

        
        
    </style>
</head>
<body>
    <div class="header">
        <h1>Registros Resolvidos</h1>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="main-container">
        <div class="card">
            <div style="position: relative;">
                <a href="user-dashboard.html" class="btn btn-secondary" style="position: absolute; top: 0; right: 0; font-size: 12px; padding: 6px 12px; margin: 0; background-color: #28a745; border-color: #28a745;">Voltar ao Menu</a>
                <h2 style="margin-top: 60px;">Sistema de Registros Resolvidos</h2>
            </div>
            <p>Visualize todos os registros que foram marcados como resolvidos</p>
             
                         <!-- Bot√µes de A√ß√£o R√°pida -->
            <div class="quick-actions" style="margin: 20px 0; text-align: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 10px; border: 1px solid #e1bee7;">
                <button onclick="clearAllFilters()" class="btn btn-secondary" style="margin-right: 10px;">üóëÔ∏è Limpar Todos os Filtros</button>
                <button onclick="refreshRecords()" class="btn btn-primary">üîÑ Atualizar Registros</button>
            </div>
             
             <!-- Filtros de Pesquisa -->
             <div class="filters-section">
                 
                 <div class="filters-grid">
                     <!-- Escola -->
                     <div class="filter-group">
                         <label for="schoolFilter">Escola:</label>
                         <select id="schoolFilter" onchange="filterRecords()">
                             <option value="">Todas as escolas</option>
                         </select>
                     </div>

                     <!-- Munic√≠pio -->
                     <div class="filter-group">
                         <label for="municipalityFilter">Munic√≠pio:</label>
                         <select id="municipalityFilter" onchange="filterRecords()">
                             <option value="">Todos os munic√≠pios</option>
                         </select>
                     </div>

                     <!-- Departamento -->
                     <div class="filter-group">
                         <label for="municipalityFilter">Departamento:</label>
                         <select id="departmentFilter" onchange="filterRecords()">
                             <option value="">Todos os departamentos</option>
                             <option value="Curr√≠culo">Curr√≠culo</option>
                             <option value="Equipe Multiprofissional">Equipe Multiprofissional</option>
                             <option value="Supervis√£o">Supervis√£o</option>
                         </select>
                     </div>

                     <!-- Indicador -->
                     <div class="filter-group">
                         <label for="indicatorFilter">Indicador:</label>
                         <select id="indicatorFilter" onchange="filterRecords()">
                             <option value="">Todos os indicadores</option>
                             <option value="Frequ√™ncia dos Estudantes">Frequ√™ncia dos Estudantes</option>
                             <option value="Busca Ativa">Busca Ativa</option>
                             <option value="Aulas Previstas e Aulas Dadas">Aulas Previstas e Aulas Dadas</option>
                             <option value="Estudantes Abaixo da M√©dia">Estudantes Abaixo da M√©dia</option>
                         </select>
                     </div>

                     <!-- Data de Resolu√ß√£o -->
                     <div class="filter-group">
                         <label for="resolvedDateFilter">Data de Resolu√ß√£o:</label>
                         <input type="date" id="resolvedDateFilter" onchange="filterRecords()">
                     </div>

                     <!-- Resolvido por -->
                     <div class="filter-group">
                         <label for="resolvedByFilter">Resolvido por:</label>
                         <input type="text" id="resolvedByFilter" placeholder="Nome do usu√°rio" onkeyup="filterRecords()">
                     </div>
                 </div>
             </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="action-buttons" style="margin: 30px 0; text-align: center; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                <button onclick="downloadExcel()" class="btn btn-primary"> Exportar Excel</button>
                <button onclick="downloadPDF()" class="btn btn-primary"> Exportar PDF</button>
                <a href="monitoring-records-unified.html" class="btn btn-secondary"> Voltar aos Registros</a>
            </div>

            <!-- Estat√≠sticas -->
            <div class="stats-section">
                <div class="stat-card">
                    <h3>Total de Resolvidos</h3>
                    <span id="totalResolved">0</span>
                </div>
                <div class="stat-card">
                    <h3>Resolvidos Filtrados</h3>
                    <span id="filteredResolved">0</span>
                </div>
                <div class="stat-card">
                    <h3>√öltima Atualiza√ß√£o</h3>
                    <span id="lastUpdate">-</span>
                </div>
            </div>

            <!-- Lista de Registros Resolvidos -->
            <div class="records-section">
                <h3>Registros Resolvidos</h3>
                <div id="resolvedRecordsList" class="records-container">
                    <div class="loading">Carregando registros resolvidos...</div>
                </div>
            </div>


        </div>
    </div>

    <!-- Modal para Visualizar Registro Resolvido -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Visualizar Registro Resolvido</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conte√∫do do registro ser√° inserido aqui -->
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, orderBy, query, where, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABEloTfC_nT5vfDHpeqYdDjNoPCKwE-Eo",
            authDomain: "projeto-alex-aaadf.firebaseapp.com",
            projectId: "projeto-alex-aaadf",
            storageBucket: "projeto-alex-aaadf.firebasestorage.app",
            messagingSenderId: "720032595137",
            appId: "1:720032595137:web:85834232e770a942216840"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allResolvedRecords = [];
        let filteredResolvedRecords = [];

        // Verificar autentica√ß√£o
        function checkAuth() {
            const userRole = localStorage.getItem('userRole');
            const userCPF = localStorage.getItem('userCPF');
            const userName = localStorage.getItem('userName');
            
            if (!userRole || !userCPF || !userName) {
                window.location.href = 'index.html';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('userCPF');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            window.location.href = 'index.html';
        }

        // Carregar todos os registros resolvidos
        async function loadResolvedRecords() {
            try {
                console.log('Carregando registros resolvidos...');
                
                try {
                    // Carregar registros com status 'resolved' da cole√ß√£o records
                    // Removendo orderBy para evitar erro de √≠ndice
                    const q = query(
                        collection(db, 'records'), 
                        where('status', '==', 'resolved')
                    );
                    const querySnapshot = await getDocs(q);
                    
                    allResolvedRecords = [];
                    querySnapshot.forEach((doc) => {
                        allResolvedRecords.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar localmente por data de resolu√ß√£o (mais recente primeiro)
                    allResolvedRecords.sort((a, b) => {
                        const dateA = a.resolvedAt ? (a.resolvedAt.toDate ? a.resolvedAt.toDate() : new Date(a.resolvedAt)) : new Date(0);
                        const dateB = b.resolvedAt ? (b.resolvedAt.toDate ? b.resolvedAt.toDate() : new Date(b.resolvedAt)) : new Date(0);
                        return dateB - dateA; // Ordem decrescente
                    });
                    
                    console.log(`Total de registros resolvidos carregados: ${allResolvedRecords.length}`);
                    
                } catch (firebaseError) {
                    console.error('Erro ao carregar registros resolvidos:', firebaseError);
                    allResolvedRecords = [];
                }
                
                populateFilterOptions();
                filterRecords();
                updateLastUpdate();
                
            } catch (error) {
                console.error('Erro ao carregar registros resolvidos:', error);
                document.getElementById('resolvedRecordsList').innerHTML = '<div class="error">Erro ao carregar registros resolvidos: ' + error.message + '</div>';
            }
        }

        // Popular op√ß√µes dos filtros
        function populateFilterOptions() {
            const schools = [...new Set(allResolvedRecords.map(r => r.school).filter(Boolean))];
            const municipalities = [...new Set(allResolvedRecords.map(r => r.municipality).filter(Boolean))];

            // Popular escolas
            const schoolFilter = document.getElementById('schoolFilter');
            schoolFilter.innerHTML = '<option value="">Todas as escolas</option>';
            schools.forEach(school => {
                schoolFilter.innerHTML += `<option value="${school}">${school}</option>`;
            });

            // Popular munic√≠pios
            const municipalityFilter = document.getElementById('municipalityFilter');
            municipalityFilter.innerHTML = '<option value="">Todos os munic√≠pios</option>';
            municipalities.forEach(municipality => {
                municipalityFilter.innerHTML += `<option value="${municipality}">${municipality}</option>`;
            });
        }

        // Filtrar registros resolvidos
        function filterRecords() {
            const schoolFilter = document.getElementById('schoolFilter').value;
            const municipalityFilter = document.getElementById('municipalityFilter').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            const indicatorFilter = document.getElementById('indicatorFilter').value;
            const resolvedDateFilter = document.getElementById('resolvedDateFilter').value;
            const resolvedByFilter = document.getElementById('resolvedByFilter').value.toLowerCase();

            filteredResolvedRecords = allResolvedRecords.filter(record => {
                // Filtro por escola
                if (schoolFilter && record.school !== schoolFilter) return false;
                
                // Filtro por munic√≠pio
                if (municipalityFilter && record.municipality !== municipalityFilter) return false;
                
                // Filtro por departamento
                if (departmentFilter && record.department !== departmentFilter) return false;
                
                // Filtro por indicador
                if (indicatorFilter && record.indicator !== indicatorFilter) return false;
                
                // Filtro por data de resolu√ß√£o
                if (resolvedDateFilter && record.resolvedAt) {
                    let resolvedDate;
                    if (record.resolvedAt.toDate) {
                        // Firebase Timestamp
                        resolvedDate = new Date(record.resolvedAt.toDate()).toISOString().split('T')[0];
                    } else {
                        // String de data
                        resolvedDate = new Date(record.resolvedAt).toISOString().split('T')[0];
                    }
                    if (resolvedDate !== resolvedDateFilter) return false;
                }
                
                // Filtro por quem resolveu
                if (resolvedByFilter && !record.resolvedByName?.toLowerCase().includes(resolvedByFilter)) return false;
                
                return true;
            });

            displayResolvedRecords();
            updateStats();
        }

        // Exibir registros resolvidos
        function displayResolvedRecords() {
            const recordsList = document.getElementById('resolvedRecordsList');
            
            if (filteredResolvedRecords.length === 0) {
                recordsList.innerHTML = '<div class="no-records">Nenhum registro resolvido encontrado com os filtros aplicados.</div>';
                return;
            }

            let html = '';
            filteredResolvedRecords.forEach(record => {
                const date = record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A';
                const createdAt = record.createdAt ? new Date(record.createdAt.toDate()).toLocaleDateString('pt-BR') : 'N/A';
                
                let resolvedAt = 'N/A';
                if (record.resolvedAt) {
                    if (record.resolvedAt.toDate) {
                        // Firebase Timestamp
                        resolvedAt = new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR');
                    } else {
                        // String de data
                        resolvedAt = new Date(record.resolvedAt).toLocaleDateString('pt-BR');
                    }
                }
                
                html += `
                    <div class="record-card resolved">
                        <div class="record-header">
                            <h4>${record.indicator}</h4>
                            <span class="department-badge ${record.department.replace(/\s+/g, '-').toLowerCase()}">${record.department}</span>
                            <span class="status-badge resolved">‚úÖ Resolvido</span>
                        </div>
                        <div class="record-info">
                            <p><strong>Escola:</strong> ${record.school}</p>
                            <p><strong>Munic√≠pio:</strong> ${record.municipality}</p>
                            <p><strong>T√©cnico:</strong> ${record.technician}</p>
                            <p><strong>Data:</strong> ${date}</p>
                            ${record.studentName ? `<p><strong>Estudante:</strong> ${record.studentName}</p>` : ''}
                            <p><strong>Criado em:</strong> ${createdAt}</p>
                            <p><strong>Resolvido em:</strong> ${resolvedAt}</p>
                            <p><strong>Resolvido por:</strong> ${record.resolvedByName || 'N/A'}</p>
                        </div>
                        <div class="record-actions">
                            <button onclick="viewResolvedRecord('${record.id}')" class="btn btn-primary">üëÅÔ∏è Visualizar</button>
                            <button onclick="deleteResolvedRecord('${record.id}')" class="btn btn-danger">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        // Visualizar registro resolvido detalhado
        async function viewResolvedRecord(recordId) {
            const record = allResolvedRecords.find(r => r.id === recordId);
            if (!record) return;

            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = `${record.indicator} - ${record.department} (RESOLVIDO)`;
            
            let html = `
                <div class="record-details">
                    <h3>Informa√ß√µes Gerais</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Escola:</strong> ${record.school}
                        </div>
                        <div class="detail-item">
                            <strong>Munic√≠pio:</strong> ${record.municipality}
                        </div>
                        <div class="detail-item">
                            <strong>T√©cnico:</strong> ${record.technician}
                        </div>
                        <div class="detail-item">
                            <strong>Data:</strong> ${record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Departamento:</strong> ${record.department}
                        </div>
                        <div class="detail-item">
                            <strong>Indicador:</strong> ${record.indicator}
                        </div>
                    </div>

                    <h3>Informa√ß√µes de Resolu√ß√£o</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Status:</strong> <span class="status-badge resolved">‚úÖ Resolvido</span>
                        </div>
                        <div class="detail-item">
                            <strong>Resolvido em:</strong> ${record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleString('pt-BR') : 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Resolvido por:</strong> ${record.resolvedByName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Fun√ß√£o:</strong> ${record.resolvedByRole || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>CPF:</strong> ${record.resolvedBy || 'N/A'}
                        </div>
                    </div>
            `;

            // Informa√ß√µes espec√≠ficas por indicador
            if (record.indicator === 'Frequ√™ncia dos Estudantes') {
                html += `
                    <h3>Dados do Estudante</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Nome:</strong> ${record.studentName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Faltas Consecutivas:</strong> ${record.consecutiveAbsences || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Etapa:</strong> ${record.etapa || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>ID da Turma:</strong> ${record.turmaId || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Status:</strong> ${record.status || 'N/A'}
                        </div>
                    </div>
                `;
            } else if (record.indicator === 'Busca Ativa') {
                html += `
                    <h3>Dados da Busca</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Turno:</strong> ${record.shift || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Estudante:</strong> ${record.studentName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Faltas:</strong> ${record.absences || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Total de Visitas:</strong> ${record.totalVisitas || 'N/A'}
                        </div>
                    </div>
                `;
            }

            // Observa√ß√µes e Links
            if (record.observations) {
                html += `
                    <h3>Observa√ß√µes</h3>
                    <p>${record.observations}</p>
                `;
            }

            if (record.documentLinks) {
                html += `
                    <h3>Links de Documentos</h3>
                    <p>${record.documentLinks}</p>
                `;
            }

            html += `
                    <h3>Informa√ß√µes do Sistema</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Criado por:</strong> ${record.createdByName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Fun√ß√£o:</strong> ${record.createdByRole || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Data de Cria√ß√£o:</strong> ${record.createdAt ? new Date(record.createdAt.toDate()).toLocaleString('pt-BR') : 'N/A'}
                        </div>
                    </div>
                </div>
            `;

            modalBody.innerHTML = html;
            document.getElementById('viewModal').style.display = 'block';
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        // Limpar todos os filtros
        function clearAllFilters() {
            document.getElementById('schoolFilter').value = '';
            document.getElementById('municipalityFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('indicatorFilter').value = '';
            document.getElementById('resolvedDateFilter').value = '';
            document.getElementById('resolvedByFilter').value = '';
            filterRecords();
        }

        // Atualizar registros
        function refreshRecords() {
            loadResolvedRecords();
        }
        


        // Atualizar estat√≠sticas
        function updateStats() {
            document.getElementById('totalResolved').textContent = allResolvedRecords.length;
            document.getElementById('filteredResolved').textContent = filteredResolvedRecords.length;
        }

        // Atualizar √∫ltima atualiza√ß√£o
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('pt-BR');
        }

        // Excluir registro resolvido
        async function deleteResolvedRecord(recordId) {
            if (confirm('Tem certeza que deseja excluir este registro resolvido?')) {
                try {
                    await deleteDoc(doc(db, 'records', recordId));
                    alert('Registro resolvido exclu√≠do com sucesso!');
                    loadResolvedRecords(); // Recarrega todos os registros para refletir a exclus√£o
                } catch (error) {
                    console.error('Erro ao excluir registro resolvido:', error);
                    alert('Erro ao excluir registro resolvido: ' + error.message);
                }
            }
        }

        // Download Excel com m√∫ltiplas abas organizadas por indicadores
        async function downloadExcel() {
            if (filteredResolvedRecords.length === 0) {
                alert('Nenhum registro resolvido para exportar!');
                return;
            }

            try {
                // Carregar a biblioteca SheetJS
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    // Separar registros por indicadores
                    const frequencyRecords = filteredResolvedRecords.filter(record => record.indicator === 'Frequ√™ncia dos Estudantes');
                    const activeSearchRecords = filteredResolvedRecords.filter(record => record.indicator === 'Busca Ativa');
                    const plannedClassesRecords = filteredResolvedRecords.filter(record => record.indicator === 'Aulas Previstas e Aulas Dadas');
                    const belowAverageRecords = filteredResolvedRecords.filter(record => record.indicator === 'Estudantes Abaixo da M√©dia');

                    // Criar workbook com m√∫ltiplas abas
                    const workbook = XLSX.utils.book_new();

                    // Aba 1: Frequ√™ncia dos Estudantes
                    if (frequencyRecords.length > 0) {
                        const frequencyData = frequencyRecords.map(record => ({
                            'Departamento': record.department,
                            'Indicador': record.indicator,
                            'Escola': record.school,
                            'Munic√≠pio': record.municipality,
                            'T√©cnico': record.technician,
                            'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                            'Estudante': record.studentName || 'N/A',
                            'Etapa': record.etapa || 'N/A',
                            'ID da Turma': record.turmaId || 'N/A',
                            'Faltas Consecutivas': record.consecutiveAbsences || 'N/A',
                            'Status': record.status || 'N/A',
                            'Observa√ß√µes': record.observations || 'N/A',
                            'Links de Documentos': record.documentLinks || 'N/A',
                            'Resolvido em': record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A',
                            'Resolvido por': record.resolvedByName || 'N/A',
                            'Fun√ß√£o': record.resolvedByRole || 'N/A',
                            'CPF': record.resolvedBy || 'N/A',
                            'Criado por': record.createdByName || 'N/A',
                            'Data de Cria√ß√£o': record.createdAt ? new Date(record.createdAt.toDate()).toLocaleString('pt-BR') : 'N/A'
                        }));

                        const frequencySheet = XLSX.utils.json_to_sheet(frequencyData);
                        XLSX.utils.book_append_sheet(workbook, frequencySheet, 'Frequ√™ncia dos Estudantes');
                    }

                    // Aba 2: Busca Ativa
                    if (activeSearchRecords.length > 0) {
                        const activeSearchData = activeSearchRecords.map(record => ({
                            'Departamento': record.department,
                            'Indicador': record.indicator,
                            'Escola': record.school,
                            'Munic√≠pio': record.municipality,
                            'T√©cnico': record.technician,
                            'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                            'Estudante': record.studentName || 'N/A',
                            'Nome da Turma': record.className || 'N/A',
                            'Turno': record.shift || 'N/A',
                            'Faltas': record.absences || 'N/A',
                            'Total de Visitas': record.totalVisitas || 'N/A',
                            'Observa√ß√µes': record.observations || 'N/A',
                            'Links de Documentos': record.documentLinks || 'N/A',
                            'Resolvido em': record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A',
                            'Resolvido por': record.resolvedByName || 'N/A',
                            'Fun√ß√£o': record.resolvedByRole || 'N/A',
                            'CPF': record.resolvedBy || 'N/A',
                            'Criado por': record.createdByName || 'N/A',
                            'Data de Cria√ß√£o': record.createdAt ? new Date(record.createdAt.toDate()).toLocaleString('pt-BR') : 'N/A'
                        }));

                        const activeSearchSheet = XLSX.utils.json_to_sheet(activeSearchData);
                        XLSX.utils.book_append_sheet(workbook, activeSearchSheet, 'Busca Ativa');
                    }

                    // Aba 3: Aulas Previstas e Aulas Dadas
                    if (plannedClassesRecords.length > 0) {
                        const plannedClassesData = plannedClassesRecords.map(record => ({
                            'Departamento': record.department,
                            'Indicador': record.indicator,
                            'Escola': record.school,
                            'Munic√≠pio': record.municipality,
                            'T√©cnico': record.technician,
                            'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                            'Estudante': record.studentName || 'N/A',
                            'Data Refer√™ncia': record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A',
                            'ID Turma': record.classId || 'N/A',
                            'Disciplina': record.discipline || 'N/A',
                            'Professor': record.professorName || 'N/A',
                            'Bimestre': record.bimester || 'N/A',
                            'Observa√ß√µes': record.observations || 'N/A',
                            'Links de Documentos': record.documentLinks || 'N/A',
                            'Resolvido em': record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A',
                            'Resolvido por': record.resolvedByName || 'N/A',
                            'Fun√ß√£o': record.resolvedByRole || 'N/A',
                            'CPF': record.resolvedBy || 'N/A',
                            'Criado por': record.createdByName || 'N/A',
                            'Data de Cria√ß√£o': record.createdAt ? new Date(record.createdAt.toDate()).toLocaleString('pt-BR') : 'N/A'
                        }));

                        const plannedClassesSheet = XLSX.utils.json_to_sheet(plannedClassesData);
                        XLSX.utils.book_append_sheet(workbook, plannedClassesSheet, 'Aulas Previstas e Dadas');
                    }

                    // Aba 4: Estudantes Abaixo da M√©dia
                    if (belowAverageRecords.length > 0) {
                        const belowAverageData = belowAverageRecords.map(record => ({
                            'Departamento': record.department,
                            'Indicador': record.indicator,
                            'Escola': record.school,
                            'Munic√≠pio': record.municipality,
                            'T√©cnico': record.technician,
                            'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                            'Estudante': record.studentName || 'N/A',
                            'Nota': record.studentGrade || 'N/A',
                            'Situa√ß√£o': record.studentSituation || 'N/A',
                            'S√©rie/Turma': record.seriesClass || 'N/A',
                            'Observa√ß√µes': record.observations || 'N/A',
                            'Links de Documentos': record.documentLinks || 'N/A',
                            'Resolvido em': record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A',
                            'Resolvido por': record.resolvedByName || 'N/A',
                            'Fun√ß√£o': record.resolvedByRole || 'N/A',
                            'CPF': record.resolvedBy || 'N/A',
                            'Criado por': record.createdByName || 'N/A',
                            'Data de Cria√ß√£o': record.createdAt ? new Date(record.createdAt.toDate()).toLocaleString('pt-BR') : 'N/A'
                        }));

                        const belowAverageSheet = XLSX.utils.json_to_sheet(belowAverageData);
                        XLSX.utils.book_append_sheet(workbook, belowAverageSheet, 'Estudantes Abaixo da M√©dia');
                    }

                    // Aba 5: Resumo Geral
                    const summaryData = filteredResolvedRecords.map(record => ({
                        'Departamento': record.department,
                        'Indicador': record.indicator,
                        'Escola': record.school,
                        'Munic√≠pio': record.municipality,
                        'T√©cnico': record.technician,
                        'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                        'Estudante': record.studentName || 'N/A',
                        'Observa√ß√µes': record.observations || 'N/A',
                        'Resolvido em': record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A',
                        'Resolvido por': record.resolvedByName || 'N/A'
                    }));

                    const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(workbook, summarySheet, 'Resumo Geral');

                    // Ajustar largura das colunas automaticamente
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const columnWidths = [];
                        
                        // Calcular largura m√°xima para cada coluna
                        XLSX.utils.sheet_to_json(worksheet, { header: 1 }).forEach(row => {
                            row.forEach((cell, index) => {
                                const cellLength = cell ? cell.toString().length : 0;
                                columnWidths[index] = Math.max(columnWidths[index] || 0, cellLength);
                            });
                        });

                        // Aplicar largura das colunas
                        worksheet['!cols'] = columnWidths.map(width => ({ width: Math.min(Math.max(width + 2, 10), 50) }));
                    });

                    // Gerar e baixar o arquivo Excel
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `registros_resolvidos_${new Date().toISOString().split('T')[0]}.xlsx`;
                    link.click();
                    URL.revokeObjectURL(url);

                    // Remover o script ap√≥s o uso
                    document.head.removeChild(script);
                };

                script.onerror = () => {
                    alert('Erro ao carregar a biblioteca de exporta√ß√£o Excel. Tente novamente.');
                };

            } catch (error) {
                console.error('Erro na exporta√ß√£o Excel:', error);
                alert('Erro ao exportar para Excel. Tente novamente.');
            }
        }

        // Download PDF profissional com todas as informa√ß√µes
        async function downloadPDF() {
            if (filteredResolvedRecords.length === 0) {
                alert('Nenhum registro resolvido para exportar!');
                return;
            }

            try {
                // Carregar a biblioteca jsPDF
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    const { jsPDF } = window.jspdf;
                    
                    // Criar novo documento PDF
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 20;
                    const contentWidth = pageWidth - (2 * margin);
                    
                    let yPosition = 50; // Aumentado para dar espa√ßo ao cabe√ßalho
                    let currentPage = 1;

                    // Fun√ß√£o para adicionar cabe√ßalho com imagem em todas as p√°ginas
                    const addHeaderWithImage = () => {
                        try {
                            // Adicionar imagem do cabe√ßalho
                            const img = new Image();
                            img.src = 'images/cabecalho.png';
                            
                            // Aguardar o carregamento da imagem
                            img.onload = () => {
                                // Calcular dimens√µes da imagem (largura m√°xima de 80mm)
                                const maxWidth = 80;
                                const aspectRatio = img.width / img.height;
                                const imgWidth = maxWidth;
                                const imgHeight = maxWidth / aspectRatio;
                                
                                // Centralizar a imagem horizontalmente
                                const imgX = (pageWidth - imgWidth) / 2;
                                
                                // Adicionar a imagem no topo
                                doc.addImage(img, 'PNG', imgX, 10, imgWidth, imgHeight);
                                
                                // Adicionar linha separadora abaixo da imagem
                                doc.setDrawColor(200, 200, 200);
                                doc.setLineWidth(0.5);
                                doc.line(margin, 10 + imgHeight + 5, pageWidth - margin, 10 + imgHeight + 5);
                            };
                            
                            // Se a imagem n√£o carregar, continuar sem ela
                            img.onerror = () => {
                                console.log('Imagem do cabe√ßalho n√£o carregou, continuando sem ela');
                            };
                        } catch (error) {
                            console.log('Erro ao carregar imagem do cabe√ßalho:', error);
                        }
                    };

                    // Adicionar cabe√ßalho na primeira p√°gina
                    addHeaderWithImage();

                    // Fun√ß√£o para adicionar nova p√°gina
                    const addNewPage = () => {
                        doc.addPage();
                        currentPage++;
                        yPosition = 50;
                        
                        // Adicionar cabe√ßalho com imagem na nova p√°gina
                        addHeaderWithImage();
                        
                        // N√∫mero da p√°gina no canto superior direito
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`P√°gina ${currentPage}`, pageWidth - margin, 20, { align: 'right' });
                    };

                    // T√≠tulo principal
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RELAT√ìRIO DE REGISTROS RESOLVIDOS', pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 15;

                    // Informa√ß√µes do relat√≥rio
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Total de registros resolvidos: ${filteredResolvedRecords.length}`, margin, yPosition);
                    yPosition += 8;
                    doc.text(`Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}`, margin, yPosition);
                    yPosition += 15;

                    // Separar registros por indicadores
                    const frequencyRecords = filteredResolvedRecords.filter(record => record.indicator === 'Frequ√™ncia dos Estudantes');
                    const activeSearchRecords = filteredResolvedRecords.filter(record => record.indicator === 'Busca Ativa');
                    const plannedClassesRecords = filteredResolvedRecords.filter(record => record.indicator === 'Aulas Previstas e Aulas Dadas');
                    const belowAverageRecords = filteredResolvedRecords.filter(record => record.indicator === 'Estudantes Abaixo da M√©dia');

                    // Fun√ß√£o para verificar se precisa de nova p√°gina
                    const checkPageBreak = (requiredSpace) => {
                        if (yPosition + requiredSpace > pageHeight - margin) {
                            addNewPage();
                        }
                    };

                    // Fun√ß√£o para adicionar t√≠tulo de se√ß√£o
                    const addSectionTitle = (title) => {
                        checkPageBreak(15);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(title, margin, yPosition);
                        yPosition += 10;
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                    };

                    // Fun√ß√£o para adicionar registro detalhado
                    const addDetailedRecord = (record, index) => {
                        const recordHeight = 80; // Altura estimada para cada registro
                        checkPageBreak(recordHeight);

                        // N√∫mero do registro
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${record.indicator}`, margin, yPosition);
                        yPosition += 6;

                        // Informa√ß√µes b√°sicas
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Departamento: ${record.department}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Escola: ${record.school}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Munic√≠pio: ${record.municipality}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`T√©cnico: ${record.technician}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Data: ${record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A'}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Resolvido em: ${record.resolvedAt ? new Date(record.resolvedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Resolvido por: ${record.resolvedByName || 'N/A'}`, margin, yPosition);
                        yPosition += 5;

                        // Informa√ß√µes espec√≠ficas por indicador
                        if (record.indicator === 'Frequ√™ncia dos Estudantes') {
                            if (record.studentName || record.etapa || record.turmaId) {
                                doc.text('Dados do Estudante:', margin, yPosition);
                                yPosition += 5;
                                if (record.studentName) doc.text(`‚Ä¢ Nome: ${record.studentName}`, margin + 5, yPosition), yPosition += 4;
                                if (record.etapa) doc.text(`‚Ä¢ Etapa: ${record.etapa}`, margin + 5, yPosition), yPosition += 4;
                                if (record.turmaId) doc.text(`‚Ä¢ ID da Turma: ${record.turmaId}`, margin + 5, yPosition), yPosition += 4;
                                if (record.consecutiveAbsences) doc.text(`‚Ä¢ Faltas Consecutivas: ${record.consecutiveAbsences}`, margin + 5, yPosition), yPosition += 4;
                                if (record.status) doc.text(`‚Ä¢ Status: ${record.status}`, margin + 5, yPosition), yPosition += 4;
                            }
                        }

                        if (record.indicator === 'Busca Ativa') {
                            if (record.className || record.shift || record.absences) {
                                doc.text('Dados da Busca:', margin, yPosition);
                                yPosition += 5;
                                if (record.className) doc.text(`‚Ä¢ Nome da Turma: ${record.className}`, margin + 5, yPosition), yPosition += 4;
                                if (record.shift) doc.text(`‚Ä¢ Turno: ${record.shift}`, margin + 5, yPosition), yPosition += 4;
                                if (record.studentName) doc.text(`‚Ä¢ Estudante: ${record.studentName}`, margin + 5, yPosition), yPosition += 4;
                                if (record.absences) doc.text(`‚Ä¢ Faltas: ${record.absences}`, margin + 5, yPosition), yPosition += 4;
                                if (record.totalVisitas) doc.text(`‚Ä¢ Total de Visitas: ${record.totalVisitas}`, margin + 5, yPosition), yPosition += 4;
                            }
                        }

                        if (record.indicator === 'Aulas Previstas e Aulas Dadas') {
                            if (record.referenceDate || record.classId || record.discipline) {
                                doc.text('Detalhes das Aulas:', margin, yPosition);
                                yPosition += 5;
                                if (record.referenceDate) doc.text(`‚Ä¢ Data Refer√™ncia: ${new Date(record.referenceDate).toLocaleDateString('pt-BR')}`, margin + 5, yPosition), yPosition += 4;
                                if (record.classId) doc.text(`‚Ä¢ ID Turma: ${record.classId}`, margin + 5, yPosition), yPosition += 4;
                                if (record.discipline) doc.text(`‚Ä¢ Disciplina: ${record.discipline}`, margin + 5, yPosition), yPosition += 4;
                                if (record.professorName) doc.text(`‚Ä¢ Professor: ${record.professorName}`, margin + 5, yPosition), yPosition += 4;
                                if (record.bimester) doc.text(`‚Ä¢ Bimestre: ${record.bimester}`, margin + 5, yPosition), yPosition += 4;
                            }
                        }

                        if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                            if (record.studentGrade || record.studentSituation) {
                                doc.text('Informa√ß√µes do Estudante:', margin, yPosition);
                                yPosition += 5;
                                if (record.studentGrade) doc.text(`‚Ä¢ Nota: ${record.studentGrade}`, margin + 5, yPosition), yPosition += 4;
                                if (record.studentSituation) doc.text(`‚Ä¢ Situa√ß√£o: ${record.studentSituation}`, margin + 5, yPosition), yPosition += 4;
                                if (record.seriesClass) doc.text(`‚Ä¢ S√©rie/Turma: ${record.seriesClass}`, margin + 5, yPosition), yPosition += 4;
                            }
                        }

                        // Observa√ß√µes e Links
                        if (record.observations) {
                            doc.text(`Observa√ß√µes: ${record.observations}`, margin, yPosition);
                            yPosition += 5;
                        }

                        if (record.documentLinks) {
                            doc.text(`Links de Documentos: ${record.documentLinks}`, margin, yPosition);
                            yPosition += 5;
                        }

                        yPosition += 8; // Espa√ßo entre registros
                    };

                    // Se√ß√£o Frequ√™ncia dos Estudantes
                    if (frequencyRecords.length > 0) {
                        addSectionTitle('FREQU√äNCIA DOS ESTUDANTES');
                        frequencyRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Se√ß√£o Busca Ativa
                    if (activeSearchRecords.length > 0) {
                        addSectionTitle('BUSCA ATIVA');
                        activeSearchRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Se√ß√£o Aulas Previstas e Aulas Dadas
                    if (plannedClassesRecords.length > 0) {
                        addSectionTitle('AULAS PREVISTAS E AULAS DADAS');
                        plannedClassesRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Se√ß√£o Estudantes Abaixo da M√©dia
                    if (belowAverageRecords.length > 0) {
                        addSectionTitle('ESTUDANTES ABAIXO DA M√âDIA');
                        belowAverageRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Rodap√© na √∫ltima p√°gina
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Relat√≥rio gerado automaticamente pelo Sistema SRE GURUPI', pageWidth / 2, pageHeight - 10, { align: 'center' });

                    // Salvar o PDF
                    doc.save(`relatorio_registros_resolvidos_${new Date().toISOString().split('T')[0]}.pdf`);

                    // Remover o script ap√≥s o uso
                    document.head.removeChild(script);
                };

                script.onerror = () => {
                    alert('Erro ao carregar a biblioteca de exporta√ß√£o PDF. Tente novamente.');
                };

            } catch (error) {
                console.error('Erro na exporta√ß√£o PDF:', error);
                alert('Erro ao exportar para PDF. Tente novamente.');
            }
        }

        // Inicializar
        checkAuth();
        loadResolvedRecords();

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('viewModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Exportar fun√ß√µes para o escopo global
        window.logout = logout;
        window.viewResolvedRecord = viewResolvedRecord;
        window.closeModal = closeModal;
        window.clearAllFilters = clearAllFilters;
        window.refreshRecords = refreshRecords;
        window.filterRecords = filterRecords;
        window.downloadExcel = downloadExcel;
        window.downloadPDF = downloadPDF;
        window.deleteResolvedRecord = deleteResolvedRecord;
    </script>
</body>
</html>
