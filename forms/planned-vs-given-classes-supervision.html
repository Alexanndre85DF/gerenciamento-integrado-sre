<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Aulas Previstas e Aulas Dadas - Supervisão - SRE GURUPI</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="../js/schools.js"></script>
    <script src="../js/municipalities.js"></script>
</head>
<body>
    <div class="header">
        <h1>Aulas Previstas e Aulas Dadas - Supervisão</h1>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Formulário de Aulas Previstas e Aulas Dadas</h2>
            
            <form id="plannedClassesForm" class="form-container">
                <!-- Cabeçalho Padrão -->
                <div class="form-section">
                    <h3>Informações Gerais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school">Nome da Escola:</label>
                            <select id="school" name="school" required>
                                <option value="">Selecione a escola</option>
                                <option value="CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO">CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO</option>
                                <option value="CENTRO DE ENSINO MEDIO BOM JESUS">CENTRO DE ENSINO MEDIO BOM JESUS</option>
                                <option value="CENTRO DE ENSINO MEDIO DE GURUPI">CENTRO DE ENSINO MEDIO DE GURUPI</option>                                
                                <option value="COL DE TECELAGEM ART NSA SENHORA AUXILIADORA">COL DE TECELAGEM ART NSA SENHORA AUXILIADORA</option>
                                <option value="COL EST ALAIR SENA CONCEICAO">COL EST ALAIR SENA CONCEICAO</option>
                                <option value="COLÉGIO AGRICOLA DOM BOSCO">COLÉGIO AGRICOLA DOM BOSCO</option>
                                <option value="COLÉGIO ESTADUAL ADELAIDE FRANCISCO SOARES">COLÉGIO ESTADUAL ADELAIDE FRANCISCO SOARES</option>
                                <option value="COLÉGIO ESTADUAL ANITA CASSIMIRO MORENO">COLÉGIO ESTADUAL ANITA CASSIMIRO MORENO</option>
                                <option value="COLÉGIO ESTADUAL BENEDITO PEREIRA BANDEIRA">COLÉGIO ESTADUAL BENEDITO PEREIRA BANDEIRA</option>
                                <option value="COLÉGIO ESTADUAL CANDIDO FIGUEIRA">COLÉGIO ESTADUAL CANDIDO FIGUEIRA</option>
                                <option value="COLÉGIO ESTADUAL DE ALVORADA">COLÉGIO ESTADUAL DE ALVORADA</option>
                                <option value="COLÉGIO ESTADUAL DE TALISMA">COLÉGIO ESTADUAL DE TALISMA</option>
                                <option value="COLÉGIO ESTADUAL DOM ALANO">COLÉGIO ESTADUAL DOM ALANO</option>
                                <option value="COLÉGIO ESTADUAL ELSEBAO LIMA">COLÉGIO ESTADUAL ELSEBAO LIMA</option>
                                <option value="COLÉGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA">COLÉGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA</option>
                                <option value="COLÉGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS">COLÉGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS</option>
                                <option value="COLÉGIO ESTADUAL JOAO TAVARES MARTINS">COLÉGIO ESTADUAL JOAO TAVARES MARTINS</option>
                                <option value="COLÉGIO ESTADUAL NOSSA SENHORA APARECIDA">COLÉGIO ESTADUAL NOSSA SENHORA APARECIDA</option>
                                <option value="COLÉGIO ESTADUAL OLAVO BILAC">COLÉGIO ESTADUAL OLAVO BILAC</option>
                                <option value="COLÉGIO ESTADUAL PORTO DO RIO MARANHAO">COLÉGIO ESTADUAL PORTO DO RIO MARANHAO</option>
                                <option value="COLÉGIO ESTADUAL POSITIVO DE GURUPI">COLÉGIO ESTADUAL POSITIVO DE GURUPI</option>
                                <option value="COLÉGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA">COLÉGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA</option>
                                <option value="COLÉGIO ESTADUAL REGINA SIQUEIRA CAMPOS">COLÉGIO ESTADUAL REGINA SIQUEIRA CAMPOS</option>
                                <option value="COLÉGIO ESTADUAL TARSO DUTRA">COLÉGIO ESTADUAL TARSO DUTRA</option>
                                <option value="COLÉGIO ESTADUAL TIRADENTES">COLÉGIO ESTADUAL TIRADENTES</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR">COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA">COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA">COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA</option>
                                <option value="ESC DE TEC ART NOSSA SRA AUXILIADORA">ESC DE TEC ART NOSSA SRA AUXILIADORA</option>
                                <option value="ESC EST RETIRO">ESC EST RETIRO</option>
                                <option value="ESC EST TANCREDO DE ALMEIDA NEVES">ESC EST TANCREDO DE ALMEIDA NEVES</option>
                                <option value="ESCOLA ESTADUAL ANA MARIA DE JESUS">ESCOLA ESTADUAL ANA MARIA DE JESUS</option>
                                <option value="ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA">ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA</option>
                                <option value="ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO">ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO</option>
                                <option value="ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA">ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA</option>
                                <option value="ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA">ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA</option>
                                <option value="ESCOLA ESTADUAL NOSSA SENHORA DO CARMO">ESCOLA ESTADUAL NOSSA SENHORA DO CARMO</option>
                                <option value="ESCOLA ESTADUAL OLAVO BILAC">ESCOLA ESTADUAL OLAVO BILAC</option>
                                <option value="ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA">ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA</option>
                                <option value="ESCOLA ESTADUAL PASSO A PASSO">ESCOLA ESTADUAL PASSO A PASSO</option>
                                <option value="ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA">ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA</option>
                                <option value="ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL">ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL</option>
                                <option value="ESCOLA ESTADUAL RUI BARBOSA">ESCOLA ESTADUAL RUI BARBOSA</option>
                                <option value="ESCOLA ESTADUAL SALVADOR CAETANO">ESCOLA ESTADUAL SALVADOR CAETANO</option>
                                <option value="ESCOLA ESTADUAL VALDIR LINS">ESCOLA ESTADUAL VALDIR LINS</option>
                                <option value="ESCOLA ESTADUAL VILA GUARACY">ESCOLA ESTADUAL VILA GUARACY</option>
                                <option value="ESCOLA INDIGENA BARRA DO RIO VERDE">ESCOLA INDIGENA BARRA DO RIO VERDE</option>
                                <option value="ESCOLA INDIGENA IJANARI">ESCOLA INDIGENA IJANARI</option>
                                <option value="ESCOLA INDIGENA IJAWALA">ESCOLA INDIGENA IJAWALA</option>
                                <option value="ESCOLA INDIGENA SANAWE">ESCOLA INDIGENA SANAWE</option>
                                <option value="ESCOLA INDIGENA TAINA">ESCOLA INDIGENA TAINA</option>
                                <option value="ESCOLA INDIGENA TEMANARE">ESCOLA INDIGENA TEMANARE</option>
                                <option value="ESCOLA INDIGENA TEWADURE">ESCOLA INDIGENA TEWADURE</option>
                                <option value="ESCOLA INDIGENA TXUIRI-HINA">ESCOLA INDIGENA TXUIRI-HINA</option>
                                <option value="ESCOLA INDIGENA WAHURI">ESCOLA INDIGENA WAHURI</option>
                                <option value="ESCOLA INDIGENA WATAKURI">ESCOLA INDIGENA WATAKURI</option>
                                <option value="INSTITUTO EDUCACIONAL PASSO A PASSO">INSTITUTO EDUCACIONAL PASSO A PASSO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="municipality">Município:</label>
                            <select id="municipality" name="municipality" required>
                                <option value="">Selecione o município</option>
                                <option value="Aliança do Tocantins">Aliança do Tocantins</option>
                                <option value="Alvorada">Alvorada</option>
                                <option value="Araguaçu">Araguaçu</option>
                                <option value="Cariri do Tocantins">Cariri do Tocantins</option>
                                <option value="Crixás do Tocantins">Crixás do Tocantins</option>
                                <option value="Dueré">Dueré</option>
                                <option value="Figueirópolis">Figueirópolis</option>
                                <option value="Formoso do Araguaia">Formoso do Araguaia</option>
                                <option value="Gurupi">Gurupi</option>
                                <option value="Jaú do Tocantins">Jaú do Tocantins</option>
                                <option value="Palmeirópolis">Palmeirópolis</option>
                                <option value="Peixe">Peixe</option>
                                <option value="Sandolândia">Sandolândia</option>
                                <option value="São Salvador do Tocantins">São Salvador do Tocantins</option>
                                <option value="São Valério">São Valério</option>
                                <option value="Sucupira">Sucupira</option>
                                <option value="Talismã">Talismã</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="technician">Técnico(a):</label>
                            <input type="text" id="technician" name="technician" required>
                        </div>
                        <div class="form-group">
                            <label for="date">Data do Registro:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                </div>

                <!-- Sistema de Turmas Dinâmicas -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Turmas e Componentes Curriculares</h3>
                        <button type="button" class="btn-secondary" onclick="addTurma()">➕ Adicionar Turma</button>
                    </div>
                    <div id="turmasContainer">
                        <!-- As turmas serão adicionadas aqui dinamicamente -->
                    </div>
                </div>

                <!-- Resumo Consolidado -->
                <div class="form-section">
                    <h3>Resumo Consolidado da Escola</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Total de Turmas: <span id="totalTurmas">0</span></label>
                        </div>
                        <div class="form-group">
                            <label>Total de Aulas Previstas: <span id="totalPlanned">0</span></label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Total de Aulas Realizadas: <span id="totalGiven">0</span></label>
                        </div>
                        <div class="form-group">
                            <label>Taxa de Cumprimento Geral: <span id="completionRate">0%</span></label>
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="form-section">
                    <h3>Observações:</h3>
                    <div class="form-group">
                        <textarea id="observations" name="observations" rows="4" placeholder="Digite suas observações gerais sobre as aulas previstas e dadas..."></textarea>
                    </div>
                </div>

                <!-- Anexos -->
                <div class="form-section">
                    <h3>Anexos:</h3>
                    <p class="form-description">Faça upload de documentos relacionados (PDF, Word, Excel, imagens, etc.)</p>
                    <div class="form-group">
                        <input type="file" id="attachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt" style="margin-bottom: 10px;">
                        <div id="attachmentsList" class="attachments-list"></div>
                        <small style="color: #666; font-size: 12px;">Formatos aceitos: PDF, Word, Excel, imagens, texto. Máximo 5 arquivos.</small>
                    </div>
                </div>

                <!-- Mensagem de status -->
                <div id="statusMessage" class="status-message" style="display: none;"></div>

                <!-- Botões -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Salvar Registro</button>
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Voltar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABEloTfC_nT5vfDHpeqYdDjNoPCKwE-Eo",
            authDomain: "projeto-alex-aaadf.firebaseapp.com",
            projectId: "projeto-alex-aaadf",
            storageBucket: "projeto-alex-aaadf.firebasestorage.app",
            messagingSenderId: "720032595137",
            appId: "1:720032595137:web:85834232e770a942216840"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ===== SISTEMA DE TURMAS DINÂMICAS =====
        let turmas = [];
        let turmaCounter = 0;
        let componenteCounter = 0;

        // Função para adicionar uma nova turma
        function addTurma() {
            turmaCounter++;
            const turmaId = `turma_${turmaCounter}`;
            
                         const turma = {
                 id: turmaId,
                 idTurma: '',
                 bimester: '',
                 situation: '',
                 componentes: []
             };
            
            turmas.push(turma);
            displayTurmas();
        }

        // Função para remover uma turma
        function removeTurma(turmaId) {
            turmas = turmas.filter(t => t.id !== turmaId);
            displayTurmas();
            updateResumo();
        }

        // Função para adicionar componente curricular a uma turma
        function addComponente(turmaId) {
            componenteCounter++;
            const componenteId = `comp_${componenteCounter}`;
            
            const componente = {
                id: componenteId,
                nome: '',
                aulasPrevistas: 0,
                aulasDadas: 0,
                porcentagem: 0
            };
            
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                turma.componentes.push(componente);
                displayTurmas();
                updateResumo();
            }
        }

        // Função para remover componente curricular
        function removeComponente(turmaId, componenteId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                turma.componentes = turma.componentes.filter(c => c.id !== componenteId);
                displayTurmas();
                updateResumo();
            }
        }

        // Função para atualizar dados da turma
        function updateTurmaData(turmaId, field, value) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                turma[field] = value;
                updateResumo();
            }
        }

        // Função para atualizar dados do componente
        function updateComponenteData(turmaId, componenteId, field, value) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                const componente = turma.componentes.find(c => c.id === componenteId);
                if (componente) {
                    if (field === 'aulasPrevistas' || field === 'aulasDadas') {
                        componente[field] = parseInt(value) || 0;
                        // Calcular porcentagem automaticamente
                        if (componente.aulasPrevistas > 0) {
                            componente.porcentagem = Math.round((componente.aulasDadas / componente.aulasPrevistas) * 100);
                        } else {
                            componente.porcentagem = 0;
                        }
                    } else {
                        componente[field] = value;
                    }
                    updateResumo();
                }
            }
        }

        // Função para exibir todas as turmas
        function displayTurmas() {
            const container = document.getElementById('turmasContainer');
            
            if (turmas.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 20px;">Nenhuma turma adicionada. Clique em "Adicionar Turma" para começar.</p>';
                return;
            }
            
            let html = '';
            
            turmas.forEach((turma, turmaIndex) => {
                html += `
                    <div class="turma-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #f9f9f9;">
                        <div class="turma-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="margin: 0; color: #2c3e50;">🏫 Turma ${turmaIndex + 1}</h4>
                            <button type="button" class="btn-danger" onclick="removeTurma('${turma.id}')" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px;">🗑️ Remover Turma</button>
                        </div>
                        
                                                 <div class="form-row">
                             <div class="form-group">
                                 <label>ID da Turma:</label>
                                 <input 
                                     type="text" 
                                     placeholder="ID da turma" 
                                     value="${turma.idTurma}"
                                     onchange="updateTurmaData('${turma.id}', 'idTurma', this.value)"
                                     required
                                     style="width: 100%;"
                                 >
                             </div>
                         </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Bimestre:</label>
                                <select 
                                    onchange="updateTurmaData('${turma.id}', 'bimester', this.value)"
                                    required
                                    style="width: 100%;"
                                >
                                    <option value="">Selecione</option>
                                    <option value="1º Bimestre" ${turma.bimester === '1º Bimestre' ? 'selected' : ''}>1º Bimestre</option>
                                    <option value="2º Bimestre" ${turma.bimester === '2º Bimestre' ? 'selected' : ''}>2º Bimestre</option>
                                    <option value="3º Bimestre" ${turma.bimester === '3º Bimestre' ? 'selected' : ''}>3º Bimestre</option>
                                    <option value="4º Bimestre" ${turma.bimester === '4º Bimestre' ? 'selected' : ''}>4º Bimestre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Situação:</label>
                                <select 
                                    onchange="updateTurmaData('${turma.id}', 'situation', this.value)"
                                    required
                                    style="width: 100%;"
                                >
                                    <option value="">Selecione</option>
                                    <option value="Em andamento" ${turma.situation === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                                    <option value="Concluído" ${turma.situation === 'Concluído' ? 'selected' : ''}>Concluído</option>
                                    <option value="Pendente" ${turma.situation === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Suspenso" ${turma.situation === 'Suspenso' ? 'selected' : ''}>Suspenso</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="componentes-section" style="margin-top: 20px;">
                            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h5 style="margin: 0; color: #495057;">📚 Componentes Curriculares</h5>
                                <button type="button" class="btn-secondary" onclick="addComponente('${turma.id}')" style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px;">➕ Adicionar Componente</button>
                            </div>
                            
                            ${turma.componentes.length === 0 ? '<p style="color: #666; font-style: italic; text-align: center; padding: 10px;">Nenhum componente adicionado. Clique em "Adicionar Componente" para começar.</p>' : ''}
                            
                            ${turma.componentes.map((componente, compIndex) => `
                                <div class="componente-card" style="border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 15px; background: white;">
                                    <div class="componente-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h6 style="margin: 0; color: #6c757d;">📚 Componente ${compIndex + 1}</h6>
                                        <button type="button" onclick="removeComponente('${turma.id}', '${componente.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px;">❌</button>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Nome do Componente:</label>
                                            <input 
                                                type="text" 
                                                placeholder="Ex: Matemática, Português, História..." 
                                                value="${componente.nome}"
                                                onchange="updateComponenteData('${turma.id}', '${componente.id}', 'nome', this.value)"
                                                required
                                                style="width: 100%;"
                                            >
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Aulas Previstas:</label>
                                            <input 
                                                type="number" 
                                                min="0" 
                                                placeholder="Número de aulas previstas" 
                                                value="${componente.aulasPrevistas}"
                                                onchange="updateComponenteData('${turma.id}', '${componente.id}', 'aulasPrevistas', this.value)"
                                                required
                                                style="width: 100%;"
                                            >
                                        </div>
                                        <div class="form-group">
                                            <label>Aulas Dadas:</label>
                                            <input 
                                                type="number" 
                                                min="0" 
                                                placeholder="Número de aulas realizadas" 
                                                value="${componente.aulasDadas}"
                                                onchange="updateComponenteData('${turma.id}', '${componente.id}', 'aulasDadas', this.value)"
                                                required
                                                style="width: 100%;"
                                            >
                                        </div>
                                        <div class="form-group">
                                            <label>Taxa de Cumprimento:</label>
                                            <input 
                                                type="text" 
                                                value="${componente.porcentagem}%" 
                                                readonly
                                                style="width: 100%; background: #e9ecef; color: #495057; font-weight: bold; text-align: center;"
                                            >
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Função para atualizar resumo consolidado
        function updateResumo() {
            const totalTurmas = turmas.length;
            const totalPrevistas = turmas.reduce((total, t) => total + t.componentes.reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0);
            const totalDadas = turmas.reduce((total, t) => total + t.componentes.reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0);
            const taxaGeral = totalPrevistas > 0 ? Math.round((totalDadas / totalPrevistas) * 100) : 0;
            
            document.getElementById('totalTurmas').textContent = totalTurmas;
            document.getElementById('totalPlanned').textContent = totalPrevistas;
            document.getElementById('totalGiven').textContent = totalDadas;
            document.getElementById('completionRate').textContent = taxaGeral + '%';
        }

        // Verificar autenticação
        function checkAuth() {
            const userRole = localStorage.getItem('userRole');
            const userCPF = localStorage.getItem('userCPF');
            const userName = localStorage.getItem('userName');
            
            if (!userRole || !userCPF || !userName) {
                window.location.href = '../index.html';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('userCPF');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            window.location.href = '../index.html';
        }

        // Mostrar mensagem de status
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Gerenciar anexos múltiplos
        let selectedFiles = [];

        document.getElementById('attachments').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            
            // Adicionar novos arquivos aos existentes (evitando duplicatas)
            newFiles.forEach(newFile => {
                // Verificar se o arquivo já existe (por nome e tamanho)
                const isDuplicate = selectedFiles.some(existingFile => 
                    existingFile.name === newFile.name && existingFile.size === newFile.size
                );
                
                if (!isDuplicate && selectedFiles.length < 5) {
                    selectedFiles.push(newFile);
                }
            });
            
            // Verificar limite máximo
            if (selectedFiles.length > 5) {
                alert('Máximo de 5 arquivos permitido!');
                // Manter apenas os primeiros 5
                selectedFiles = selectedFiles.slice(0, 5);
            }
            
            displayAttachments();
            
            // Limpar o input para permitir seleção do mesmo arquivo novamente
            e.target.value = '';
        });

        function displayAttachments() {
            const attachmentsList = document.getElementById('attachmentsList');
            attachmentsList.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                attachmentsList.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 10px;">Nenhum arquivo selecionado</p>';
                return;
            }
            
            // Adicionar cabeçalho com contador e botão limpar tudo
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0; border-bottom: 1px solid #dee2e6;';
            headerDiv.innerHTML = `
                <span style="font-weight: 600; color: #333;">📎 Anexos (${selectedFiles.length}/5)</span>
                ${selectedFiles.length > 0 ? '<button type="button" onclick="clearAllAttachments()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px; cursor: pointer;">Limpar Todos</button>' : ''}
            `;
            attachmentsList.appendChild(headerDiv);
            
            selectedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'attachment-item';
                fileDiv.innerHTML = `
                    <span>📎 ${file.name} <small style="color: #666;">(${(file.size / 1024).toFixed(1)} KB)</small></span>
                    <button type="button" onclick="removeFile(${index})" class="btn-remove">❌</button>
                `;
                attachmentsList.appendChild(fileDiv);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayAttachments();
            console.log(`Arquivo removido. Total de anexos: ${selectedFiles.length}`);
        }

        function clearAllAttachments() {
            selectedFiles = [];
            displayAttachments();
            console.log('Todos os anexos foram removidos');
        }

        // Função para fazer upload dos anexos
        async function uploadAttachments() {
            console.log('🔄 Iniciando upload de anexos...');
            console.log('📁 Arquivos selecionados:', selectedFiles.length);
            
            if (selectedFiles.length === 0) {
                console.log('❌ Nenhum arquivo para fazer upload');
                return [];
            }
            
            const uploadPromises = selectedFiles.map(async (file, index) => {
                try {
                    console.log(`📤 Fazendo upload do arquivo ${index + 1}/${selectedFiles.length}: ${file.name}`);
                    
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const storageRef = ref(storage, `attachments/${fileName}`);
                    
                    console.log(`📁 Referência do storage criada: ${fileName}`);
                    
                    const snapshot = await uploadBytes(storageRef, file);
                    console.log(`✅ Upload concluído para: ${file.name}`);
                    
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    console.log(`🔗 Download URL obtida para: ${file.name}`);
                    
                    const attachmentData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        downloadURL: downloadURL,
                        uploadedAt: new Date().toISOString()
                    };
                    
                    console.log(`📋 Dados do anexo preparados:`, attachmentData);
                    return attachmentData;
                    
                } catch (error) {
                    console.error(`❌ Erro ao fazer upload de ${file.name}:`, error);
                    throw new Error(`Falha no upload de ${file.name}: ${error.message}`);
                }
            });
            
            try {
                const results = await Promise.all(uploadPromises);
                console.log(`🎉 Upload de todos os anexos concluído! Total: ${results.length}`);
                console.log('📋 Resultados finais:', results);
                return results;
            } catch (error) {
                console.error('❌ Erro geral no upload dos anexos:', error);
                throw error;
            }
        }

        // Validar formulário
        function validateForm() {
            const requiredFields = ['school', 'municipality', 'technician', 'date'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showStatus(`Por favor, preencha o campo: ${field.previousElementSibling.textContent.replace(':', '')}`, 'error');
                    field.focus();
                    return false;
                }
            }
            
            // Validar se há pelo menos uma turma
            if (turmas.length === 0) {
                showStatus('Adicione pelo menos uma turma antes de salvar!', 'error');
                return false;
            }
            
                         // Validar se cada turma tem todos os campos obrigatórios
             for (let turma of turmas) {
                 if (!turma.idTurma.trim()) {
                     showStatus(`A turma ${turmas.indexOf(turma) + 1} deve ter um ID!`, 'error');
                     return false;
                 }
                                 if (!turma.bimester) {
                     showStatus(`A turma ${turmas.indexOf(turma) + 1} deve ter um bimestre selecionado!`, 'error');
                     return false;
                 }
                 if (!turma.situation) {
                     showStatus(`A turma ${turmas.indexOf(turma) + 1} deve ter uma situação selecionada!`, 'error');
                     return false;
                 }
                 if (turma.componentes.length === 0) {
                     showStatus(`A turma ${turmas.indexOf(turma) + 1} deve ter pelo menos um componente curricular!`, 'error');
                     return false;
                 }
                 
                 // Validar se cada componente tem todos os campos obrigatórios
                 for (let componente of turma.componentes) {
                     if (!componente.nome.trim()) {
                         showStatus(`O componente da turma ${turmas.indexOf(turma) + 1} deve ter um nome!`, 'error');
                         return false;
                     }
                                         if (componente.aulasPrevistas <= 0) {
                         showStatus(`O componente "${componente.nome}" da turma ${turmas.indexOf(turma) + 1} deve ter um número válido de aulas previstas!`, 'error');
                         return false;
                     }
                     if (componente.aulasDadas < 0) {
                         showStatus(`O componente "${componente.nome}" da turma ${turmas.indexOf(turma) + 1} deve ter um número válido de aulas dadas!`, 'error');
                         return false;
                     }
                }
            }
            
            return true;
        }

        // Inicializar
        checkAuth();
        
        // Definir data atual como padrão
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // Form handler
        document.getElementById('plannedClassesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvando...';
                showStatus('Salvando registro...', 'info');
                
                console.log('Iniciando salvamento...');
                
                // Fazer upload dos anexos primeiro
                let attachments = [];
                try {
                    attachments = await uploadAttachments();
                    console.log('Anexos enviados:', attachments);
                } catch (uploadError) {
                    console.error('Erro no upload dos anexos:', uploadError);
                    showStatus('Erro no upload dos anexos: ' + uploadError.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                const formData = {
                    department: 'Supervisão',
                    indicator: 'Aulas Previstas e Aulas Dadas',
                    school: document.getElementById('school').value,
                    municipality: document.getElementById('municipality').value,
                    technician: document.getElementById('technician').value,
                    date: document.getElementById('date').value,
                    turmas: turmas, // Nova estrutura com turmas dinâmicas
                    observations: document.getElementById('observations').value,
                    attachments: attachments,
                    createdBy: localStorage.getItem('userCPF') || 'Usuário não identificado',
                    createdByRole: localStorage.getItem('userRole') || 'N/A',
                    createdByName: localStorage.getItem('userName') || 'N/A',
                    createdAt: serverTimestamp(),
                    status: 'active'
                };

                console.log('Dados do formulário:', formData);

                // Tentar salvar no Firebase
                try {
                    const docRef = await addDoc(collection(db, 'records'), formData);
                    console.log('Documento salvo com ID:', docRef.id);
                    
                    showStatus('Registro salvo com sucesso! Redirecionando...', 'success');
                    
                    // Redirecionar para registros unificados
                    setTimeout(() => {
                        window.location.href = '../monitoring-records-unified.html';
                    }, 2000);
                    
                } catch (firebaseError) {
                    console.error('Erro no Firebase:', firebaseError);
                    showStatus('Erro ao salvar no Firebase: ' + firebaseError.message, 'error');
                }
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showStatus('Erro ao salvar o registro: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Exportar funções para uso global
        window.logout = logout;
        window.removeFile = removeFile;
        window.clearAllAttachments = clearAllAttachments;
        window.addTurma = addTurma;
        window.removeTurma = removeTurma;
        window.addComponente = addComponente;
        window.removeComponente = removeComponente;
        window.updateTurmaData = updateTurmaData;
        window.updateComponenteData = updateComponenteData;
    </script>
</body>
</html>
