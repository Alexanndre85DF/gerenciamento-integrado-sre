<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Busca Ativa - Equipe Multiprofissional - SRE GURUPI</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="header">
        <h1>Busca Ativa - Equipe Multiprofissional</h1>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Formul√°rio de Busca Ativa</h2>
            
            <form id="activeSearchForm" class="form-container">
                <!-- Cabe√ßalho Padr√£o -->
                <div class="form-section">
                    <h3>Informa√ß√µes Gerais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school">Nome da Escola:</label>
                            <select id="school" name="school" required>
                                <option value="">Selecione a escola</option>
                                <option value="CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO">CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO</option>
                                <option value="CENTRO DE ENSINO MEDIO BOM JESUS">CENTRO DE ENSINO MEDIO BOM JESUS</option>
                                <option value="CENTRO DE ENSINO MEDIO DE GURUPI">CENTRO DE ENSINO MEDIO DE GURUPI</option>                                
                                <option value="COL DE TECELAGEM ART NSA SENHORA AUXILIADORA">COL DE TECELAGEM ART NSA SENHORA AUXILIADORA</option>
                                <option value="COL EST ALAIR SENA CONCEICAO">COL EST ALAIR SENA CONCEICAO</option>
                                <option value="COL√âGIO AGRICOLA DOM BOSCO">COL√âGIO AGRICOLA DOM BOSCO</option>
                                <option value="COL√âGIO ESTADUAL ADELAIDE FRANCISCO SOARES">COL√âGIO ESTADUAL ADELAIDE FRANCISCO SOARES</option>
                                <option value="COL√âGIO ESTADUAL ANITA CASSIMIRO MORENO">COL√âGIO ESTADUAL ANITA CASSIMIRO MORENO</option>
                                <option value="COL√âGIO ESTADUAL BENEDITO PEREIRA BANDEIRA">COL√âGIO ESTADUAL BENEDITO PEREIRA BANDEIRA</option>
                                <option value="COL√âGIO ESTADUAL CANDIDO FIGUEIRA">COL√âGIO ESTADUAL CANDIDO FIGUEIRA</option>
                                <option value="COL√âGIO ESTADUAL DE ALVORADA">COL√âGIO ESTADUAL DE ALVORADA</option>
                                <option value="COL√âGIO ESTADUAL DE TALISMA">COL√âGIO ESTADUAL DE TALISMA</option>
                                <option value="COL√âGIO ESTADUAL DOM ALANO">COL√âGIO ESTADUAL DOM ALANO</option>
                                <option value="COL√âGIO ESTADUAL ELSEBAO LIMA">COL√âGIO ESTADUAL ELSEBAO LIMA</option>
                                <option value="COL√âGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA">COL√âGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA</option>
                                <option value="COL√âGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS">COL√âGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS</option>
                                <option value="COL√âGIO ESTADUAL JOAO TAVARES MARTINS">COL√âGIO ESTADUAL JOAO TAVARES MARTINS</option>
                                <option value="COL√âGIO ESTADUAL NOSSA SENHORA APARECIDA">COL√âGIO ESTADUAL NOSSA SENHORA APARECIDA</option>
                                <option value="COL√âGIO ESTADUAL OLAVO BILAC">COL√âGIO ESTADUAL OLAVO BILAC</option>
                                <option value="COL√âGIO ESTADUAL PORTO DO RIO MARANHAO">COL√âGIO ESTADUAL PORTO DO RIO MARANHAO</option>
                                <option value="COL√âGIO ESTADUAL POSITIVO DE GURUPI">COL√âGIO ESTADUAL POSITIVO DE GURUPI</option>
                                <option value="COL√âGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA">COL√âGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA</option>
                                <option value="COL√âGIO ESTADUAL REGINA SIQUEIRA CAMPOS">COL√âGIO ESTADUAL REGINA SIQUEIRA CAMPOS</option>
                                <option value="COL√âGIO ESTADUAL TARSO DUTRA">COL√âGIO ESTADUAL TARSO DUTRA</option>
                                <option value="COL√âGIO ESTADUAL TIRADENTES">COL√âGIO ESTADUAL TIRADENTES</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR">COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA">COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA">COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA</option>
                                <option value="ESC DE TEC ART NOSSA SRA AUXILIADORA">ESC DE TEC ART NOSSA SRA AUXILIADORA</option>
                                <option value="ESC EST RETIRO">ESC EST RETIRO</option>
                                <option value="ESC EST TANCREDO DE ALMEIDA NEVES">ESC EST TANCREDO DE ALMEIDA NEVES</option>
                                <option value="ESCOLA ESTADUAL ANA MARIA DE JESUS">ESCOLA ESTADUAL ANA MARIA DE JESUS</option>
                                <option value="ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA">ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA</option>
                                <option value="ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO">ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO</option>
                                <option value="ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA">ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA</option>
                                <option value="ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA">ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA</option>
                                <option value="ESCOLA ESTADUAL NOSSA SENHORA DO CARMO">ESCOLA ESTADUAL NOSSA SENHORA DO CARMO</option>
                                <option value="ESCOLA ESTADUAL OLAVO BILAC">ESCOLA ESTADUAL OLAVO BILAC</option>
                                <option value="ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA">ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA</option>
                                <option value="ESCOLA ESTADUAL PASSO A PASSO">ESCOLA ESTADUAL PASSO A PASSO</option>
                                <option value="ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA">ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA</option>
                                <option value="ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL">ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL</option>
                                <option value="ESCOLA ESTADUAL RUI BARBOSA">ESCOLA ESTADUAL RUI BARBOSA</option>
                                <option value="ESCOLA ESTADUAL SALVADOR CAETANO">ESCOLA ESTADUAL SALVADOR CAETANO</option>
                                <option value="ESCOLA ESTADUAL VALDIR LINS">ESCOLA ESTADUAL VALDIR LINS</option>
                                <option value="ESCOLA ESTADUAL VILA GUARACY">ESCOLA ESTADUAL VILA GUARACY</option>
                                <option value="ESCOLA INDIGENA BARRA DO RIO VERDE">ESCOLA INDIGENA BARRA DO RIO VERDE</option>
                                <option value="ESCOLA INDIGENA IJANARI">ESCOLA INDIGENA IJANARI</option>
                                <option value="ESCOLA INDIGENA IJAWALA">ESCOLA INDIGENA IJAWALA</option>
                                <option value="ESCOLA INDIGENA SANAWE">ESCOLA INDIGENA SANAWE</option>
                                <option value="ESCOLA INDIGENA TAINA">ESCOLA INDIGENA TAINA</option>
                                <option value="ESCOLA INDIGENA TEMANARE">ESCOLA INDIGENA TEMANARE</option>
                                <option value="ESCOLA INDIGENA TEWADURE">ESCOLA INDIGENA TEWADURE</option>
                                <option value="ESCOLA INDIGENA TXUIRI-HINA">ESCOLA INDIGENA TXUIRI-HINA</option>
                                <option value="ESCOLA INDIGENA WAHURI">ESCOLA INDIGENA WAHURI</option>
                                <option value="ESCOLA INDIGENA WATAKURI">ESCOLA INDIGENA WATAKURI</option>
                                <option value="INSTITUTO EDUCACIONAL PASSO A PASSO">INSTITUTO EDUCACIONAL PASSO A PASSO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="municipality">Munic√≠pio:</label>
                            <select id="municipality" name="municipality" required>
                                <option value="">Selecione o munic√≠pio</option>
                                <option value="Alian√ßa do Tocantins">Alian√ßa do Tocantins</option>
                                <option value="Alvorada">Alvorada</option>
                                <option value="Aragua√ßu">Aragua√ßu</option>
                                <option value="Cariri do Tocantins">Cariri do Tocantins</option>
                                <option value="Crix√°s do Tocantins">Crix√°s do Tocantins</option>
                                <option value="Duer√©">Duer√©</option>
                                <option value="Figueir√≥polis">Figueir√≥polis</option>
                                <option value="Formoso do Araguaia">Formoso do Araguaia</option>
                                <option value="Gurupi">Gurupi</option>
                                <option value="Ja√∫ do Tocantins">Ja√∫ do Tocantins</option>
                                <option value="Palmeir√≥polis">Palmeir√≥polis</option>
                                <option value="Peixe">Peixe</option>
                                <option value="Sandol√¢ndia">Sandol√¢ndia</option>
                                <option value="S√£o Salvador do Tocantins">S√£o Salvador do Tocantins</option>
                                <option value="S√£o Val√©rio">S√£o Val√©rio</option>
                                <option value="Sucupira">Sucupira</option>
                                <option value="Talism√£">Talism√£</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="technician">T√©cnico(a):</label>
                            <input type="text" id="technician" name="technician" required>
                        </div>
                        <div class="form-group">
                            <label for="date">Data do Registro:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                </div>

                <!-- Sistema de Turmas Din√¢micas -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Turmas e Estudantes</h3>
                        <button type="button" class="btn-secondary" onclick="addTurma()">‚ûï Adicionar Turma</button>
                    </div>
                    <div id="turmasContainer">
                        <!-- As turmas ser√£o adicionadas aqui dinamicamente -->
                    </div>
                </div>

                <!-- Observa√ß√µes Gerais -->
                <div class="form-section">
                    <h3>Observa√ß√µes Gerais:</h3>
                    <div class="form-group">
                        <textarea id="observations" name="observations" rows="4" placeholder="Digite suas observa√ß√µes gerais sobre a busca ativa..."></textarea>
                    </div>
                </div>

                <!-- Anexos -->
                <div class="form-section">
                    <h3>Anexos:</h3>
                    <p class="form-description">Fa√ßa upload de documentos relacionados (PDF, Word, Excel, imagens, etc.)</p>
                    <div class="form-group">
                        <input type="file" id="attachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt" style="margin-bottom: 10px;">
                        <div id="attachmentsList" class="attachments-list"></div>
                        <small style="color: #666; font-size: 12px;">Formatos aceitos: PDF, Word, Excel, imagens, texto. M√°ximo 5 arquivos.</small>
                    </div>
                </div>

                <!-- Bot√µes -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar Registro</button>
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Voltar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABEloTfC_nT5vfDHpeqYdDjNoPCKwE-Eo",
            authDomain: "projeto-alex-aaadf.firebaseapp.com",
            projectId: "projeto-alex-aaadf",
            storageBucket: "projeto-alex-aaadf.firebasestorage.app",
            messagingSenderId: "720032595137",
            appId: "1:720032595137:web:85834232e770a942216840"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ===== SISTEMA DE TURMAS DIN√ÇMICAS =====
        let turmas = [];
        let turmaCounter = 0;

        // Fun√ß√£o para adicionar uma nova turma
        function addTurma() {
            turmaCounter++;
            const turmaId = `turma_${turmaCounter}`;
            
            const turma = {
                id: turmaId,
                nome: '',
                turno: '',
                estudantes: []
            };
            
            turmas.push(turma);
            displayTurmas();
        }

        // Fun√ß√£o para remover uma turma
        function removeTurma(turmaId) {
            turmas = turmas.filter(t => t.id !== turmaId);
            displayTurmas();
        }

        // Fun√ß√£o para adicionar estudante a uma turma
        function addEstudante(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                const estudanteId = `estudante_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const estudante = {
                    id: estudanteId,
                    nome: '',
                    faltas: 0,
                    pcd: false,
                    ministerioPublico: false,
                    menorIdade: false,
                    atestadoMedico: false,
                    conselhoTutelar: false,
                    visit1: false,
                    visit2: false,
                    visit3: false,
                    observacoes: ''
                };
                
                turma.estudantes.push(estudante);
                displayTurmas();
            }
        }

        // Fun√ß√£o para remover estudante de uma turma
        function removeEstudante(turmaId, estudanteId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                turma.estudantes = turma.estudantes.filter(e => e.id !== estudanteId);
                displayTurmas();
            }
        }

        // Fun√ß√£o para atualizar dados da turma
        function updateTurmaData(turmaId, field, value) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                turma[field] = value;
            }
        }

        // Fun√ß√£o para atualizar dados do estudante
        function updateEstudanteData(turmaId, estudanteId, field, value) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                const estudante = turma.estudantes.find(e => e.id === estudanteId);
                if (estudante) {
                    if (field === 'faltas') {
                        estudante[field] = parseInt(value) || 0;
                    } else if (field === 'visit1' || field === 'visit2' || field === 'visit3') {
                        estudante[field] = value;
                        updateTotalVisitas(turmaId, estudanteId);
                    } else {
                        estudante[field] = value;
                    }
                }
            }
        }

        // Fun√ß√£o para calcular total de visitas de um estudante
        function updateTotalVisitas(turmaId, estudanteId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                const estudante = turma.estudantes.find(e => e.id === estudanteId);
                if (estudante) {
                    const total = (estudante.visit1 ? 1 : 0) + (estudante.visit2 ? 1 : 0) + (estudante.visit3 ? 1 : 0);
                    document.getElementById(`totalVisitas_${estudanteId}`).textContent = total;
                }
            }
        }

        // Fun√ß√£o para exibir todas as turmas
        function displayTurmas() {
            const container = document.getElementById('turmasContainer');
            
            if (turmas.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 20px;">Nenhuma turma adicionada. Clique em "Adicionar Turma" para come√ßar.</p>';
                return;
            }
            
            let html = '';
            
            turmas.forEach((turma, turmaIndex) => {
                html += `
                    <div class="turma-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #f9f9f9;">
                        <div class="turma-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #2c3e50;">üè´ Turma ${turmaIndex + 1}</h4>
                            <button type="button" class="btn-danger" onclick="removeTurma('${turma.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;">üóëÔ∏è Remover Turma</button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome da Turma:</label>
                                <input 
                                    type="text" 
                                    placeholder="Nome da turma" 
                                    value="${turma.nome}"
                                    onchange="updateTurmaData('${turma.id}', 'nome', this.value)"
                                    required
                                    style="width: 100%;"
                                >
                            </div>
                            <div class="form-group">
                                <label>Turno:</label>
                                <select 
                                    onchange="updateTurmaData('${turma.id}', 'turno', this.value)"
                                    required
                                    style="width: 100%;"
                                >
                                    <option value="">Selecione o turno</option>
                                    <option value="Matutino" ${turma.turno === 'Matutino' ? 'selected' : ''}>Matutino</option>
                                    <option value="Vespertino" ${turma.turno === 'Vespertino' ? 'selected' : ''}>Vespertino</option>
                                    <option value="Noturno" ${turma.turno === 'Noturno' ? 'selected' : ''}>Noturno</option>
                                    <option value="Integral" ${turma.turno === 'Integral' ? 'selected' : ''}>Integral</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="estudantes-section" style="margin-top: 15px;">
                            <div class="estudantes-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5 style="margin: 0; color: #34495e;">üë• Estudantes da Turma</h5>
                                <button type="button" class="btn-secondary" onclick="addEstudante('${turma.id}')" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px;">‚ûï Adicionar Estudante</button>
                            </div>
                            
                            <div class="estudantes-list">
                                ${turma.estudantes.length === 0 ? '<p style="color: #666; font-style: italic; text-align: center; padding: 10px;">Nenhum estudante adicionado. Clique em "Adicionar Estudante" para come√ßar.</p>' : ''}
                                
                                ${turma.estudantes.map((estudante, estudanteIndex) => `
                                    <div class="estudante-card" style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: white;">
                                        <div class="estudante-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h6 style="margin: 0; color: #495057;">üë§ Estudante ${estudanteIndex + 1}</h6>
                                            <button type="button" class="btn-danger" onclick="removeEstudante('${turma.id}', '${estudante.id}')" style="background: #dc3545; color: white; border: none; padding: 3px 6px; border-radius: 3px; font-size: 10px;">‚ùå</button>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Nome do(a) estudante:</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="Nome completo" 
                                                    value="${estudante.nome}"
                                                    onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'nome', this.value)"
                                                    required
                                                    style="width: 100%;"
                                                >
                                            </div>
                                            <div class="form-group">
                                                <label>N¬∫ de faltas:</label>
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    value="${estudante.faltas}"
                                                    onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'faltas', this.value)"
                                                    required
                                                    style="width: 100%;"
                                                >
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" ${estudante.pcd ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'pcd', this.checked)"> PCD</label>
                                                    <label><input type="checkbox" ${estudante.ministerioPublico ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'ministerioPublico', this.checked)"> Minist√©rio P√∫blico</label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" ${estudante.menorIdade ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'menorIdade', this.checked)"> Menor de Idade</label>
                                                    <label><input type="checkbox" ${estudante.atestadoMedico ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'atestadoMedico', this.checked)"> Atestado M√©dico</label>
                                                    <label><input type="checkbox" ${estudante.conselhoTutelar ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'conselhoTutelar', this.checked)"> Conselho Tutelar</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-section">
                                            <h6>N√∫mero de Visitas:</h6>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <div class="checkbox-group">
                                                        <label><input type="checkbox" id="visit1_${estudante.id}" ${estudante.visit1 ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'visit1', this.checked)"> 1¬™ visita</label>
                                                        <label><input type="checkbox" id="visit2_${estudante.id}" ${estudante.visit2 ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'visit2', this.checked)"> 2¬™ visita</label>
                                                        <label><input type="checkbox" id="visit3_${estudante.id}" ${estudante.visit3 ? 'checked' : ''} onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'visit3', this.checked)"> 3¬™ visita</label>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label>Total de visitas: <span id="totalVisitas_${estudante.id}">${(estudante.visit1 ? 1 : 0) + (estudante.visit2 ? 1 : 0) + (estudante.visit3 ? 1 : 0)}</span></label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Observa√ß√µes do estudante:</label>
                                            <textarea 
                                                placeholder="Digite suas observa√ß√µes sobre o estudante..."
                                                onchange="updateEstudanteData('${turma.id}', '${estudante.id}', 'observacoes', this.value)"
                                                rows="3"
                                                style="width: 100%;"
                                            >${estudante.observacoes}</textarea>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ===== SISTEMA DE ANEXOS M√öLTIPLOS =====
        let selectedFiles = [];

        // Event listener para sele√ß√£o de arquivos
        document.getElementById('attachments').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            
            // Adicionar novos arquivos aos existentes (evitando duplicatas)
            newFiles.forEach(newFile => {
                // Verificar se o arquivo j√° existe (por nome e tamanho)
                const isDuplicate = selectedFiles.some(existingFile => 
                    existingFile.name === newFile.name && existingFile.size === newFile.size
                );
                
                if (!isDuplicate) {
                    selectedFiles.push(newFile);
                }
            });
            
            // Verificar limite m√°ximo
            if (selectedFiles.length > 5) {
                alert('M√°ximo de 5 arquivos permitido! Removendo arquivos excedentes.');
                selectedFiles = selectedFiles.slice(0, 5);
            }
            
            displayAttachments();
            console.log(`üìÅ Total de anexos selecionados: ${selectedFiles.length}`);
        });

        function displayAttachments() {
            const attachmentsList = document.getElementById('attachmentsList');
            attachmentsList.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                attachmentsList.innerHTML = '<p style="color: #666; font-style: italic;">Nenhum arquivo selecionado</p>';
                return;
            }
            
            // Cabe√ßalho com contador e bot√£o limpar tudo
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px;';
            headerDiv.innerHTML = `
                <span style="font-weight: bold; color: #495057;">üìé Anexos selecionados (${selectedFiles.length}/5)</span>
                <button type="button" onclick="clearAllAttachments()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">üóëÔ∏è Limpar Todos</button>
            `;
            attachmentsList.appendChild(headerDiv);
            
            selectedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'attachment-item';
                const fileSizeKB = (file.size / 1024).toFixed(1);
                fileDiv.innerHTML = `
                    <span>üìé ${file.name} <small style="color: #666;">(${fileSizeKB} KB)</small></span>
                    <button type="button" onclick="removeFile(${index})" class="btn-remove">‚ùå</button>
                `;
                attachmentsList.appendChild(fileDiv);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayAttachments();
            console.log(`Arquivo removido. Total de anexos: ${selectedFiles.length}`);
        }

        function clearAllAttachments() {
            selectedFiles = [];
            displayAttachments();
            console.log('Todos os anexos foram removidos');
        }

        // Fun√ß√£o para fazer upload dos anexos
        async function uploadAttachments() {
            if (selectedFiles.length === 0) return [];
            
            console.log(`üöÄ Iniciando upload de ${selectedFiles.length} arquivo(s)...`);
            
            const uploadPromises = selectedFiles.map(async (file, index) => {
                try {
                    console.log(`üì§ Fazendo upload do arquivo ${index + 1}/${selectedFiles.length}: ${file.name}`);
                    
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const storageRef = ref(storage, `attachments/${fileName}`);
                    
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    console.log(`‚úÖ Upload conclu√≠do: ${file.name}`);
                    
                    return {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        downloadURL: downloadURL,
                        uploadedAt: new Date().toISOString()
                    };
                } catch (error) {
                    console.error(`‚ùå Erro no upload de ${file.name}:`, error);
                    throw error;
                }
            });
            
            const uploadedAttachments = await Promise.all(uploadPromises);
            console.log(`üéâ Todos os ${uploadedAttachments.length} anexos foram enviados com sucesso!`);
            console.log('üìã Resumo dos anexos:', uploadedAttachments.map(att => `${att.name} (${(att.size/1024).toFixed(1)} KB)`));
            
            return uploadedAttachments;
        }

        // Verificar autentica√ß√£o
        function checkAuth() {
            const userRole = localStorage.getItem('userRole');
            const userCPF = localStorage.getItem('userCPF');
            const userName = localStorage.getItem('userName');
            
            if (!userRole || !userCPF || !userName) {
                window.location.href = '../index.html';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('userCPF');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            window.location.href = '../index.html';
        }

        // Inicializar
        checkAuth();
        
        // Definir data atual como padr√£o
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // Form handler
        document.getElementById('activeSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validar se h√° pelo menos uma turma
            if (turmas.length === 0) {
                alert('Adicione pelo menos uma turma antes de salvar!');
                return;
            }
            
            // Validar se cada turma tem pelo menos um estudante
            for (let turma of turmas) {
                if (turma.estudantes.length === 0) {
                    alert(`A turma "${turma.nome || 'Sem nome'}" deve ter pelo menos um estudante!`);
                    return;
                }
                
                // Validar se todos os estudantes t√™m nome
                for (let estudante of turma.estudantes) {
                    if (!estudante.nome.trim()) {
                        alert('Todos os estudantes devem ter nome preenchido!');
                        return;
                    }
                }
            }
            
            try {
                const formData = {
                    department: 'Equipe Multiprofissional',
                    indicator: 'Busca Ativa',
                    school: document.getElementById('school').value,
                    municipality: document.getElementById('municipality').value,
                    technician: document.getElementById('technician').value,
                    date: document.getElementById('date').value,
                    turmas: turmas, // Nova estrutura com turmas e estudantes
                    observations: document.getElementById('observations').value,
                    attachments: await uploadAttachments(),
                    createdBy: localStorage.getItem('userCPF'),
                    createdByRole: localStorage.getItem('userRole'),
                    createdByName: localStorage.getItem('userName'),
                    createdAt: serverTimestamp(),
                    status: 'active'
                };

                await addDoc(collection(db, 'records'), formData);
                
                alert('Registro salvo com sucesso! Redirecionando para a p√°gina de registros...');
                
                // Redirecionar para a p√°gina de registros unificados ap√≥s salvar
                setTimeout(() => {
                    window.location.href = '../monitoring-records-unified.html';
                }, 1500);
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar o registro: ' + error.message);
            }
        });

        // Exportar fun√ß√µes para uso global
        window.logout = logout;
        window.removeFile = removeFile;
        window.clearAllAttachments = clearAllAttachments;
        window.addTurma = addTurma;
        window.removeTurma = removeTurma;
        window.addEstudante = addEstudante;
        window.removeEstudante = removeEstudante;
        window.updateTurmaData = updateTurmaData;
        window.updateEstudanteData = updateEstudanteData;
    </script>
</body>
</html>
