<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frequ√™ncia dos Estudantes - Curr√≠culo - SRE GURUPI</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="header">
        <h1>Frequ√™ncia dos Estudantes - Curr√≠culo</h1>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Formul√°rio de Frequ√™ncia dos Estudantes</h2>
            
            <form id="frequencyForm" class="form-container">
                <!-- Cabe√ßalho Padr√£o -->
                <div class="form-section">
                    <h3>Informa√ß√µes Gerais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school">Nome da Escola:</label>
                            <select id="school" name="school" required>
                                <option value="">Selecione a escola</option>
                                <option value="CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO">CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO</option>
                                <option value="CENTRO DE ENSINO MEDIO BOM JESUS">CENTRO DE ENSINO MEDIO BOM JESUS</option>
                                <option value="CENTRO DE ENSINO MEDIO DE GURUPI">CENTRO DE ENSINO MEDIO DE GURUPI</option>                                
                                <option value="COL DE TECELAGEM ART NSA SENHORA AUXILIADORA">COL DE TECELAGEM ART NSA SENHORA AUXILIADORA</option>
                                <option value="COL EST ALAIR SENA CONCEICAO">COL EST ALAIR SENA CONCEICAO</option>
                                <option value="COL√âGIO AGRICOLA DOM BOSCO">COL√âGIO AGRICOLA DOM BOSCO</option>
                                <option value="COL√âGIO ESTADUAL ADELAIDE FRANCISCO SOARES">COL√âGIO ESTADUAL ADELAIDE FRANCISCO SOARES</option>
                                <option value="COL√âGIO ESTADUAL ANITA CASSIMIRO MORENO">COL√âGIO ESTADUAL ANITA CASSIMIRO MORENO</option>
                                <option value="COL√âGIO ESTADUAL BENEDITO PEREIRA BANDEIRA">COL√âGIO ESTADUAL BENEDITO PEREIRA BANDEIRA</option>
                                <option value="COL√âGIO ESTADUAL CANDIDO FIGUEIRA">COL√âGIO ESTADUAL CANDIDO FIGUEIRA</option>
                                <option value="COL√âGIO ESTADUAL DE ALVORADA">COL√âGIO ESTADUAL DE ALVORADA</option>
                                <option value="COL√âGIO ESTADUAL DE TALISMA">COL√âGIO ESTADUAL DE TALISMA</option>
                                <option value="COL√âGIO ESTADUAL DOM ALANO">COL√âGIO ESTADUAL DOM ALANO</option>
                                <option value="COL√âGIO ESTADUAL ELSEBAO LIMA">COL√âGIO ESTADUAL ELSEBAO LIMA</option>
                                <option value="COL√âGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA">COL√âGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA</option>
                                <option value="COL√âGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS">COL√âGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS</option>
                                <option value="COL√âGIO ESTADUAL JOAO TAVARES MARTINS">COL√âGIO ESTADUAL JOAO TAVARES MARTINS</option>
                                <option value="COL√âGIO ESTADUAL NOSSA SENHORA APARECIDA">COL√âGIO ESTADUAL NOSSA SENHORA APARECIDA</option>
                                <option value="COL√âGIO ESTADUAL OLAVO BILAC">COL√âGIO ESTADUAL OLAVO BILAC</option>
                                <option value="COL√âGIO ESTADUAL PORTO DO RIO MARANHAO">COL√âGIO ESTADUAL PORTO DO RIO MARANHAO</option>
                                <option value="COL√âGIO ESTADUAL POSITIVO DE GURUPI">COL√âGIO ESTADUAL POSITIVO DE GURUPI</option>
                                <option value="COL√âGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA">COL√âGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA</option>
                                <option value="COL√âGIO ESTADUAL REGINA SIQUEIRA CAMPOS">COL√âGIO ESTADUAL REGINA SIQUEIRA CAMPOS</option>
                                <option value="COL√âGIO ESTADUAL TARSO DUTRA">COL√âGIO ESTADUAL TARSO DUTRA</option>
                                <option value="COL√âGIO ESTADUAL TIRADENTES">COL√âGIO ESTADUAL TIRADENTES</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR">COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA">COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA</option>
                                <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA">COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA</option>
                                <option value="ESC DE TEC ART NOSSA SRA AUXILIADORA">ESC DE TEC ART NOSSA SRA AUXILIADORA</option>
                                <option value="ESC EST RETIRO">ESC EST RETIRO</option>
                                <option value="ESC EST TANCREDO DE ALMEIDA NEVES">ESC EST TANCREDO DE ALMEIDA NEVES</option>
                                <option value="ESCOLA ESTADUAL ANA MARIA DE JESUS">ESCOLA ESTADUAL ANA MARIA DE JESUS</option>
                                <option value="ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA">ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA</option>
                                <option value="ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO">ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO</option>
                                <option value="ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA">ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA</option>
                                <option value="ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA">ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA</option>
                                <option value="ESCOLA ESTADUAL NOSSA SENHORA DO CARMO">ESCOLA ESTADUAL NOSSA SENHORA DO CARMO</option>
                                <option value="ESCOLA ESTADUAL OLAVO BILAC">ESCOLA ESTADUAL OLAVO BILAC</option>
                                <option value="ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA">ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA</option>
                                <option value="ESCOLA ESTADUAL PASSO A PASSO">ESCOLA ESTADUAL PASSO A PASSO</option>
                                <option value="ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA">ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA</option>
                                <option value="ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL">ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL</option>
                                <option value="ESCOLA ESTADUAL RUI BARBOSA">ESCOLA ESTADUAL RUI BARBOSA</option>
                                <option value="ESCOLA ESTADUAL SALVADOR CAETANO">ESCOLA ESTADUAL SALVADOR CAETANO</option>
                                <option value="ESCOLA ESTADUAL VALDIR LINS">ESCOLA ESTADUAL VALDIR LINS</option>
                                <option value="ESCOLA ESTADUAL VILA GUARACY">ESCOLA ESTADUAL VILA GUARACY</option>
                                <option value="ESCOLA INDIGENA BARRA DO RIO VERDE">ESCOLA INDIGENA BARRA DO RIO VERDE</option>
                                <option value="ESCOLA INDIGENA IJANARI">ESCOLA INDIGENA IJANARI</option>
                                <option value="ESCOLA INDIGENA IJAWALA">ESCOLA INDIGENA IJAWALA</option>
                                <option value="ESCOLA INDIGENA SANAWE">ESCOLA INDIGENA SANAWE</option>
                                <option value="ESCOLA INDIGENA TAINA">ESCOLA INDIGENA TAINA</option>
                                <option value="ESCOLA INDIGENA TEMANARE">ESCOLA INDIGENA TEMANARE</option>
                                <option value="ESCOLA INDIGENA TEWADURE">ESCOLA INDIGENA TEWADURE</option>
                                <option value="ESCOLA INDIGENA TXUIRI-HINA">ESCOLA INDIGENA TXUIRI-HINA</option>
                                <option value="ESCOLA INDIGENA WAHURI">ESCOLA INDIGENA WAHURI</option>
                                <option value="ESCOLA INDIGENA WATAKURI">ESCOLA INDIGENA WATAKURI</option>
                                <option value="INSTITUTO EDUCACIONAL PASSO A PASSO">INSTITUTO EDUCACIONAL PASSO A PASSO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="municipality">Munic√≠pio:</label>
                            <select id="municipality" name="municipality" required>
                                <option value="">Selecione o munic√≠pio</option>
                                <option value="Alian√ßa do Tocantins">Alian√ßa do Tocantins</option>
                                <option value="Alvorada">Alvorada</option>
                                <option value="Aragua√ßu">Aragua√ßu</option>
                                <option value="Cariri do Tocantins">Cariri do Tocantins</option>
                                <option value="Crix√°s do Tocantins">Crix√°s do Tocantins</option>
                                <option value="Duer√©">Duer√©</option>
                                <option value="Figueir√≥polis">Figueir√≥polis</option>
                                <option value="Formoso do Araguaia">Formoso do Araguaia</option>
                                <option value="Gurupi">Gurupi</option>
                                <option value="Ja√∫ do Tocantins">Ja√∫ do Tocantins</option>
                                <option value="Palmeir√≥polis">Palmeir√≥polis</option>
                                <option value="Peixe">Peixe</option>
                                <option value="Sandol√¢ndia">Sandol√¢ndia</option>
                                <option value="S√£o Salvador do Tocantins">S√£o Salvador do Tocantins</option>
                                <option value="S√£o Val√©rio">S√£o Val√©rio</option>
                                <option value="Sucupira">Sucupira</option>
                                <option value="Talism√£">Talism√£</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="technician">T√©cnico(a):</label>
                            <select id="technician" name="technician" required>
                                <option value="">Selecione o t√©cnico</option>
                                <option value="Alexandre Pereira Tolentino">Alexandre Pereira Tolentino</option>
                                <option value="Sayonara Santos de Morais">Sayonara Santos de Morais</option>
                                <option value="Alline Lemos Lira">Alline Lemos Lira</option>
                                <option value="Ala√≠de de Miranda Santiago">Ala√≠de de Miranda Santiago</option>
                                <option value="Noadia Gomes Martins">Noadia Gomes Martins</option>
                                <option value="Jorge Montan√© Vila">Jorge Montan√© Vila</option>
                                <option value="F√°bio Costa do Amaral">F√°bio Costa do Amaral</option>
                                <option value="Darlene de Carvalho Silva">Darlene de Carvalho Silva</option>
                                <option value="K√°rita Santos Lemos">K√°rita Santos Lemos</option>
                                <option value="Luso Soares Madureira">Luso Soares Madureira</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date">Data do Registro:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                </div>

                <!-- Sistema de Turmas Din√¢micas -->
                <div class="form-section">
                    <h3>Turmas da Escola</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="width: 100%;">
                            <label for="newTurma">Adicionar Nova Turma:</label>
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <input type="text" id="newTurma" placeholder="Ex: 1¬∫ ano A, 2¬∫ ano B" style="flex: 1;">
                                <button type="button" id="addTurmaBtn" class="btn btn-secondary" style="white-space: nowrap;">+ Adicionar Turma</button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Turmas Adicionadas -->
                    <div id="turmasContainer" class="form-section">
                        <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                            Nenhuma turma adicionada. Clique em "Adicionar Turma" para come√ßar.
                        </p>
                    </div>
                </div>

                <!-- Observa√ß√µes -->
                <div class="form-section">
                    <h3>Observa√ß√µes:</h3>
                    <div class="form-group">
                        <textarea id="observations" name="observations" rows="4" placeholder="Digite suas observa√ß√µes sobre o estudante..."></textarea>
                    </div>
                </div>

                <!-- Anexos -->
                <div class="form-section">
                    <h3>Anexos:</h3>
                    <p class="form-description">Fa√ßa upload de documentos relacionados (PDF, Word, Excel, imagens, etc.)</p>
                    <div class="form-group">
                        <input type="file" id="attachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt" style="margin-bottom: 10px;">
                        <div id="attachmentsList" class="attachments-list"></div>
                        <small style="color: #666; font-size: 12px;">Formatos aceitos: PDF, Word, Excel, imagens, texto. M√°ximo 5 arquivos.</small>
                    </div>
                </div>

                <!-- Mensagem de status -->
                <div id="statusMessage" class="status-message" style="display: none;"></div>

                <!-- Bot√µes -->
                <div class="form-actions">
                    <button type="submit" id="submitBtn" class="btn btn-primary">Salvar Registro</button>
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">Voltar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABEloTfC_nT5vfDHpeqYdDjNoPCKwE-Eo",
            authDomain: "projeto-alex-aaadf.firebaseapp.com",
            projectId: "projeto-alex-aaadf",
            storageBucket: "projeto-alex-aaadf.firebasestorage.app",
            messagingSenderId: "720032595137",
            appId: "1:720032595137:web:85834232e770a942216840"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Verificar autentica√ß√£o
        function checkAuth() {
            const userRole = localStorage.getItem('userRole');
            const userCPF = localStorage.getItem('userCPF');
            const userName = localStorage.getItem('userName');
            
            if (!userRole || !userCPF || !userName) {
                window.location.href = '../index.html';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('userCPF');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            window.location.href = '../index.html';
        }

        // Definir data atual
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
        }

        // Mostrar mensagem de status
        function showStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${isSuccess ? 'success' : 'error'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Gerenciar anexos m√∫ltiplos
        let selectedFiles = [];

        document.getElementById('attachments').addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            
            // Adicionar novos arquivos aos existentes (evitando duplicatas)
            newFiles.forEach(newFile => {
                // Verificar se o arquivo j√° existe (por nome e tamanho)
                const isDuplicate = selectedFiles.some(existingFile => 
                    existingFile.name === newFile.name && existingFile.size === newFile.size
                );
                
                if (!isDuplicate && selectedFiles.length < 5) {
                    selectedFiles.push(newFile);
                }
            });
            
            // Verificar limite m√°ximo
            if (selectedFiles.length > 5) {
                alert('M√°ximo de 5 arquivos permitido!');
                // Manter apenas os primeiros 5
                selectedFiles = selectedFiles.slice(0, 5);
            }
            
            displayAttachments();
            
            // Limpar o input para permitir sele√ß√£o do mesmo arquivo novamente
            e.target.value = '';
        });

        function displayAttachments() {
            const attachmentsList = document.getElementById('attachmentsList');
            attachmentsList.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                attachmentsList.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 10px;">Nenhum arquivo selecionado</p>';
                return;
            }
            
            // Adicionar cabe√ßalho com contador e bot√£o limpar tudo
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0; border-bottom: 1px solid #dee2e6;';
            headerDiv.innerHTML = `
                <span style="font-weight: 600; color: #333;">üìé Anexos (${selectedFiles.length}/5)</span>
                ${selectedFiles.length > 0 ? '<button type="button" onclick="clearAllAttachments()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px; cursor: pointer;">Limpar Todos</button>' : ''}
            `;
            attachmentsList.appendChild(headerDiv);
            
            selectedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'attachment-item';
                fileDiv.innerHTML = `
                    <span>üìé ${file.name} <small style="color: #666;">(${(file.size / 1024).toFixed(1)} KB)</small></span>
                    <button type="button" onclick="removeFile(${index})" class="btn-remove">‚ùå</button>
                `;
                attachmentsList.appendChild(fileDiv);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayAttachments();
            
            // N√£o precisamos mais atualizar o input.files pois agora
            // estamos gerenciando os arquivos separadamente
            console.log(`Arquivo removido. Total de anexos: ${selectedFiles.length}`);
        }

        function clearAllAttachments() {
            selectedFiles = [];
            displayAttachments();
            console.log('Todos os anexos foram removidos');
        }

        // Fun√ß√£o para debug dos anexos
        function debugAttachments() {
            console.log('üîç DEBUG DOS ANEXOS:');
            console.log('üìÅ selectedFiles:', selectedFiles);
            console.log('üìä Quantidade:', selectedFiles.length);
            console.log('üìã Detalhes:', selectedFiles.map((file, index) => ({
                index,
                name: file.name,
                size: file.size,
                type: file.type
            })));
        }

        // Fun√ß√£o para fazer upload dos anexos
        async function uploadAttachments() {
            console.log('üîÑ Iniciando upload de anexos...');
            console.log('üìÅ Arquivos selecionados:', selectedFiles.length);
            
            if (selectedFiles.length === 0) {
                console.log('‚ùå Nenhum arquivo para fazer upload');
                return [];
            }
            
            const uploadPromises = selectedFiles.map(async (file, index) => {
                try {
                    console.log(`üì§ Fazendo upload do arquivo ${index + 1}/${selectedFiles.length}: ${file.name}`);
                    
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const storageRef = ref(storage, `attachments/${fileName}`);
                    
                    console.log(`üìÅ Refer√™ncia do storage criada: ${fileName}`);
                    
                    const snapshot = await uploadBytes(storageRef, file);
                    console.log(`‚úÖ Upload conclu√≠do para: ${file.name}`);
                    
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    console.log(`üîó Download URL obtida para: ${file.name}`);
                    
                    const attachmentData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        downloadURL: downloadURL,
                        uploadedAt: new Date().toISOString()
                    };
                    
                    console.log(`üìã Dados do anexo preparados:`, attachmentData);
                    return attachmentData;
                    
                } catch (error) {
                    console.error(`‚ùå Erro ao fazer upload de ${file.name}:`, error);
                    throw new Error(`Falha no upload de ${file.name}: ${error.message}`);
                }
            });
            
            try {
                const results = await Promise.all(uploadPromises);
                console.log(`üéâ Upload de todos os anexos conclu√≠do! Total: ${results.length}`);
                console.log('üìã Resultados finais:', results);
                return results;
            } catch (error) {
                console.error('‚ùå Erro geral no upload dos anexos:', error);
                throw error;
            }
        }

        // Validar formul√°rio
        function validateForm() {
            const requiredFields = ['school', 'municipality', 'technician', 'date'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showStatus(`Por favor, preencha o campo: ${field.previousElementSibling.textContent.replace(':', '')}`, false);
                    field.focus();
                    return false;
                }
            }
            
            // Verificar se pelo menos uma turma foi adicionada
            if (turmas.length === 0) {
                showStatus('Por favor, adicione pelo menos uma turma', false);
                return false;
            }
            
            // Validar cada turma
            for (const turma of turmas) {
                if (turma.totalEstudantes <= 0) {
                    showStatus(`Por favor, informe o total de estudantes da turma "${turma.nome}"`, false);
                    return false;
                }
                if (turma.estudantesFrequenciaBaixa < 0) {
                    showStatus(`Por favor, informe o n√∫mero de estudantes com frequ√™ncia baixa da turma "${turma.nome}"`, false);
                    return false;
                }
                if (!turma.etapa) {
                    showStatus(`Por favor, selecione a etapa da turma "${turma.nome}"`, false);
                    return false;
                }
                if (turma.bimestres.length === 0) {
                    showStatus(`Por favor, selecione pelo menos um bimestre para a turma "${turma.nome}"`, false);
                    return false;
                }
            }
            
            return true;
        }



        // Inicializar
        checkAuth();
        setCurrentDate();
        
        // Debug: verificar se o formul√°rio existe
        console.log('Formul√°rio encontrado:', document.getElementById('frequencyForm'));
        console.log('Bot√£o de submit encontrado:', document.getElementById('submitBtn'));
        
        // Form handler
        document.getElementById('frequencyForm').addEventListener('submit', async (e) => {
            console.log('Evento de submit capturado!');
            e.preventDefault();
            
            // Validar formul√°rio
            if (!validateForm()) {
                console.log('Valida√ß√£o falhou');
                return;
            }
            
            console.log('Valida√ß√£o passou, iniciando salvamento...');
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                // Desabilitar bot√£o e mostrar loading
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvando...';
                showStatus('Salvando registro...', true);
                
                console.log('Iniciando salvamento...');
                
                // Fazer upload dos anexos primeiro
                let attachments = [];
                try {
                    attachments = await uploadAttachments();
                    console.log('Anexos enviados:', attachments);
                } catch (uploadError) {
                    console.error('Erro no upload dos anexos:', uploadError);
                    showStatus('Erro no upload dos anexos: ' + uploadError.message, false);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                const formData = {
                    department: 'Curr√≠culo',
                    indicator: 'Frequ√™ncia dos Estudantes',
                    school: document.getElementById('school').value,
                    municipality: document.getElementById('municipality').value,
                    technician: document.getElementById('technician').value,
                    date: document.getElementById('date').value,
                    studentName: document.getElementById('studentName').value,
                    etapa: document.getElementById('etapa').value,
                    turmaId: document.getElementById('turmaId').value,
                    totalAbsences: parseInt(document.getElementById('totalAbsences').value),
                    consecutiveAbsences: parseInt(document.getElementById('totalAbsences').value), // Mant√©m compatibilidade
                    bimester1: document.getElementById('bimester1').checked,
                    bimester2: document.getElementById('bimester2').checked,
                    bimester3: document.getElementById('bimester3').checked,
                    bimester4: document.getElementById('bimester4').checked,
                    selectedBimesters: getSelectedBimesters(),
                    status: document.getElementById('status').value,
                    observations: document.getElementById('observations').value,
                    attachments: attachments, // ‚úÖ Anexos em vez de documentLinks
                    createdBy: localStorage.getItem('userCPF') || 'Usu√°rio n√£o identificado',
                    createdByRole: localStorage.getItem('userRole') || 'N/A',
                    createdByName: localStorage.getItem('userName') || 'N/A',
                    createdAt: serverTimestamp(),
                    recordStatus: 'active'
                };

                console.log('Dados do formul√°rio:', formData);

                // Tentar salvar no Firebase
                try {
                    const docRef = await addDoc(collection(db, 'records'), formData);
                    console.log('Documento salvo com ID:', docRef.id);
                    showStatus('Registro salvo com sucesso no Firebase!', true);
                    
                    // Limpar formul√°rio
                    document.getElementById('frequencyForm').reset();
                    setCurrentDate();
                    
                } catch (firebaseError) {
                    console.error('Erro no Firebase:', firebaseError);
                    
                    // Fallback: salvar no localStorage
                    const records = JSON.parse(localStorage.getItem('frequencyRecords') || '[]');
                    const recordWithId = {
                        ...formData,
                        id: Date.now().toString(),
                        createdAt: new Date().toISOString(),
                        savedLocally: true
                    };
                    records.push(recordWithId);
                    localStorage.setItem('frequencyRecords', JSON.stringify(records));
                    
                    showStatus('Registro salvo localmente (Firebase indispon√≠vel). ID: ' + recordWithId.id, true);
                    
                    // Limpar formul√°rio
                    document.getElementById('frequencyForm').reset();
                    setCurrentDate();
                }
                
            } catch (error) {
                console.error('Erro geral ao salvar:', error);
                showStatus('Erro ao salvar o registro: ' + error.message, false);
            } finally {
                // Reabilitar bot√£o
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // Debug: verificar se o evento foi adicionado
        console.log('Event listener adicionado ao formul√°rio');
        
        // Backup: evento de clique direto no bot√£o
        document.getElementById('submitBtn').addEventListener('click', async (e) => {
            console.log('Clique direto no bot√£o capturado!');
            
            // Validar formul√°rio
            if (!validateForm()) {
                console.log('Valida√ß√£o falhou');
                return;
            }
            
            console.log('Valida√ß√£o passou, iniciando salvamento...');
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                // Desabilitar bot√£o e mostrar loading
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvando...';
                showStatus('Salvando registro...', true);
                
                console.log('Iniciando salvamento...');
                
                // Fazer upload dos anexos primeiro
                let attachments = [];
                try {
                    attachments = await uploadAttachments();
                    console.log('Anexos enviados:', attachments);
                } catch (uploadError) {
                    console.error('Erro no upload dos anexos:', uploadError);
                    showStatus('Erro no upload dos anexos: ' + uploadError.message, false);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                const formData = {
                    department: 'Curr√≠culo',
                    indicator: 'Frequ√™ncia dos Estudantes',
                    school: document.getElementById('school').value,
                    municipality: document.getElementById('municipality').value,
                    technician: document.getElementById('technician').value,
                    date: document.getElementById('date').value,
                    turmas: turmas, // ‚úÖ NOVO: Array com todas as turmas e seus dados
                    observations: document.getElementById('observations').value,
                    attachments: attachments, // ‚úÖ Anexos em vez de documentLinks
                    createdBy: localStorage.getItem('userCPF') || 'Usu√°rio n√£o identificado',
                    createdByRole: localStorage.getItem('userRole') || 'N/A',
                    createdByName: localStorage.getItem('userName') || 'N/A',
                    createdAt: serverTimestamp(),
                    recordStatus: 'active'
                };

                console.log('Dados do formul√°rio:', formData);

                // Tentar salvar no Firebase
                try {
                    const docRef = await addDoc(collection(db, 'records'), formData);
                    console.log('Documento salvo com ID:', docRef.id);
                    showStatus('Registro salvo com sucesso no Firebase!', true);
                    
                    // Limpar formul√°rio
                    document.getElementById('frequencyForm').reset();
                    setCurrentDate();
                    
                } catch (firebaseError) {
                    console.error('Erro no Firebase:', firebaseError);
                    
                    // Fallback: salvar no localStorage
                    const records = JSON.parse(localStorage.getItem('frequencyRecords') || '[]');
                    const recordWithId = {
                        ...formData,
                        id: Date.now().toString(),
                        createdAt: new Date().toISOString(),
                        savedLocally: true
                    };
                    records.push(recordWithId);
                    localStorage.setItem('frequencyRecords', JSON.stringify(records));
                    
                    showStatus('Registro salvo localmente (Firebase indispon√≠vel). ID: ' + recordWithId.id, true);
                    
                    // Limpar formul√°rio
                    document.getElementById('frequencyForm').reset();
                    setCurrentDate();
                }
                
            } catch (error) {
                console.error('Erro geral ao salvar:', error);
                showStatus('Erro ao salvar o registro: ' + error.message, false);
            } finally {
                // Reabilitar bot√£o
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        console.log('Event listener de clique adicionado ao bot√£o');

        // ===== SISTEMA DE TURMAS DIN√ÇMICAS =====
        let turmas = [];
        let turmaCounter = 0;

        // Fun√ß√£o para adicionar nova turma
        function addTurma() {
            const turmaInput = document.getElementById('newTurma');
            const turmaNome = turmaInput.value.trim();
            
            if (!turmaNome) {
                alert('Por favor, digite o nome da turma');
                turmaInput.focus();
                return;
            }
            
            // Verificar se a turma j√° existe
            if (turmas.some(t => t.nome === turmaNome)) {
                alert('Esta turma j√° foi adicionada');
                turmaInput.focus();
                return;
            }
            
            turmaCounter++;
            const turmaId = `turma_${turmaCounter}`;
            
            const novaTurma = {
                id: turmaId,
                nome: turmaNome,
                totalEstudantes: 0,
                estudantesFrequenciaBaixa: 0,
                etapa: '',
                bimestres: []
            };
            
            turmas.push(novaTurma);
            turmaInput.value = '';
            displayTurmas();
            updateTurmaCounter();
            
            alert(`Turma "${turmaNome}" adicionada com sucesso!`);
        }

        // Fun√ß√£o para remover turma
        function removeTurma(turmaId) {
            const turmaIndex = turmas.findIndex(t => t.id === turmaId);
            if (turmaIndex !== -1) {
                const turmaNome = turmas[turmaIndex].nome;
                turmas.splice(turmaIndex, 1);
                displayTurmas();
                updateTurmaCounter();
                alert(`Turma "${turmaNome}" removida`);
            }
        }

        // Fun√ß√£o para atualizar dados da turma
        function updateTurmaData(turmaId, field, value) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                turma[field] = value;
            }
        }

        // Fun√ß√£o para atualizar bimestres da turma
        function updateTurmaBimestres(turmaId, bimestre, isChecked) {
            const turma = turmas.find(t => t.id === turmaId);
            if (turma) {
                if (isChecked) {
                    if (!turma.bimestres.includes(bimestre)) {
                        turma.bimestres.push(bimestre);
                    }
                } else {
                    turma.bimestres = turma.bimestres.filter(b => b !== bimestre);
                }
            }
        }

        // Fun√ß√£o para exibir turmas
        function displayTurmas() {
            const container = document.getElementById('turmasContainer');
            
            if (turmas.length === 0) {
                container.innerHTML = `
                    <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                        Nenhuma turma adicionada. Clique em "Adicionar Turma" para come√ßar.
                    </p>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            turmas.forEach(turma => {
                const turmaDiv = document.createElement('div');
                turmaDiv.className = 'form-section';
                turmaDiv.style.cssText = 'background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 15px;';
                turmaDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                        <span style="font-weight: bold; color: #495057; font-size: 16px;">${turma.nome}</span>
                        <button type="button" onclick="removeTurma('${turma.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ‚ùå Remover
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label>Total de Estudantes:</label>
                            <input 
                                type="number" 
                                min="0" 
                                placeholder="Digite o n√∫mero" 
                                value="${turma.totalEstudantes || 0}"
                                onchange="updateTurmaData('${turma.id}', 'totalEstudantes', parseInt(this.value) || 0)"
                                required
                                style="width: 100%;"
                            >
                        </div>
                        <div>
                            <label>Estudantes com Frequ√™ncia Baixa:</label>
                            <input 
                                type="number" 
                                min="0" 
                                placeholder="Digite o n√∫mero" 
                                value="${turma.estudantesFrequenciaBaixa || 0}"
                                onchange="updateTurmaData('${turma.id}', 'estudantesFrequenciaBaixa', parseInt(this.value) || 0)"
                                required
                                style="width: 100%;"
                            >
                        </div>
                        <div>
                            <label>Etapa:</label>
                                                         <select 
                                 onchange="updateTurmaData('${turma.id}', 'etapa', this.value)"
                                 required
                                 style="width: 100%;"
                             >
                                 <option value="">Selecione</option>
                                 <option value="Ensino Fundamental" ${turma.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                 <option value="Ensino M√©dio" ${turma.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                 <option value="Ensino Fundamental e Ensino M√©dio" ${turma.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                 <option value="EJA" ${turma.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                 <option value="Ensino Fundamental e EJA" ${turma.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                 <option value="Ensino M√©dio e EJA" ${turma.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                             </select>
                        </div>
                        <div>
                            <label>Bimestres:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input 
                                        type="checkbox" 
                                        value="1¬∫ Bimestre"
                                        ${turma.bimestres.includes('1¬∫ Bimestre') ? 'checked' : ''}
                                        onchange="updateTurmaBimestres('${turma.id}', '1¬∫ Bimestre', this.checked)"
                                    > 1¬∫ Bimestre
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input 
                                        type="checkbox" 
                                        value="2¬∫ Bimestre"
                                        ${turma.bimestres.includes('2¬∫ Bimestre') ? 'checked' : ''}
                                        onchange="updateTurmaBimestres('${turma.id}', '2¬∫ Bimestre', this.checked)"
                                    > 2¬∫ Bimestre
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input 
                                        type="checkbox" 
                                        value="3¬∫ Bimestre"
                                        ${turma.bimestres.includes('3¬∫ Bimestre') ? 'checked' : ''}
                                        onchange="updateTurmaBimestres('${turma.id}', '3¬∫ Bimestre', this.checked)"
                                    > 3¬∫ Bimestre
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input 
                                        type="checkbox" 
                                        value="4¬∫ Bimestre"
                                        ${turma.bimestres.includes('4¬∫ Bimestre') ? 'checked' : ''}
                                        onchange="updateTurmaBimestres('${turma.id}', '4¬∫ Bimestre', this.checked)"
                                    > 4¬∫ Bimestre
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(turmaDiv);
            });
        }

        // Fun√ß√£o para atualizar contador de turmas
        function updateTurmaCounter() {
            const addBtn = document.getElementById('addTurmaBtn');
            if (turmas.length > 0) {
                addBtn.innerHTML = `+ Adicionar Turma <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">${turmas.length}</span>`;
            } else {
                addBtn.innerHTML = '+ Adicionar Turma';
            }
        }

        // Event listener para o bot√£o de adicionar turma
        document.addEventListener('DOMContentLoaded', function() {
            const addTurmaBtn = document.getElementById('addTurmaBtn');
            if (addTurmaBtn) {
                addTurmaBtn.addEventListener('click', addTurma);
            }
        });

        // Exportar fun√ß√µes para uso global
        window.logout = logout;
        window.removeFile = removeFile;
        window.clearAllAttachments = clearAllAttachments;
        window.debugAttachments = debugAttachments;
        window.addTurma = addTurma;
        window.removeTurma = removeTurma;
        window.updateTurmaData = updateTurmaData;
        window.updateTurmaBimestres = updateTurmaBimestres;
    </script>
    
    <!-- Script para pesquisa de escola -->
    <!-- <script src="../js/school-search.js"></script> -->
</body>
</html>
