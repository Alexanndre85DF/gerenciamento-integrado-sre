<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros Unificados - SRE GURUPI</title>
    <link rel="stylesheet" href="styles.css">
    
    <style>
        /* Estilos personalizados para os filtros */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .filter-group select:hover,
        .filter-group input:hover {
            border-color: #007bff;
        }
        
        /* Responsividade para dispositivos m√≥veis */
        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Melhorar o visual da se√ß√£o de filtros */
        .filters-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        /* Estilos para bot√µes de a√ß√£o */
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #212529;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #f57c00 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        /* Estilos para formul√°rio de edi√ß√£o */
        .edit-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #007bff;
        }
        
        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .edit-form input:focus,
        .edit-form select:focus,
        .edit-form textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .edit-form label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        
        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Registros Unificados</h1>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="main-container">
        <div class="card">
            <div style="position: relative;">
                <a href="user-dashboard.html" class="btn btn-secondary" style="position: absolute; top: 0; right: 0; font-size: 12px; padding: 6px 12px; margin: 0; background-color: #28a745; border-color: #28a745;">Voltar ao Menu</a>
                <h2 style="margin-top: 60px;">Sistema de Registros Unificados</h2>
            </div>
            <p>Visualize e pesquise todos os registros do sistema com filtros avan√ßados</p>
            
            <!-- Bot√µes de A√ß√£o R√°pida -->
            <div class="quick-actions" style="margin: 20px 0; text-align: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 10px; border: 1px solid #e1bee7;">
                <button onclick="clearAllFilters()" class="btn btn-secondary" style="margin-right: 10px;">üóëÔ∏è Limpar Todos os Filtros</button>
                <button onclick="refreshRecords()" class="btn btn-primary">üîÑ Atualizar Registros</button>
            </div>
            
            <!-- Filtros Avan√ßados -->
            <div class="filters-section">
                <h3>Filtros de Pesquisa</h3>
                
                <div class="filters-grid">
                    <!-- Escola -->
                    <div class="filter-group">
                        <label for="schoolFilter">Escola:</label>
                        <select id="schoolFilter" onchange="filterRecords()">
                            <option value="">Todas as escolas</option>
                            <option value="CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO">CENTRO DE ENSINO MEDIO ARY RIBEIRO VALADAO FILHO</option>
                            <option value="CENTRO DE ENSINO MEDIO BOM JESUS">CENTRO DE ENSINO MEDIO BOM JESUS</option>                            
                            <option value="CENTRO DE ENSINO M√âDIO DE GURUPI">CENTRO DE ENSINO M√âDIO DE GURUPI</option>
                            <option value="COL DE TECELAGEM ART NSA SENHORA AUXILIADORA">COL DE TECELAGEM ART NSA SENHORA AUXILIADORA</option>
                            <option value="COL EST ALAIR SENA CONCEICAO">COL EST ALAIR SENA CONCEICAO</option>
                            <option value="COLEGIO AGRICOLA DOM BOSCO">COL√âGIO AGRICOLA DOM BOSCO</option>
                            <option value="COL√âGIO ESTADUAL ADELAIDE FRANCISCO SOARES">COL√âGIO ESTADUAL ADELAIDE FRANCISCO SOARES</option>
                            <option value="COL√âGIO ESTADUAL ANITA CASSIMIRO MORENO">COL√âGIO ESTADUAL ANITA CASSIMIRO MORENO</option>
                            <option value="COL√âGIO ESTADUAL BENEDITO PEREIRA BANDEIRA">COL√âGIO ESTADUAL BENEDITO PEREIRA BANDEIRA</option>
                            <option value="COL√âGIO ESTADUAL CANDIDO FIGUEIRA">COL√âGIO ESTADUAL CANDIDO FIGUEIRA</option>
                            <option value="COL√âGIO ESTADUAL DE ALVORADA">COL√âGIO ESTADUAL DE ALVORADA</option>
                            <option value="COL√âGIO ESTADUAL DE TALISMA">COL√âGIO ESTADUAL DE TALISMA</option>
                            <option value="COL√âGIO ESTADUAL DOM ALANO">COL√âGIO ESTADUAL DOM ALANO</option>
                            <option value="COL√âGIO ESTADUAL ELSEBAO LIMA">COL√âGIO ESTADUAL ELSEBAO LIMA</option>
                            <option value="COL√âGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA">COL√âGIO ESTADUAL FAMILIA AGRICOLA JOSE PORFIRIO DE SOUZA</option>
                            <option value="COL√âGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS">COL√âGIO ESTADUAL GIRASSOL DE TEMPO INTEGRAL JOSE SEABRA LEMOS</option>
                            <option value="COL√âGIO ESTADUAL JOAO TAVARES MARTINS">COL√âGIO ESTADUAL JOAO TAVARES MARTINS</option>
                            <option value="COL√âGIO ESTADUAL NOSSA SENHORA APARECIDA">COL√âGIO ESTADUAL NOSSA SENHORA APARECIDA</option>
                            <option value="COL√âGIO ESTADUAL OLAVO BILAC">COL√âGIO ESTADUAL OLAVO BILAC</option>
                            <option value="COL√âGIO ESTADUAL PORTO DO RIO MARANHAO">COL√âGIO ESTADUAL PORTO DO RIO MARANHAO</option>
                            <option value="COL√âGIO ESTADUAL POSITIVO DE GURUPI">COL√âGIO ESTADUAL POSITIVO DE GURUPI</option>
                            <option value="COL√âGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA">COL√âGIO ESTADUAL PROFESSORA ONEIDES ROSA DE MOURA</option>
                            <option value="COL√âGIO ESTADUAL REGINA SIQUEIRA CAMPOS">COL√âGIO ESTADUAL REGINA SIQUEIRA CAMPOS</option>
                            <option value="COL√âGIO ESTADUAL TARSO DUTRA">COL√âGIO ESTADUAL TARSO DUTRA</option>
                            <option value="COL√âGIO ESTADUAL TIRADENTES">COL√âGIO ESTADUAL TIRADENTES</option>
                            <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR">COLEGIO MILITAR DO ESTADO DO TOCANTINS - ADJULIO BALTHAZAR</option>
                            <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA">COLEGIO MILITAR DO ESTADO DO TOCANTINS - PROFESSORA MARIA</option>
                            <option value="COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA">COLEGIO MILITAR DO ESTADO DO TOCANTINS PRESIDENTE COSTA E SILVA</option>
                            <option value="ESC DE TEC ART NOSSA SRA AUXILIADORA">ESC DE TEC ART NOSSA SRA AUXILIADORA</option>
                            <option value="ESC EST RETIRO">ESC EST RETIRO</option>
                            <option value="ESC EST TANCREDO DE ALMEIDA NEVES">ESC EST TANCREDO DE ALMEIDA NEVES</option>
                            <option value="ESCOLA ESTADUAL ANA MARIA DE JESUS">ESCOLA ESTADUAL ANA MARIA DE JESUS</option>
                            <option value="ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA">ESCOLA ESTADUAL DR JOAQUIM PEREIRA DA COSTA</option>
                            <option value="ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO">ESCOLA ESTADUAL FE E ALEGRIA PAROQUIAL BERNARDO SAYAO</option>
                            <option value="ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA">ESCOLA ESTADUAL GERCINA BORGES TEIXEIRA</option>
                            <option value="ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA">ESCOLA ESTADUAL HERCILIA CARVALHO DA SILVA</option>
                            <option value="ESCOLA ESTADUAL NOSSA SENHORA DO CARMO">ESCOLA ESTADUAL NOSSA SENHORA DO CARMO</option>
                            <option value="ESCOLA ESTADUAL OLAVO BILAC">ESCOLA ESTADUAL OLAVO BILAC</option>
                            <option value="ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA">ESCOLA ESTADUAL PADRE JOSE DE ANCHIETA</option>
                            <option value="ESCOLA ESTADUAL PASSO A PASSO">ESCOLA ESTADUAL PASSO A PASSO</option>
                            <option value="ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA">ESCOLA ESTADUAL PRESBITERIANA ARAGUAIA</option>
                            <option value="ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL">ESCOLA ESTADUAL PRESBITERIANA EDUCACIONAL</option>
                            <option value="ESCOLA ESTADUAL RUI BARBOSA">ESCOLA ESTADUAL RUI BARBOSA</option>
                            <option value="ESCOLA ESTADUAL SALVADOR CAETANO">ESCOLA ESTADUAL SALVADOR CAETANO</option>
                            <option value="ESCOLA ESTADUAL VALDIR LINS">ESCOLA ESTADUAL VALDIR LINS</option>
                            <option value="ESCOLA ESTADUAL VILA GUARACY">ESCOLA ESTADUAL VILA GUARACY</option>
                            <option value="ESCOLA INDIGENA BARRA DO RIO VERDE">ESCOLA INDIGENA BARRA DO RIO VERDE</option>
                            <option value="ESCOLA INDIGENA IJANARI">ESCOLA INDIGENA IJANARI</option>
                            <option value="ESCOLA INDIGENA IJAWALA">ESCOLA INDIGENA IJAWALA</option>
                            <option value="ESCOLA INDIGENA SANAWE">ESCOLA INDIGENA SANAWE</option>
                            <option value="ESCOLA INDIGENA TAINA">ESCOLA INDIGENA TAINA</option>
                            <option value="ESCOLA INDIGENA TEMANARE">ESCOLA INDIGENA TEMANARE</option>
                            <option value="ESCOLA INDIGENA TEWADURE">ESCOLA INDIGENA TEWADURE</option>
                            <option value="ESCOLA INDIGENA TXUIRI-HINA">ESCOLA INDIGENA TXUIRI-HINA</option>
                            <option value="ESCOLA INDIGENA WAHURI">ESCOLA INDIGENA WAHURI</option>
                            <option value="ESCOLA INDIGENA WATAKURI">ESCOLA INDIGENA WATAKURI</option>
                            <option value="INSTITUTO EDUCACIONAL PASSO A PASSO">INSTITUTO EDUCACIONAL PASSO A PASSO</option>
                        </select>
                    </div>

                    <!-- Munic√≠pio -->
                    <div class="filter-group">
                        <label for="municipalityFilter">Munic√≠pio:</label>
                                                 <select id="municipalityFilter" onchange="filterRecords()">
                             <option value="">Todos os munic√≠pios</option>
                              <option value="Alian√ßa do Tocantins">Alian√ßa do Tocantins</option>
                              <option value="Alvorada">Alvorada</option>
                              <option value="Aragua√ßu">Aragua√ßu</option>
                              <option value="Cariri do Tocantins">Cariri do Tocantins</option>
                              <option value="Crix√°s do Tocantins">Crix√°s do Tocantins</option>
                              <option value="Duer√©">Duer√©</option>
                              <option value="Figueir√≥polis">Figueir√≥polis</option>
                              <option value="Formoso do Araguaia">Formoso do Araguaia</option>
                              <option value="Gurupi">Gurupi</option>
                              <option value="Ja√∫ do Tocantins">Ja√∫ do Tocantins</option>
                              <option value="Palmeir√≥polis">Palmeir√≥polis</option>
                              <option value="Peixe">Peixe</option>
                              <option value="Sandol√¢ndia">Sandol√¢ndia</option>
                              <option value="S√£o Salvador do Tocantins">S√£o Salvador do Tocantins</option>
                              <option value="S√£o Val√©rio">S√£o Val√©rio</option>
                              <option value="Sucupira">Sucupira</option>
                              <option value="Talism√£">Talism√£</option>
                         </select>
                    </div>

                    <!-- Departamento -->
                    <div class="filter-group">
                        <label for="departmentFilter">Departamento:</label>
                        <select id="departmentFilter" onchange="filterRecords()">
                            <option value="">Todos os departamentos</option>
                            <option value="Curr√≠culo">Curr√≠culo</option>
                            <option value="Equipe Multiprofissional">Equipe Multiprofissional</option>
                            <option value="Supervis√£o">Supervis√£o</option>
                        </select>
                    </div>

                    <!-- Indicador -->
                    <div class="filter-group">
                        <label for="indicatorFilter">Indicador:</label>
                        <select id="indicatorFilter" onchange="filterRecords()">
                            <option value="">Todos os indicadores</option>
                            <option value="Frequ√™ncia dos Estudantes">Frequ√™ncia dos Estudantes</option>
                            <option value="Busca Ativa">Busca Ativa</option>
                            <option value="Aulas Previstas e Aulas Dadas">Aulas Previstas e Aulas Dadas</option>
                            <option value="Estudantes Abaixo da M√©dia">Estudantes Abaixo da M√©dia</option>
                        </select>
                    </div>

                    <!-- Data Inicial -->
                    <div class="filter-group">
                        <label for="dateStartFilter">Data Inicial:</label>
                        <input type="date" id="dateStartFilter" onchange="filterRecords()">
                    </div>

                    <!-- Data Final -->
                    <div class="filter-group">
                        <label for="dateEndFilter">Data Final:</label>
                        <input type="date" id="dateEndFilter" onchange="filterRecords()">
                    </div>

                    <!-- T√©cnico -->
                    <div class="filter-group">
                        <label for="technicianFilter">T√©cnico:</label>
                        <input type="text" id="technicianFilter" placeholder="Nome do t√©cnico" onkeyup="filterRecords()">
                    </div>

                    <!-- Nome do Estudante -->
                    <div class="filter-group">
                        <label for="studentFilter">Estudante:</label>
                        <input type="text" id="studentFilter" placeholder="Nome do estudante" onkeyup="filterRecords()">
                    </div>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="action-buttons" style="margin: 30px 0; text-align: center; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                <button onclick="downloadExcel()" class="btn btn-primary"> Exportar Excel</button>
                <button onclick="downloadPDF()" class="btn btn-primary"> Exportar PDF</button>
                <a href="monitoring-resolved.html" class="btn btn-success"> Ver Registros Resolvidos</a>
            </div>

            <!-- Estat√≠sticas -->
            <div class="stats-section">
                <div class="stat-card">
                    <h3>Total de Registros</h3>
                    <span id="totalRecords">0</span>
                </div>
                <div class="stat-card">
                    <h3>Registros Filtrados</h3>
                    <span id="filteredRecords">0</span>
                </div>
                <div class="stat-card">
                    <h3>√öltima Atualiza√ß√£o</h3>
                    <span id="lastUpdate">-</span>
                </div>
            </div>

            <!-- Lista de Registros -->
            <div class="records-section">
                <h3>Registros Encontrados</h3>
                <div id="recordsList" class="records-container">
                    <div class="loading">Carregando registros...</div>
                </div>
            </div>


        </div>
    </div>

    <!-- Modal para Visualizar Registro -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Visualizar Registro</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conte√∫do do registro ser√° inserido aqui -->
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Fun√ß√µes globais para edi√ß√£o -->
    <script>
        // Fun√ß√£o de teste para verificar se o bot√£o est√° funcionando
        function testEditButton(recordId) {
            console.log('Teste do bot√£o alterar - ID:', recordId);
            alert('Bot√£o alterar clicado! ID: ' + recordId);
        }

        // Fun√ß√£o para editar registro diretamente da lista (vers√£o global)
        async function editRecordDirect(recordId) {
            console.log('editRecordDirect chamada com ID:', recordId);
            
            // Verificar se as fun√ß√µes do m√≥dulo est√£o dispon√≠veis
            if (typeof window.currentEditingRecord === 'undefined') {
                alert('Sistema de edi√ß√£o n√£o est√° carregado. Aguarde um momento e tente novamente.');
                return;
            }
            
            // Chamar a fun√ß√£o do m√≥dulo atrav√©s de uma fun√ß√£o global
            if (window.editRecordFromModule) {
                window.editRecordFromModule(recordId);
            } else {
                alert('Fun√ß√£o de edi√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
            }
        }

        // Fun√ß√£o para habilitar/desabilitar campo "Outros"
        function toggleOtherSubjects() {
            const othersCheckbox = document.getElementById('editOthers');
            const otherSubjectsInput = document.getElementById('editOtherSubjects');
            
            if (othersCheckbox && otherSubjectsInput) {
                otherSubjectsInput.disabled = !othersCheckbox.checked;
                if (!othersCheckbox.checked) {
                    otherSubjectsInput.value = '';
                }
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, orderBy, query, where, deleteDoc, doc, setDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABEloTfC_nT5vfDHpeqYdDjNoPCKwE-Eo",
            authDomain: "projeto-alex-aaadf.firebaseapp.com",
            projectId: "projeto-alex-aaadf",
            storageBucket: "projeto-alex-aaadf.firebasestorage.app",
            messagingSenderId: "720032595137",
            appId: "1:720032595137:web:85834232e770a942216840"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRecords = [];
        let filteredRecords = [];

        // Verificar autentica√ß√£o
        function checkAuth() {
            const userRole = localStorage.getItem('userRole');
            const userCPF = localStorage.getItem('userCPF');
            const userName = localStorage.getItem('userName');
            
            if (!userRole || !userCPF || !userName) {
                window.location.href = 'index.html';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('userCPF');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            window.location.href = 'index.html';
        }

        // Carregar todos os registros
        async function loadAllRecords() {
            try {
                console.log('Carregando registros...');
                const q = query(collection(db, 'records'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allRecords = [];
                querySnapshot.forEach((doc) => {
                    allRecords.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`Total de registros carregados: ${allRecords.length}`);
                filterRecords();
                updateLastUpdate();
                
            } catch (error) {
                console.error('Erro ao carregar registros:', error);
                document.getElementById('recordsList').innerHTML = '<div class="error">Erro ao carregar registros: ' + error.message + '</div>';
            }
        }

        // Filtrar registros
        function filterRecords() {
            const schoolFilter = document.getElementById('schoolFilter').value;
            const municipalityFilter = document.getElementById('municipalityFilter').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            const indicatorFilter = document.getElementById('indicatorFilter').value;
            const dateStartFilter = document.getElementById('dateStartFilter').value;
            const dateEndFilter = document.getElementById('dateEndFilter').value;
            const technicianFilter = document.getElementById('technicianFilter').value.toLowerCase();
            const studentFilter = document.getElementById('studentFilter').value.toLowerCase();

            filteredRecords = allRecords.filter(record => {
                // Filtrar apenas registros pendentes (n√£o resolvidos)
                if (record.status === 'resolved') return false;
                
                // Filtro por escola
                if (schoolFilter && record.school !== schoolFilter) return false;
                
                // Filtro por munic√≠pio
                if (municipalityFilter && record.municipality !== municipalityFilter) return false;
                
                // Filtro por departamento
                if (departmentFilter && record.department !== departmentFilter) return false;
                
                // Filtro por indicador
                if (indicatorFilter && record.indicator !== indicatorFilter) return false;
                
                // Filtro por data
                if (dateStartFilter && record.date < dateStartFilter) return false;
                if (dateEndFilter && record.date > dateEndFilter) return false;
                
                // Filtro por t√©cnico
                if (technicianFilter && !record.technician.toLowerCase().includes(technicianFilter)) return false;
                
                // Filtro por estudante
                if (studentFilter && !record.studentName?.toLowerCase().includes(studentFilter)) return false;
                
                return true;
            });

            displayRecords();
            updateStats();
        }

        // Exibir registros
        function displayRecords() {
            const recordsList = document.getElementById('recordsList');
            
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = '<div class="no-records">Nenhum registro encontrado com os filtros aplicados.</div>';
                return;
            }

            let html = '';
            filteredRecords.forEach(record => {
                const date = record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A';
                const createdAt = record.createdAt ? 
                    (record.createdAt.toDate ? new Date(record.createdAt.toDate()).toLocaleDateString('pt-BR') : 
                     new Date(record.createdAt).toLocaleDateString('pt-BR')) : 'N/A';
                
                html += `
                    <div class="record-card">
                        <div class="record-header">
                            <h4>${record.indicator}</h4>
                            <span class="department-badge ${record.department.replace(/\s+/g, '-').toLowerCase()}">${record.department}</span>
                        </div>
                        <div class="record-info">
                            <p><strong>Escola:</strong> ${record.school}</p>
                            <p><strong>Munic√≠pio:</strong> ${record.municipality}</p>
                            <p><strong>T√©cnico:</strong> ${record.technician}</p>
                            <p><strong>Data:</strong> ${date}</p>
                            ${record.studentName ? `<p><strong>Estudante:</strong> ${record.studentName}</p>` : ''}
                            ${record.indicator === 'Aulas Previstas e Aulas Dadas' ? `
                                ${record.turmas && Array.isArray(record.turmas) && record.turmas.length > 0 ? `
                                    <!-- NOVO FORMATO: Turmas Din√¢micas -->
                                    <p><strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)</p>
                                    <p><strong>Total de Aulas Previstas:</strong> ${record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0)}</p>
                                    <p><strong>Total de Aulas Realizadas:</strong> ${record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0)}</p>
                                    <p><strong>Taxa de Cumprimento:</strong> ${(() => {
                                        const totalPrevistas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0);
                                        const totalDadas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0);
                                        return totalPrevistas > 0 ? Math.round((totalDadas / totalPrevistas) * 100) + '%' : '0%';
                                    })()}</p>
                                ` : `
                                    <!-- FORMATO ANTIGO para compatibilidade -->
                                    <p><strong>Turma:</strong> ${record.className || 'N/A'}</p>
                                    <p><strong>Disciplina:</strong> ${record.discipline || 'N/A'}</p>
                                    <p><strong>Professor:</strong> ${record.professorName || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${record.teacherAbsence || record.schoolEvent || record.holiday || record.strike || record.sgeUnavailable || record.professorNotLaunched || record.others ? 'Com Motivos' : 'Sem Motivos'}</p>
                                `}
                            ` : ''}
                            ${record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Curr√≠culo' ? `
                                <!-- SEMPRE NOVO FORMATO para Curr√≠culo -->
                                <p><strong>Bimestre:</strong> ${record.bimester || 'N/A'}</p>
                                <p><strong>Turmas:</strong> ${record.turmas ? record.turmas.length : 0} turma(s)</p>
                                <p><strong>Status:</strong> ${record.studentSituation || 'N/A'}</p>
                            ` : record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Supervis√£o' ? `
                                <!-- NOVO FORMATO para Supervis√£o com turmas din√¢micas -->
                                ${record.turmas && record.turmas.length > 0 ? `
                                    <p><strong>Status:</strong> ${record.turmas.some(t => t.situacao === 'Resolvido') ? 'Resolvido' : 'Pendente'}</p>
                                    <p><strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)</p>
                                    <p><strong>Total de Estudantes:</strong> ${record.turmas.reduce((total, t) => total + (parseInt(t.numeroEstudantes) || 0), 0)}</p>
                                ` : `
                                    <!-- FORMATO ANTIGO para compatibilidade -->
                                    <p><strong>Estudante:</strong> ${record.studentName || 'N/A'}</p>
                                    <p><strong>Nota:</strong> ${record.studentGrade || 'N/A'}</p>
                                    <p><strong>S√©rie/Turma:</strong> ${record.seriesClass || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${record.subjects?.portuguese || record.subjects?.mathematics || record.subjects?.history || record.subjects?.geography || record.subjects?.science || record.subjects?.physicalEducation || record.subjects?.arts || record.subjects?.english || record.subjects?.philosophy || record.subjects?.sociology || record.subjects?.biology || record.subjects?.physics || record.subjects?.chemistry || record.subjects?.literature || record.subjects?.spanish || record.subjects?.others ? 'Com Disciplinas' : 'Sem Disciplinas'}</p>
                                `}
                            ` : record.indicator === 'Estudantes Abaixo da M√©dia' && record.department !== 'Supervis√£o' && record.department !== 'Equipe Multiprofissional' ? `
                                <!-- FORMATO ANTIGO para outros departamentos (n√£o Supervis√£o e n√£o Equipe Multiprofissional) -->
                                <p><strong>Estudante:</strong> ${record.studentName || 'N/A'}</p>
                                <p><strong>Nota:</strong> ${record.studentGrade || 'N/A'}</p>
                                <p><strong>S√©rie/Turma:</strong> ${record.seriesClass || 'N/A'}</p>
                                <p><strong>Status:</strong> ${record.subjects?.portuguese || record.subjects?.mathematics || record.subjects?.history || record.subjects?.geography || record.subjects?.science || record.subjects?.physicalEducation || record.subjects?.arts || record.subjects?.english || record.subjects?.philosophy || record.subjects?.sociology || record.subjects?.biology || record.subjects?.physics || record.subjects?.chemistry || record.subjects?.literature || record.subjects?.spanish || record.subjects?.others ? 'Com Disciplinas' : 'Sem Disciplinas'}</p>
                            ` : ''}
                            ${record.department === 'Equipe Multiprofissional' ? `
                                ${record.indicator === 'Busca Ativa' ? `
                                    ${record.turmas && record.turmas.length > 0 ? `
                                        <!-- NOVO FORMATO com turmas din√¢micas -->
                                        <p><strong>Status:</strong> ${record.turmas.some(t => t.estudantes.some(e => e.pcd || e.ministerioPublico || e.menorIdade || e.atestadoMedico || e.conselhoTutelar)) ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes'}</p>
                                        <p><strong>Turmas:</strong> ${record.turmas.length} turma(s)</p>
                                    ` : `
                                        <!-- FORMATO ANTIGO para compatibilidade -->
                                        <p><strong>Status:</strong> ${record.pcd || record.ministerioPublico || record.menorIdade || record.atestadoMedico || record.conselhoTutelar ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes'}</p>
                                    `}
                                ` : ''}
                                ${record.indicator === 'Aulas Previstas e Aulas Dadas' ? `
                                    <p><strong>Turma:</strong> ${record.className || 'N/A'}</p>
                                    <p><strong>Disciplina:</strong> ${record.discipline || 'N/A'}</p>
                                    <p><strong>Professor:</strong> ${record.professorName || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${record.teacherAbsence || record.schoolEvent || record.holiday || record.strike || record.sgeUnavailable || record.professorNotLaunched || record.others ? 'Com Motivos' : 'Sem Motivos'}</p>
                                ` : ''}
                                ${record.indicator === 'Estudantes Abaixo da M√©dia' ? `
                                    ${record.turmas && record.turmas.length > 0 ? `
                                        <!-- NOVO FORMATO para Equipe Multiprofissional com turmas din√¢micas -->
                                        <p><strong>Status:</strong> ${record.turmas.some(t => t.situacao === 'Resolvido') ? 'Resolvido' : 'Pendente'}</p>
                                        <p><strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)</p>
                                        <p><strong>Total de Estudantes:</strong> ${record.turmas.reduce((total, t) => total + (parseInt(t.numeroEstudantes) || 0), 0)}</p>
                                    ` : `
                                        <!-- FORMATO ANTIGO para compatibilidade -->
                                        <p><strong>Estudante:</strong> ${record.studentName || 'N/A'}</p>
                                        <p><strong>Nota:</strong> ${record.studentGrade || 'N/A'}</p>
                                        <p><strong>S√©rie/Turma:</strong> ${record.seriesClass || 'N/A'}</p>
                                        <p><strong>Status:</strong> ${record.subjects?.portuguese || record.subjects?.mathematics || record.subjects?.history || record.subjects?.geography || record.subjects?.science || record.subjects?.physicalEducation || record.subjects?.arts || record.subjects?.english || record.subjects?.philosophy || record.subjects?.sociology || record.subjects?.biology || record.subjects?.physics || record.subjects?.chemistry || record.subjects?.literature || record.subjects?.spanish || record.subjects?.others ? 'Com Disciplinas' : 'Sem Disciplinas'}</p>
                                    `}
                                ` : ''}
                                ${record.indicator === 'Frequ√™ncia dos Estudantes' ? `
                                    <!-- VERS√ÉO LIMPA para Equipe Multiprofissional - igual √† Supervis√£o -->
                                    <p><strong>Status:</strong> ${record.turmas && record.turmas.length > 0 ? (record.turmas.some(t => t.status === 'Pendente') ? 'Pendente' : 'Resolvido') : (record.status || 'Pendente')}</p>
                                    <p><strong>Etapas:</strong> ${record.turmas && record.turmas.length > 0 ? record.turmas.map(t => t.etapa).filter(Boolean).join(', ') : (record.etapa || 'N/A')}</p>
                                ` : ''}
                            ` : ''}
                            ${record.department === 'Supervis√£o' ? `
                                ${record.indicator === 'Busca Ativa' ? `
                                    ${record.turmas && record.turmas.length > 0 ? `
                                        <!-- NOVO FORMATO com turmas din√¢micas -->
                                        <p><strong>Status:</strong> ${record.turmas.some(t => t.estudantes.some(e => e.pcd || e.ministerioPublico || e.menorIdade || e.atestadoMedico || e.conselhoTutelar)) ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes'}</p>
                                        <p><strong>Turmas:</strong> ${record.turmas.length} turma(s)</p>
                                    ` : `
                                        <!-- FORMATO ANTIGO para compatibilidade -->
                                        <p><strong>Status:</strong> ${record.pcd || record.ministerioPublico || record.menorIdade || record.atestadoMedico || record.conselhoTutelar ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes'}</p>
                                    `}
                                ` : ''}
                                ${record.indicator === 'Aulas Previstas e Aulas Dadas' ? `
                                    ${record.turmas && Array.isArray(record.turmas) && record.turmas.length > 0 ? `
                                        <!-- NOVO FORMATO: Turmas Din√¢micas -->
                                        <p><strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)</p>
                                        <p><strong>Total de Aulas Previstas:</strong> ${record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0)}</p>
                                        <p><strong>Total de Aulas Realizadas:</strong> ${record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0)}</p>
                                        <p><strong>Taxa de Cumprimento:</strong> ${(() => {
                                            const totalPrevistas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0);
                                            const totalDadas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0);
                                            return totalPrevistas > 0 ? Math.round((totalDadas / totalPrevistas) * 100) + '%' : '0%';
                                        })()}</p>
                                    ` : `
                                        <!-- FORMATO ANTIGO para compatibilidade -->
                                        <p><strong>Turma:</strong> ${record.className || 'N/A'}</p>
                                        <p><strong>Disciplina:</strong> ${record.discipline || 'N/A'}</p>
                                        <p><strong>Professor:</strong> ${record.professorName || 'N/A'}</p>
                                        <p><strong>Status:</strong> ${record.teacherAbsence || record.schoolEvent || record.holiday || record.strike || record.sgeUnavailable || record.professorNotLaunched || record.others ? 'Com Motivos' : 'Sem Motivos'}</p>
                                    `}
                                ` : ''}
                                ${record.indicator === 'Frequ√™ncia dos Estudantes' ? `
                                    ${record.department === 'Curr√≠culo' ? `
                                        <!-- NOVO FORMATO para Curr√≠culo com turmas din√¢micas -->
                                        <p><strong>N√∫mero de Turmas:</strong> ${record.turmas ? record.turmas.length : 0} turma(s)</p>
                                        <p><strong>Total de Estudantes:</strong> ${record.turmas ? record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0) : 0}</p>
                                        <p><strong>Estudantes com Frequ√™ncia Baixa:</strong> ${record.turmas ? record.turmas.reduce((total, t) => total + (parseInt(t.estudantesFrequenciaBaixa) || 0), 0) : 0}</p>
                                    ` : record.department === 'Supervis√£o' ? `
                                        <!-- VERS√ÉO LIMPA para Supervis√£o - apenas dados b√°sicos + Etapas -->
                                        <p><strong>Status:</strong> ${record.turmas && record.turmas.length > 0 ? (record.turmas.some(t => t.status === 'Pendente') ? 'Pendente' : 'Resolvido') : (record.status || 'Pendente')}</p>
                                        <p><strong>Etapas:</strong> ${record.turmas && record.turmas.length > 0 ? record.turmas.map(t => t.etapa).join(', ') : (record.etapa || 'N/A')}</p>
                                    ` : record.department === 'Equipe Multiprofissional' ? `
                                        <!-- VERS√ÉO LIMPA para Equipe Multiprofissional - igual √† Supervis√£o -->
                                        <p><strong>Status:</strong> ${record.turmas && record.turmas.length > 0 ? (record.turmas.some(t => t.status === 'Pendente') ? 'Pendente' : 'Resolvido') : (record.status || 'Pendente')}</p>
                                        <p><strong>Etapas:</strong> ${record.turmas && record.turmas.length > 0 ? record.turmas.map(t => t.etapa).filter(Boolean).join(', ') : (record.etapa || 'N/A')}</p>
                                    ` : `
                                        <!-- FORMATO ANTIGO para outros departamentos -->
                                        <p><strong>N¬∫ de Faltas:</strong> ${record.totalAbsences || record.consecutiveAbsences || 'N/A'}</p>
                                        <p><strong>Bimestres:</strong> ${record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A'}</p>
                                        <p><strong>Etapa:</strong> ${record.etapa || 'N/A'}</p>
                                        <p><strong>ID Turma:</strong> ${record.turmaId || 'N/A'}</p>
                                    `}
                                ` : ''}
                            ` : ''}
                            <p><strong>Criado em:</strong> ${createdAt}</p>
                        </div>
                        <div class="record-actions">
                            <button onclick="viewRecord('${record.id}')" class="btn btn-primary">üëÅÔ∏è Visualizar</button>
                            <button onclick="editRecordFromModule('${record.id}')" class="btn btn-warning">‚úèÔ∏è Editar</button>
                            <button onclick="markAsResolved('${record.id}')" class="btn btn-success">‚úÖ Resolvido</button>
                            <button onclick="deleteRecord('${record.id}')" class="btn btn-danger">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        // Fun√ß√£o para obter √≠cone baseado no tipo de arquivo
        function getFileIcon(fileType) {
            if (!fileType) return 'üìÑ';
            
            if (fileType.includes('pdf')) return 'üìÑ';
            if (fileType.includes('word') || fileType.includes('doc')) return 'üìù';
            if (fileType.includes('excel') || fileType.includes('sheet') || fileType.includes('xls')) return 'üìä';
            if (fileType.includes('image') || fileType.includes('jpg') || fileType.includes('jpeg') || fileType.includes('png')) return 'üñºÔ∏è';
            if (fileType.includes('text') || fileType.includes('txt')) return 'üìù';
            
            return 'üìé';
        }

        // Visualizar registro detalhado
        async function viewRecord(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            // Armazenar o registro atual para edi√ß√£o
            currentEditingRecord = record;

            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = `${record.indicator} - ${record.department}`;
            
            let html = `
                <div class="record-details">
                    <h3>Informa√ß√µes Gerais</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Escola:</strong> ${record.school}
                        </div>
                        <div class="detail-item">
                            <strong>Munic√≠pio:</strong> ${record.municipality}
                        </div>
                        <div class="detail-item">
                            <strong>T√©cnico:</strong> ${record.technician}
                        </div>
                        <div class="detail-item">
                            <strong>Data:</strong> ${record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Departamento:</strong> ${record.department}
                        </div>
                        <div class="detail-item">
                            <strong>Indicador:</strong> ${record.indicator}
                        </div>
                    </div>
            `;

            // Informa√ß√µes espec√≠ficas por indicador
            if (record.indicator === 'Frequ√™ncia dos Estudantes') {
                if (record.department === 'Supervis√£o') {
                    // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                    if (record.turmas && record.turmas.length > 0) {
                        html += `
                            <h3>Resumo Geral</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)
                                </div>
                                <div class="detail-item">
                                    <strong>Total de Estudantes Infrequentes:</strong> ${record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0)}
                                </div>
                                <div class="detail-item">
                                    <strong>Status Geral:</strong> ${record.turmas.some(t => t.status === 'Pendente') ? 'Com Pend√™ncias' : 'Todas Resolvidas'}
                                </div>
                            </div>
                            
                            <h3>Detalhes das Turmas</h3>
                            ${record.turmas.map((turma, index) => `
                                <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <strong>Total de Estudantes Infrequentes:</strong> ${turma.totalEstudantes || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Etapa:</strong> ${turma.etapa || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Status:</strong> ${turma.status || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Bimestres:</strong> ${turma.bimestres && turma.bimestres.length > 0 ? turma.bimestres.join(', ') : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        html += `
                            <h3>Dados da Turma</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Total de Estudantes:</strong> ${record.totalStudents || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Bimestres:</strong> ${record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Etapa:</strong> ${record.etapa || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Turma:</strong> ${record.turmaId || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Status:</strong> ${record.status || 'N/A'}
                                </div>
                            </div>
                        `;
                    }
                } else if (record.department === 'Curr√≠culo') {
                    // NOVO FORMATO para Curr√≠culo com turmas din√¢micas
                    html += `
                        <h3>Resumo Geral</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>N√∫mero de Turmas:</strong> ${record.turmas ? record.turmas.length : 0} turma(s)
                            </div>
                            <div class="detail-item">
                                <strong>Total de Estudantes:</strong> ${record.turmas ? record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0) : 0}
                            </div>
                            <div class="detail-item">
                                <strong>Estudantes com Frequ√™ncia Baixa:</strong> ${record.turmas ? record.turmas.reduce((total, t) => total + (parseInt(t.estudantesFrequenciaBaixa) || 0), 0) : 0}
                            </div>
                        </div>
                        
                        <h3>Detalhes das Turmas</h3>
                        ${record.turmas && record.turmas.length > 0 ? record.turmas.map((turma, index) => `
                            <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>Total de Estudantes:</strong> ${turma.totalEstudantes || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Estudantes com Frequ√™ncia Baixa:</strong> ${turma.estudantesFrequenciaBaixa || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Etapa:</strong> ${turma.etapa || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Bimestres:</strong> ${turma.bimestres && turma.bimestres.length > 0 ? turma.bimestres.join(', ') : 'N/A'}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p>Nenhuma turma registrada</p>'}
                    `;
                } else if (record.department === 'Equipe Multiprofissional') {
                    // NOVO FORMATO para Equipe Multiprofissional com turmas din√¢micas
                    if (record.turmas && record.turmas.length > 0) {
                        html += `
                            <h3>Resumo Geral</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)
                                </div>
                                <div class="detail-item">
                                    <strong>Total de Estudantes Infrequentes:</strong> ${record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0)}
                                </div>
                                <div class="detail-item">
                                    <strong>Status Geral:</strong> ${record.turmas.some(t => t.status === 'Pendente') ? 'Com Pend√™ncias' : 'Todas Resolvidas'}
                                </div>
                            </div>
                            
                            <h3>Detalhes das Turmas</h3>
                            ${record.turmas.map((turma, index) => `
                                <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <strong>Total de Estudantes Infrequentes:</strong> ${turma.totalEstudantes || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Estudantes com Frequ√™ncia Baixa:</strong> ${turma.estudantesFrequenciaBaixa || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Etapa:</strong> ${turma.etapa || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Status:</strong> ${turma.status || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Bimestres:</strong> ${turma.bimestres && turma.bimestres.length > 0 ? turma.bimestres.join(', ') : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        html += `
                            <h3>Dados do Estudante</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Nome:</strong> ${record.studentName || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>N¬∫ de Faltas:</strong> ${record.totalAbsences || record.consecutiveAbsences || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Bimestres:</strong> ${record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Etapa:</strong> ${record.etapa || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Turma:</strong> ${record.turmaId || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Status:</strong> ${record.status || 'N/A'}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // FORMATO ANTIGO para outros departamentos
                    html += `
                        <h3>Dados do Estudante</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>N¬∫ de Faltas:</strong> ${record.totalAbsences || record.consecutiveAbsences || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Bimestres:</strong> ${record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Etapa:</strong> ${record.etapa || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turma:</strong> ${record.turmaId || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Status:</strong> ${record.status || 'N/A'}
                            </div>
                        </div>
                    `;
                }
            } else if (record.indicator === 'Busca Ativa') {
                if (record.turmas && record.turmas.length > 0) {
                    // NOVO FORMATO com turmas din√¢micas
                    html += `
                        <h3>Resumo Geral</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)
                            </div>
                            <div class="detail-item">
                                <strong>Total de Estudantes:</strong> ${record.turmas.reduce((total, t) => total + t.estudantes.length, 0)}
                            </div>
                            <div class="detail-item">
                                <strong>Total de Faltas:</strong> ${record.turmas.reduce((total, t) => total + t.estudantes.reduce((subTotal, e) => subTotal + (parseInt(e.faltas) || 0), 0), 0)}
                            </div>
                            <div class="detail-item">
                                <strong>Total de Visitas:</strong> ${record.turmas.reduce((total, t) => total + t.estudantes.reduce((subTotal, e) => subTotal + ((e.visit1 ? 1 : 0) + (e.visit2 ? 1 : 0) + (e.visit3 ? 1 : 0)), 0), 0)}
                            </div>
                        </div>
                        
                        <h3>Detalhes das Turmas</h3>
                        ${record.turmas.map((turma, turmaIndex) => `
                            <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4 style="color: #495057; margin-bottom: 15px;">üè´ Turma ${turmaIndex + 1}: ${turma.nome || 'Sem nome'}</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>Turno:</strong> ${turma.turno || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>N√∫mero de Estudantes:</strong> ${turma.estudantes.length} estudante(s)
                                    </div>
                                    <div class="detail-item">
                                        <strong>Total de Faltas da Turma:</strong> ${turma.estudantes.reduce((total, e) => total + (parseInt(e.faltas) || 0), 0)}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Total de Visitas da Turma:</strong> ${turma.estudantes.reduce((total, e) => total + ((e.visit1 ? 1 : 0) + (e.visit2 ? 1 : 0) + (e.visit3 ? 1 : 0)), 0)}
                                    </div>
                                </div>
                                
                                <h5 style="color: #6c757d; margin: 15px 0 10px 0;">üë• Estudantes da Turma</h5>
                                ${turma.estudantes.map((estudante, estudanteIndex) => `
                                    <div class="estudante-section" style="background: white; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin: 10px 0;">
                                        <h6 style="color: #495057; margin-bottom: 10px;">üë§ Estudante ${estudanteIndex + 1}: ${estudante.nome}</h6>
                                        <div class="detail-grid">
                                            <div class="detail-item">
                                                <strong>N¬∫ de Faltas:</strong> ${estudante.faltas || 0}
                                            </div>
                                            <div class="detail-item">
                                                <strong>Total de Visitas:</strong> ${(estudante.visit1 ? 1 : 0) + (estudante.visit2 ? 1 : 0) + (estudante.visit3 ? 1 : 0)}
                                            </div>
                                            <div class="detail-item">
                                                <strong>PCD:</strong> ${estudante.pcd ? 'Sim' : 'N√£o'}
                                            </div>
                                            <div class="detail-item">
                                                <strong>Minist√©rio P√∫blico:</strong> ${estudante.ministerioPublico ? 'Sim' : 'N√£o'}
                                            </div>
                                            <div class="detail-item">
                                                <strong>Menor de Idade:</strong> ${estudante.menorIdade ? 'Sim' : 'N√£o'}
                                            </div>
                                            <div class="detail-item">
                                                <strong>Atestado M√©dico:</strong> ${estudante.atestadoMedico ? 'Sim' : 'N√£o'}
                                            </div>
                                            <div class="detail-item">
                                                <strong>Conselho Tutelar:</strong> ${estudante.conselhoTutelar ? 'Sim' : 'N√£o'}
                                            </div>
                                        </div>
                                        
                                        <div class="detail-grid">
                                            <div class="detail-item">
                                                <strong>1¬™ Visita:</strong> ${estudante.visit1 ? 'Sim' : 'N√£o'}
                                            </div>
                                            <div class="detail-item">
                                                <strong>2¬™ Visita:</strong> ${estudante.visit2 ? 'Sim' : 'N√£o'}
                                            </div>
                                            <div class="detail-item">
                                                <strong>3¬™ Visita:</strong> ${estudante.visit3 ? 'Sim' : 'N√£o'}
                                            </div>
                                        </div>
                                        
                                        ${estudante.observacoes ? `
                                            <div class="detail-item" style="margin-top: 10px;">
                                                <strong>Observa√ß√µes:</strong> ${estudante.observacoes}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    `;
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    html += `
                        <h3>Dados da Busca</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turno:</strong> ${record.shift || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Faltas:</strong> ${record.absences || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Total de Visitas:</strong> ${record.totalVisitas || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Informa√ß√µes Adicionais</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>PCD:</strong> ${record.pcd ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Minist√©rio P√∫blico:</strong> ${record.ministerioPublico ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Menor de Idade:</strong> ${record.menorIdade ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Atestado M√©dico:</strong> ${record.atestadoMedico ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Conselho Tutelar:</strong> ${record.conselhoTutelar ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                        
                        <h3>Visitas Realizadas</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>1¬™ Visita:</strong> ${record.primeiraVisita ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>2¬™ Visita:</strong> ${record.segundaVisita ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>3¬™ Visita:</strong> ${record.terceiraVisita ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                    `;
                }
            } else if (record.indicator === 'Aulas Previstas e Aulas Dadas') {
                // Verificar se √© o novo formato com turmas din√¢micas
                if (record.turmas && Array.isArray(record.turmas) && record.turmas.length > 0) {
                    // NOVO FORMATO: Turmas Din√¢micas
                    html += `
                        <h3>Turmas e Componentes Curriculares</h3>
                    `;
                    
                    record.turmas.forEach((turma, turmaIndex) => {
                        html += `
                            <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4 style="color: #495057; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 8px;">
                                    üè´ Turma ${turmaIndex + 1} - ${turma.idTurma || 'ID n√£o informado'}
                                </h4>
                                
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>ID da Turma:</strong> ${turma.idTurma || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Bimestre:</strong> ${turma.bimester || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Situa√ß√£o:</strong> ${turma.situation || 'N/A'}
                                    </div>
                                </div>
                                
                                ${turma.componentes && turma.componentes.length > 0 ? `
                                    <div class="componentes-section" style="margin-top: 15px;">
                                        <h5 style="margin: 0 0 10px 0; color: #6c757d;">üìö Componentes Curriculares</h5>
                                        ${turma.componentes.map((componente, compIndex) => `
                                            <div class="componente-section" style="background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin: 10px 0;">
                                                <h6 style="margin: 0 0 10px 0; color: #495057;">${componente.nome || 'Nome n√£o informado'}</h6>
                                                <div class="detail-grid">
                                                    <div class="detail-item">
                                                        <strong>Aulas Previstas:</strong> 
                                                        <span style="font-weight: bold; color: #007bff;">${componente.aulasPrevistas || 0}</span>
                                                    </div>
                                                    <div class="detail-item">
                                                        <strong>Aulas Dadas:</strong> 
                                                        <span style="font-weight: bold; color: #28a745;">${componente.aulasDadas || 0}</span>
                                                    </div>
                                                    <div class="detail-item">
                                                        <strong>Taxa de Cumprimento:</strong> 
                                                        <span style="font-weight: bold; color: ${componente.porcentagem >= 80 ? '#28a745' : componente.porcentagem >= 60 ? '#ffc107' : '#dc3545'};">
                                                            ${componente.porcentagem || 0}%
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color: #666; font-style: italic; text-align: center; padding: 15px;">Nenhum componente curricular registrado.</p>'}
                            </div>
                        `;
                    });
                    
                    // Resumo Consolidado
                    const totalTurmas = record.turmas.length;
                    const totalPrevistas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0);
                    const totalDadas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0);
                    const taxaGeral = totalPrevistas > 0 ? Math.round((totalDadas / totalPrevistas) * 100) : 0;
                    
                    html += `
                        <h3>Resumo Consolidado</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Total de Turmas:</strong> 
                                <span style="font-weight: bold; color: #007bff;">${totalTurmas}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Total de Aulas Previstas:</strong> 
                                <span style="font-weight: bold; color: #007bff;">${totalPrevistas}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Total de Aulas Realizadas:</strong> 
                                <span style="font-weight: bold; color: #28a745;">${totalDadas}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Taxa de Cumprimento Geral:</strong> 
                                <span style="font-weight: bold; color: ${taxaGeral >= 80 ? '#28a745' : taxaGeral >= 60 ? '#ffc107' : '#dc3545'};">
                                    ${taxaGeral}%
                                </span>
                            </div>
                        </div>
                    `;
                    
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    html += `
                        <h3>Dados da Turma e Disciplina</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Data de Refer√™ncia:</strong> ${record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turma:</strong> ${record.classId || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Disciplina:</strong> ${record.discipline || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Per√≠odo Inicial:</strong> ${record.periodStart ? new Date(record.periodStart).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Per√≠odo Final:</strong> ${record.periodEnd ? new Date(record.periodEnd).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nome do(a) Professor(a):</strong> ${record.professorName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Bimestre:</strong> ${record.bimester || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.situation || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Motivos de N√£o Realiza√ß√£o/Registro</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Falta do Docente:</strong> ${record.teacherAbsence ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Evento Escolar:</strong> ${record.schoolEvent ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Feriado:</strong> ${record.holiday ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Greve/Suspens√£o:</strong> ${record.strike ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Indisponibilidade SGE:</strong> ${record.sgeUnavailable ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>N√£o Lan√ßamento SGE Professor:</strong> ${record.professorNotLaunched ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.others ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                    `;
                }
            } else if (record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Curr√≠culo') {
                // SEMPRE NOVO FORMATO para Curr√≠culo
                html += `
                    <h3>Dados do Bimestre</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Bimestre:</strong> ${record.bimester || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Situa√ß√£o Geral:</strong> ${record.studentSituation || 'N/A'}
                        </div>
                    </div>
                    
                    <h3>Turmas e Estudantes</h3>
                    ${record.turmas && record.turmas.length > 0 ? record.turmas.map((turma, index) => `
                        <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                            <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Estudantes Abaixo da M√©dia:</strong> ${turma.estudantes || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>N√∫mero de Componentes Curriculares:</strong> ${turma.componentesCurriculares || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Componentes Detalhados:</strong> ${turma.componentesDetalhados || 'N/A'}
                                </div>
                            </div>
                        </div>
                    `).join('') : '<p>Nenhuma turma registrada</p>'}
                `;
            } else if (record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Supervis√£o') {
                // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                if (record.turmas && record.turmas.length > 0) {
                    html += `
                        <h3>Turmas e Estudantes Abaixo da M√©dia</h3>
                        ${record.turmas.map((turma, index) => `
                            <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>N√∫mero de estudantes abaixo da m√©dia:</strong> ${turma.numeroEstudantes || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Componentes Curriculares:</strong> ${turma.componentesCurriculares || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Situa√ß√£o:</strong> ${turma.situacao || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    html += `
                        <h3>Dados do Estudante</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome do(a) Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nota:</strong> ${record.studentGrade || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.studentSituation || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>S√©rie/Turma:</strong> ${record.series || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>N√∫mero de Componentes Curriculares Abaixo da M√©dia:</strong> ${record.curricularComponents || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Disciplinas Abaixo da M√©dia</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>L√≠ngua Portuguesa:</strong> ${record.subjects?.portuguese ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Matem√°tica:</strong> ${record.subjects?.mathematics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Hist√≥ria:</strong> ${record.subjects?.history ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Geografia:</strong> ${record.subjects?.geography ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ci√™ncias:</strong> ${record.subjects?.science ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Educa√ß√£o F√≠sica:</strong> ${record.subjects?.physicalEducation ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Arte:</strong> ${record.subjects?.arts ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ingl√™s:</strong> ${record.subjects?.english ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Filosofia:</strong> ${record.subjects?.philosophy ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Sociologia:</strong> ${record.subjects?.sociology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Biologia:</strong> ${record.subjects?.biology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>F√≠sica:</strong> ${record.subjects?.physics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Qu√≠mica:</strong> ${record.subjects?.chemistry ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Literatura:</strong> ${record.subjects?.literature ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Espanhol:</strong> ${record.subjects?.spanish ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.subjects?.others ? 'Sim' : 'N√£o'}
                            </div>
                            ${record.subjects?.others && record.subjects?.otherSubjects ? `
                            <div class="detail-item">
                                <strong>Especifica√ß√£o de Outros:</strong> ${record.subjects.otherSubjects}
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            } else if (record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Equipe Multiprofissional') {
                // NOVO FORMATO para Equipe Multiprofissional com turmas din√¢micas
                if (record.turmas && record.turmas.length > 0) {
                    html += `
                        <h3>Turmas e Estudantes Abaixo da M√©dia</h3>
                        ${record.turmas.map((turma, index) => `
                            <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>N√∫mero de estudantes abaixo da m√©dia:</strong> ${turma.numeroEstudantes || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Componentes Curriculares:</strong> ${turma.componentesCurriculares || 'N/A'}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Situa√ß√£o:</strong> ${turma.situacao || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    html += `
                        <h3>Dados do Estudante</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome do(a) Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nota:</strong> ${record.studentGrade || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.studentSituation || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>S√©rie/Turma:</strong> ${record.series || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>N√∫mero de Componentes Curriculares Abaixo da M√©dia:</strong> ${record.curricularComponents || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Disciplinas Abaixo da M√©dia</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>L√≠ngua Portuguesa:</strong> ${record.subjects?.portuguese ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Matem√°tica:</strong> ${record.subjects?.mathematics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Hist√≥ria:</strong> ${record.subjects?.history ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Geografia:</strong> ${record.subjects?.geography ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ci√™ncias:</strong> ${record.subjects?.science ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Educa√ß√£o F√≠sica:</strong> ${record.subjects?.physicalEducation ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Arte:</strong> ${record.subjects?.arts ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ingl√™s:</strong> ${record.subjects?.english ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Filosofia:</strong> ${record.subjects?.philosophy ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Sociologia:</strong> ${record.subjects?.sociology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Biologia:</strong> ${record.subjects?.biology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>F√≠sica:</strong> ${record.subjects?.physics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Qu√≠mica:</strong> ${record.subjects?.chemistry ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Literatura:</strong> ${record.subjects?.literature ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Espanhol:</strong> ${record.subjects?.spanish ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.subjects?.others ? 'Sim' : 'N√£o'}
                            </div>
                            ${record.subjects?.others && record.subjects?.otherSubjects ? `
                            <div class="detail-item">
                                <strong>Especifica√ß√£o de Outros:</strong> ${record.subjects.otherSubjects}
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            } else if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                // FORMATO ANTIGO para outros departamentos
                html += `
                    <h3>Dados do Estudante</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Nome do(a) Estudante:</strong> ${record.studentName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Nota:</strong> ${record.studentGrade || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Situa√ß√£o:</strong> ${record.studentSituation || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>S√©rie/Turma:</strong> ${record.series || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>N√∫mero de Componentes Curriculares Abaixo da M√©dia:</strong> ${record.curricularComponents || 'N/A'}
                        </div>
                    </div>
                    
                    <h3>Disciplinas Abaixo da M√©dia</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>L√≠ngua Portuguesa:</strong> ${record.subjects?.portuguese ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Matem√°tica:</strong> ${record.subjects?.mathematics ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Hist√≥ria:</strong> ${record.subjects?.history ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Geografia:</strong> ${record.subjects?.geography ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Ci√™ncias:</strong> ${record.subjects?.science ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Educa√ß√£o F√≠sica:</strong> ${record.subjects?.physicalEducation ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Arte:</strong> ${record.subjects?.arts ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Ingl√™s:</strong> ${record.subjects?.english ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Filosofia:</strong> ${record.subjects?.philosophy ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Sociologia:</strong> ${record.subjects?.sociology ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Biologia:</strong> ${record.subjects?.biology ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>F√≠sica:</strong> ${record.subjects?.physics ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Qu√≠mica:</strong> ${record.subjects?.chemistry ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Literatura:</strong> ${record.subjects?.literature ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Espanhol:</strong> ${record.subjects?.spanish ? 'Sim' : 'N√£o'}
                        </div>
                        <div class="detail-item">
                            <strong>Outros:</strong> ${record.subjects?.others ? 'Sim' : 'N√£o'}
                        </div>
                        ${record.subjects?.others && record.subjects?.otherSubjects ? `
                        <div class="detail-item">
                            <strong>Especifica√ß√£o de Outros:</strong> ${record.subjects.otherSubjects}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // EQUIPE MULTIPROFISSIONAL
            else if (record.department === 'Equipe Multiprofissional') {
                if (record.indicator === 'Busca Ativa') {
                    html += `
                        <h3>Dados da Busca - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turno:</strong> ${record.shift || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Faltas:</strong> ${record.absences || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Total de Visitas:</strong> ${record.totalVisitas || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Informa√ß√µes Adicionais - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>PCD:</strong> ${record.pcd ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Minist√©rio P√∫blico:</strong> ${record.ministerioPublico ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Menor de Idade:</strong> ${record.menorIdade ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Atestado M√©dico:</strong> ${record.atestadoMedico ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Conselho Tutelar:</strong> ${record.conselhoTutelar ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                        
                        <h3>Visitas Realizadas - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>1¬™ Visita:</strong> ${record.primeiraVisita ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>2¬™ Visita:</strong> ${record.segundaVisita ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>3¬™ Visita:</strong> ${record.terceiraVisita ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                    `;
                } else if (record.indicator === 'Aulas Previstas e Aulas Dadas') {
                    html += `
                        <h3>Dados da Turma e Disciplina - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Data de Refer√™ncia:</strong> ${record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turma:</strong> ${record.classId || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Disciplina:</strong> ${record.discipline || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Per√≠odo Inicial:</strong> ${record.periodStart ? new Date(record.periodStart).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Per√≠odo Final:</strong> ${record.periodEnd ? new Date(record.periodEnd).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nome do(a) Professor(a):</strong> ${record.professorName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Bimestre:</strong> ${record.bimester || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.situation || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Motivos de N√£o Realiza√ß√£o/Registro - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Falta do Docente:</strong> ${record.teacherAbsence ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Evento Escolar:</strong> ${record.schoolEvent ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Feriado:</strong> ${record.holiday ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Greve/Suspens√£o:</strong> ${record.strike ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Indisponibilidade SGE:</strong> ${record.sgeUnavailable ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>N√£o Lan√ßamento SGE Professor:</strong> ${record.professorNotLaunched ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.others ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                    `;
                } else if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                    html += `
                        <h3>Dados do Estudante - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome do(a) Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nota:</strong> ${record.studentGrade || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.studentSituation || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>S√©rie/Turma:</strong> ${record.seriesClass || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>N√∫mero de Componentes Curriculares Abaixo da M√©dia:</strong> ${record.curricularComponents || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Disciplinas Abaixo da M√©dia - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>L√≠ngua Portuguesa:</strong> ${record.subjects?.portuguese ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Matem√°tica:</strong> ${record.subjects?.mathematics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Hist√≥ria:</strong> ${record.subjects?.history ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Geografia:</strong> ${record.subjects?.geography ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ci√™ncias:</strong> ${record.subjects?.science ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Educa√ß√£o F√≠sica:</strong> ${record.subjects?.physicalEducation ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Arte:</strong> ${record.subjects?.arts ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ingl√™s:</strong> ${record.subjects?.english ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Filosofia:</strong> ${record.subjects?.philosophy ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Sociologia:</strong> ${record.subjects?.sociology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Biologia:</strong> ${record.subjects?.biology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>F√≠sica:</strong> ${record.subjects?.physics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Qu√≠mica:</strong> ${record.subjects?.chemistry ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Literatura:</strong> ${record.subjects?.literature ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Espanhol:</strong> ${record.subjects?.spanish ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.subjects?.others ? 'Sim' : 'N√£o'}
                            </div>
                            ${record.subjects?.others && record.subjects?.otherSubjects ? `
                            <div class="detail-item">
                                <strong>Especifica√ß√£o de Outros:</strong> ${record.subjects.otherSubjects}
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else if (record.indicator === 'Frequ√™ncia dos Estudantes') {
                    html += `
                        <h3>Dados do Estudante - Equipe Multiprofissional</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>N¬∫ de Faltas:</strong> ${record.totalAbsences || record.consecutiveAbsences || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Bimestres:</strong> ${record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Etapa:</strong> ${record.etapa || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turma:</strong> ${record.turmaId || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Status:</strong> ${record.status || 'N/A'}
                            </div>
                        </div>
                    `;
                }
            }
            
            // SUPERVIS√ÉO
            else if (record.department === 'Supervis√£o') {
                if (record.indicator === 'Busca Ativa') {
                    html += `
                        <h3>Dados da Busca - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turno:</strong> ${record.shift || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Faltas:</strong> ${record.absences || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Total de Visitas:</strong> ${record.totalVisitas || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Informa√ß√µes Adicionais - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>PCD:</strong> ${record.pcd ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Minist√©rio P√∫blico:</strong> ${record.ministerioPublico ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Menor de Idade:</strong> ${record.menorIdade ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Atestado M√©dico:</strong> ${record.atestadoMedico ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Conselho Tutelar:</strong> ${record.conselhoTutelar ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                        
                        <h3>Visitas Realizadas - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>1¬™ Visita:</strong> ${record.primeiraVisita ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>2¬™ Visita:</strong> ${record.segundaVisita ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>3¬™ Visita:</strong> ${record.terceiraVisita ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                    `;
                } else if (record.indicator === 'Aulas Previstas e Aulas Dadas') {
                    html += `
                        <h3>Dados da Turma e Disciplina - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Data de Refer√™ncia:</strong> ${record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Turma:</strong> ${record.classId || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nome da Turma:</strong> ${record.className || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Disciplina:</strong> ${record.discipline || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Per√≠odo Inicial:</strong> ${record.periodStart ? new Date(record.periodStart).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Per√≠odo Final:</strong> ${record.periodEnd ? new Date(record.periodEnd).toLocaleDateString('pt-BR') : 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nome do(a) Professor(a):</strong> ${record.professorName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Bimestre:</strong> ${record.bimester || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.situation || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Motivos de N√£o Realiza√ß√£o/Registro - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Falta do Docente:</strong> ${record.teacherAbsence ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Evento Escolar:</strong> ${record.schoolEvent ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Feriado:</strong> ${record.holiday ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Greve/Suspens√£o:</strong> ${record.strike ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Indisponibilidade SGE:</strong> ${record.sgeUnavailable ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>N√£o Lan√ßamento SGE Professor:</strong> ${record.professorNotLaunched ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.others ? 'Sim' : 'N√£o'}
                            </div>
                        </div>
                    `;
                } else if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                    html += `
                        <h3>Dados do Estudante - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nome do(a) Estudante:</strong> ${record.studentName || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Nota:</strong> ${record.studentGrade || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>Situa√ß√£o:</strong> ${record.studentSituation || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>S√©rie/Turma:</strong> ${record.seriesClass || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <strong>N√∫mero de Componentes Curriculares Abaixo da M√©dia:</strong> ${record.curricularComponents || 'N/A'}
                            </div>
                        </div>
                        
                        <h3>Disciplinas Abaixo da M√©dia - Supervis√£o</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>L√≠ngua Portuguesa:</strong> ${record.subjects?.portuguese ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Matem√°tica:</strong> ${record.subjects?.mathematics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Hist√≥ria:</strong> ${record.subjects?.history ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Geografia:</strong> ${record.subjects?.geography ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ci√™ncias:</strong> ${record.subjects?.science ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Educa√ß√£o F√≠sica:</strong> ${record.subjects?.physicalEducation ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Arte:</strong> ${record.subjects?.arts ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Ingl√™s:</strong> ${record.subjects?.english ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Filosofia:</strong> ${record.subjects?.philosophy ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Sociologia:</strong> ${record.subjects?.sociology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Biologia:</strong> ${record.subjects?.biology ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>F√≠sica:</strong> ${record.subjects?.physics ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Qu√≠mica:</strong> ${record.subjects?.chemistry ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Literatura:</strong> ${record.subjects?.literature ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Espanhol:</strong> ${record.subjects?.spanish ? 'Sim' : 'N√£o'}
                            </div>
                            <div class="detail-item">
                                <strong>Outros:</strong> ${record.subjects?.others ? 'Sim' : 'N√£o'}
                            </div>
                            ${record.subjects?.others && record.subjects?.otherSubjects ? `
                            <div class="detail-item">
                                <strong>Especifica√ß√£o de Outros:</strong> ${record.subjects.otherSubjects}
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else if (record.indicator === 'Frequ√™ncia dos Estudantes') {
                    // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                    if (record.turmas && record.turmas.length > 0) {
                        html += `
                            <h3>Resumo Geral - Supervis√£o</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>N√∫mero de Turmas:</strong> ${record.turmas.length} turma(s)
                                </div>
                                <div class="detail-item">
                                    <strong>Total de Estudantes:</strong> ${record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0)}
                                </div>
                                <div class="detail-item">
                                    <strong>Status Geral:</strong> ${record.turmas.some(t => t.status === 'Pendente') ? 'Com Pend√™ncias' : 'Todas Resolvidas'}
                                </div>
                            </div>
                            
                            <h3>Detalhes das Turmas - Supervis√£o</h3>
                            ${record.turmas.map((turma, index) => `
                                <div class="turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <strong>Total de Estudantes:</strong> ${turma.totalEstudantes || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Etapa:</strong> ${turma.etapa || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Status:</strong> ${turma.status || 'N/A'}
                                        </div>
                                        <div class="detail-item">
                                            <strong>Bimestres:</strong> ${turma.bimestres && turma.bimestres.length > 0 ? turma.bimestres.join(', ') : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        html += `
                            <h3>Dados do Estudante - Supervis√£o</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Nome:</strong> ${record.studentName || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>N¬∫ de Faltas:</strong> ${record.totalAbsences || record.consecutiveAbsences || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Bimestres:</strong> ${record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Etapa:</strong> ${record.etapa || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Turma:</strong> ${record.turmaId || 'N/A'}
                                </div>
                                <div class="detail-item">
                                    <strong>Status:</strong> ${record.status || 'N/A'}
                                </div>
                            </div>
                        `;
                    }
                }
            }

            // Observa√ß√µes e Links
            if (record.observations) {
                html += `
                    <h3>Observa√ß√µes</h3>
                    <p>${record.observations}</p>
                `;
            }

            // Se√ß√£o de Anexos
            if (record.attachments && record.attachments.length > 0) {
                html += `
                    <h3>Anexos</h3>
                    <div class="attachments-section">
                `;
                
                record.attachments.forEach(attachment => {
                    const fileIcon = getFileIcon(attachment.type);
                    html += `
                        <a href="${attachment.downloadURL}" target="_blank" class="attachment-link">
                            <span class="attachment-icon">${fileIcon}</span>
                            ${attachment.name}
                            <small style="color: #666; margin-left: 8px;">(${(attachment.size / 1024).toFixed(1)} KB)</small>
                        </a>
                    `;
                });
                
                html += `</div>`;
            } else if (record.documentLinks) {
                // Fallback para registros antigos que ainda usam documentLinks
                html += `
                    <h3>Links de Documentos</h3>
                    <p>${record.documentLinks}</p>
                `;
            }

            html += `
                    <h3>Informa√ß√µes do Sistema</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Criado por:</strong> ${record.createdByName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Fun√ß√£o:</strong> ${record.createdByRole || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <strong>Data de Cria√ß√£o:</strong> ${record.createdAt ? 
                                (record.createdAt.toDate ? new Date(record.createdAt.toDate()).toLocaleString('pt-BR') : 
                                 new Date(record.createdAt).toLocaleString('pt-BR')) : 'N/A'}
                        </div>
                    </div>
                </div>
            `;

            modalBody.innerHTML = html;
            document.getElementById('viewModal').style.display = 'block';
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        // Limpar todos os filtros
        function clearAllFilters() {
            document.getElementById('schoolFilter').value = '';
            document.getElementById('municipalityFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('indicatorFilter').value = '';
            document.getElementById('dateStartFilter').value = '';
            document.getElementById('dateEndFilter').value = '';
            document.getElementById('technicianFilter').value = '';
            document.getElementById('studentFilter').value = '';
            filterRecords();
        }

        // Atualizar registros
        function refreshRecords() {
            loadAllRecords();
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            document.getElementById('totalRecords').textContent = allRecords.length;
            document.getElementById('filteredRecords').textContent = filteredRecords.length;
        }

        // Atualizar √∫ltima atualiza√ß√£o
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('pt-BR');
        }

        // Excluir registro
        async function deleteRecord(recordId) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
                try {
                    await deleteDoc(doc(db, 'records', recordId));
                    alert('Registro exclu√≠do com sucesso!');
                    loadAllRecords(); // Recarrega todos os registros para refletir a exclus√£o
                } catch (error) {
                    console.error('Erro ao excluir registro:', error);
                    alert('Erro ao excluir registro: ' + error.message);
                }
            }
        }

        // Marcar como resolvido
        async function markAsResolved(recordId) {
            if (confirm('Tem certeza que deseja marcar este registro como resolvido?')) {
                const record = allRecords.find(r => r.id === recordId);
                if (!record) return;

                try {
                    console.log('Tentando marcar como resolvido:', recordId);
                    
                    // Atualizar o registro existente com status 'resolved' e informa√ß√µes de resolu√ß√£o
                    const updateData = {
                        status: 'resolved',
                        resolvedAt: serverTimestamp(),
                        resolvedBy: localStorage.getItem('userCPF') || 'Usu√°rio n√£o identificado',
                        resolvedByRole: localStorage.getItem('userRole') || 'N/A',
                        resolvedByName: localStorage.getItem('userName') || 'N/A'
                    };

                    // Atualizar o documento na cole√ß√£o records
                    await updateDoc(doc(db, 'records', recordId), updateData);
                    
                    console.log('Registro atualizado com sucesso no Firebase');
                    
                    // Verificar se realmente foi atualizado
                    const updatedDoc = await getDocs(query(collection(db, 'records'), where('__name__', '==', recordId)));
                    if (updatedDoc.empty) {
                        throw new Error('Documento n√£o encontrado ap√≥s atualiza√ß√£o');
                    }
                    
                    const updatedData = updatedDoc.docs[0].data();
                    if (updatedData.status !== 'resolved') {
                        throw new Error('Status n√£o foi atualizado corretamente');
                    }
                    
                    console.log('Verifica√ß√£o confirmada - status atualizado para resolved');
                    
                    alert('Registro marcado como resolvido com sucesso!');
                    
                    // Recarregar todos os registros para refletir a mudan√ßa
                    await loadAllRecords();
                    
                } catch (error) {
                    console.error('Erro ao marcar como resolvido:', error);
                    alert('Erro ao marcar como resolvido: ' + error.message);
                }
            }
        }

        // Vari√°vel global para armazenar o registro sendo editado
        let currentEditingRecord = null;

        // Fun√ß√£o para editar registro
        async function editRecord() {
            console.log('editRecord chamada');
            console.log('currentEditingRecord:', currentEditingRecord);
            
            if (!currentEditingRecord) {
                alert('Nenhum registro selecionado para edi√ß√£o!');
                return;
            }

            const record = currentEditingRecord;
            const modalBody = document.getElementById('modalBody');
            
            // Criar formul√°rio de edi√ß√£o baseado no tipo de registro
            let editForm = `
                <div class="edit-form">
                    <h3>‚úèÔ∏è Editar Registro - ${record.indicator}</h3>
                    <form id="editRecordForm">
                        <!-- Informa√ß√µes B√°sicas -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label for="editSchool">Escola:</label>
                                <input type="text" id="editSchool" value="${record.school || ''}" required>
                            </div>
                            <div>
                                <label for="editMunicipality">Munic√≠pio:</label>
                                <input type="text" id="editMunicipality" value="${record.municipality || ''}" required>
                            </div>
                            <div>
                                <label for="editTechnician">T√©cnico:</label>
                                <input type="text" id="editTechnician" value="${record.technician || ''}" required>
                            </div>
                            <div>
                                <label for="editDate">Data:</label>
                                <input type="date" id="editDate" value="${record.date || ''}" required>
                            </div>
                        </div>
            `;

            // Campos espec√≠ficos baseados no indicador
            if (record.indicator === 'Frequ√™ncia dos Estudantes') {
                if (record.department === 'Supervis√£o') {
                    // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                    if (record.turmas && record.turmas.length > 0) {
                        editForm += `
                            <h3>Editar Turmas</h3>
                            <div id="editTurmasContainer">
                                ${record.turmas.map((turma, index) => `
                                    <div class="edit-turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                        <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <label>Nome da Turma:</label>
                                                <input type="text" id="editTurmaNome_${index}" value="${turma.nome || ''}" required>
                                            </div>
                                            <div>
                                                <label>Total de Estudantes Infrequentes:</label>
                                                <input type="number" id="editTurmaTotalEstudantes_${index}" value="${turma.totalEstudantes || 0}" min="0" required>
                                            </div>
                                            <div>
                                                <label>Etapa:</label>
                                                <select id="editTurmaEtapa_${index}" required>
                                                    <option value="">Selecione</option>
                                                    <option value="Ensino Fundamental" ${turma.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                                    <option value="Ensino M√©dio" ${turma.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                                    <option value="Ensino Fundamental e Ensino M√©dio" ${turma.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                                    <option value="EJA" ${turma.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                                    <option value="Ensino Fundamental e EJA" ${turma.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                                    <option value="Ensino M√©dio e EJA" ${turma.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label>Status:</label>
                                                <select id="editTurmaStatus_${index}" required>
                                                    <option value="Pendente" ${turma.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                                    <option value="Resolvido" ${turma.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                                </select>
                                            </div>
                                            <div style="grid-column: 1 / -1;">
                                                <label>Bimestres:</label>
                                                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre1_${index}" value="1¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('1¬∫ Bimestre') ? 'checked' : ''}>
                                                        1¬∫ Bimestre
                                                    </label>
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre2_${index}" value="2¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('2¬∫ Bimestre') ? 'checked' : ''}>
                                                        2¬∫ Bimestre
                                                    </label>
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre3_${index}" value="3¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('3¬∫ Bimestre') ? 'checked' : ''}>
                                                        3¬∫ Bimestre
                                                    </label>
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre4_${index}" value="4¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('4¬∫ Bimestre') ? 'checked' : ''}>
                                                        4¬∫ Bimestre
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        editForm += `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <label for="editTotalStudents">Total de Estudantes:</label>
                                    <input type="number" id="editTotalStudents" value="${record.totalStudents || ''}" required>
                                </div>
                                <div>
                                    <label for="editEtapa">Etapa:</label>
                                    <select id="editEtapa" required>
                                        <option value="Ensino Fundamental" ${record.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                        <option value="Ensino M√©dio" ${record.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                        <option value="Ensino Fundamental e Ensino M√©dio" ${record.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                        <option value="EJA" ${record.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                        <option value="Ensino Fundamental e EJA" ${record.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                        <option value="Ensino M√©dio e EJA" ${record.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="editTurmaId">ID Turma:</label>
                                    <input type="text" id="editTurmaId" value="${record.turmaId || ''}" required>
                                </div>
                                <div>
                                    <label for="editStatus">Status:</label>
                                    <select id="editStatus" required>
                                        <option value="Pendente" ${record.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="Resolvido" ${record.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Bimestres -->
                            <div style="margin-top: 15px;">
                                <label>Bimestres:</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester1" value="1¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('1¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>1¬∫ Bimestre</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester2" value="2¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('2¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>2¬∫ Bimestre</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester3" value="3¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('3¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>3¬∫ Bimestre</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester4" value="4¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('4¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>4¬∫ Bimestre</span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Verificar se √© o novo formato com turmas din√¢micas
                    if (record.turmas && record.turmas.length > 0) {
                        editForm += `
                            <h3>Editar Turmas - Frequ√™ncia dos Estudantes</h3>
                            <div id="editTurmasContainer">
                                ${record.turmas.map((turma, index) => `
                                    <div class="edit-turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                        <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <label>Nome da Turma:</label>
                                                <input type="text" id="editTurmaNome_${index}" value="${turma.nome || ''}" required>
                                            </div>
                                            <div>
                                                <label>Total de Estudantes:</label>
                                                <input type="number" id="editTurmaTotalEstudantes_${index}" value="${turma.totalEstudantes || 0}" min="0" required>
                                            </div>
                                            <div>
                                                <label>Estudantes com Frequ√™ncia Baixa:</label>
                                                <input type="number" id="editTurmaEstudantesFrequenciaBaixa_${index}" value="${turma.estudantesFrequenciaBaixa || 0}" min="0" required>
                                            </div>
                                            <div>
                                                <label>Etapa:</label>
                                                <select id="editTurmaEtapa_${index}" required>
                                                    <option value="">Selecione</option>
                                                    <option value="Ensino Fundamental" ${turma.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                                    <option value="Ensino M√©dio" ${turma.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                                    <option value="Ensino Fundamental e Ensino M√©dio" ${turma.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                                    <option value="EJA" ${turma.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                                    <option value="Ensino Fundamental e EJA" ${turma.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                                    <option value="Ensino M√©dio e EJA" ${turma.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label>Status:</label>
                                                <select id="editTurmaStatus_${index}" required>
                                                    <option value="Pendente" ${turma.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                                    <option value="Resolvido" ${turma.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                                </select>
                                            </div>
                                            <div style="grid-column: 1 / -1;">
                                                <label>Bimestres:</label>
                                                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre1_${index}" value="1¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('1¬∫ Bimestre') ? 'checked' : ''}>
                                                        1¬∫ Bimestre
                                                    </label>
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre2_${index}" value="2¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('2¬∫ Bimestre') ? 'checked' : ''}>
                                                        2¬∫ Bimestre
                                                    </label>
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre3_${index}" value="3¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('3¬∫ Bimestre') ? 'checked' : ''}>
                                                        3¬∫ Bimestre
                                                    </label>
                                                    <label style="display: flex; align-items: center; gap: 5px;">
                                                        <input type="checkbox" id="editTurmaBimestre4_${index}" value="4¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('4¬∫ Bimestre') ? 'checked' : ''}>
                                                        4¬∫ Bimestre
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Bot√µes para gerenciar turmas -->
                            <div style="margin-top: 20px; text-align: center;">
                                <button type="button" class="btn btn-secondary" onclick="addNewTurma()" style="margin-right: 10px;">‚ûï Adicionar Nova Turma</button>
                                <button type="button" class="btn btn-danger" onclick="removeLastTurma()">‚ûñ Remover √öltima Turma</button>
                            </div>
                        `;
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        editForm += `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <label for="editStudentName">Nome do Estudante:</label>
                                    <input type="text" id="editStudentName" value="${record.studentName || ''}" required>
                                </div>
                                <div>
                                    <label for="editAbsences">N¬∫ de Faltas:</label>
                                    <input type="number" id="editAbsences" value="${record.totalAbsences || record.consecutiveAbsences || ''}" required>
                                </div>
                                <div>
                                    <label for="editEtapa">Etapa:</label>
                                    <select id="editEtapa" required>
                                        <option value="Ensino Fundamental" ${record.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                        <option value="Ensino M√©dio" ${record.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                        <option value="Ensino Fundamental e Ensino M√©dio" ${record.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                        <option value="EJA" ${record.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                        <option value="Ensino Fundamental e EJA" ${record.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                        <option value="Ensino M√©dio e EJA" ${record.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="editTurmaId">ID Turma:</label>
                                    <input type="text" id="editTurmaId" value="${record.turmaId || ''}" required>
                                </div>
                                <div>
                                    <label for="editStatus">Status:</label>
                                    <select id="editStatus" required>
                                        <option value="Pendente" ${record.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="Resolvido" ${record.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Bimestres -->
                            <div style="margin-top: 15px;">
                                <label>Bimestres:</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester1" value="1¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('1¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>1¬∫ Bimestre</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester2" value="2¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('2¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>2¬∫ Bimestre</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester3" value="3¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('3¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>3¬∫ Bimestre</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBimester4" value="4¬∫ Bimestre" ${record.selectedBimesters && record.selectedBimesters.includes('4¬∫ Bimestre') ? 'checked' : ''}>
                                        <span>4¬∫ Bimestre</span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }
                }
            } else if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                // Verificar se √© o novo formato com turmas din√¢micas
                if (record.turmas && record.turmas.length > 0) {
                    editForm += `
                        <h3>Editar Turmas - Estudantes Abaixo da M√©dia</h3>
                        <div id="editTurmasContainer">
                            ${record.turmas.map((turma, index) => `
                                <div class="edit-turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label>Nome da Turma:</label>
                                            <input type="text" id="editTurmaNome_${index}" value="${turma.nome || ''}" required>
                                        </div>
                                        <div>
                                            <label>N√∫mero de Estudantes Abaixo da M√©dia:</label>
                                            <input type="number" id="editTurmaNumeroEstudantes_${index}" value="${turma.numeroEstudantes || 0}" min="0" required>
                                        </div>
                                        <div>
                                            <label>Componentes Curriculares:</label>
                                            <input type="text" id="editTurmaComponentesCurriculares_${index}" value="${turma.componentesCurriculares || ''}" placeholder="Ex: Matem√°tica, Portugu√™s">
                                        </div>
                                        <div>
                                            <label>Componentes Detalhados:</label>
                                            <input type="text" id="editTurmaComponentesDetalhados_${index}" value="${turma.componentesDetalhados || ''}" placeholder="Ex: √Ålgebra, Geometria, Gram√°tica">
                                        </div>
                                        <div>
                                            <label>Situa√ß√£o:</label>
                                            <select id="editTurmaSituacao_${index}" required>
                                                <option value="Acompanhamento" ${turma.situacao === 'Acompanhamento' ? 'selected' : ''}>Acompanhamento</option>
                                                <option value="Resolvido" ${turma.situacao === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                                <option value="Pendente" ${turma.situacao === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Etapa:</label>
                                            <select id="editTurmaEtapa_${index}" required>
                                                <option value="">Selecione</option>
                                                <option value="Ensino Fundamental" ${turma.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                                <option value="Ensino M√©dio" ${turma.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                                <option value="Ensino Fundamental e Ensino M√©dio" ${turma.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                                <option value="EJA" ${turma.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                                <option value="Ensino Fundamental e EJA" ${turma.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                                <option value="Ensino M√©dio e EJA" ${turma.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Bot√µes para gerenciar turmas -->
                        <div style="margin-top: 20px; text-align: center;">
                            <button type="button" class="btn btn-secondary" onclick="addNewTurma()" style="margin-right: 10px;">‚ûï Adicionar Nova Turma</button>
                            <button type="button" class="btn btn-danger" onclick="removeLastTurma()">‚ûñ Remover √öltima Turma</button>
                        </div>
                    `;
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    editForm += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <label for="editStudentName">Nome do Estudante:</label>
                                <input type="text" id="editStudentName" value="${record.studentName || ''}" required>
                            </div>
                            <div>
                                <label for="editGrade">Nota:</label>
                                <input type="number" id="editGrade" step="0.1" value="${record.grade || ''}" required>
                            </div>
                            <div>
                                <label for="editSeries">S√©rie/Turma:</label>
                                <input type="text" id="editSeries" value="${record.series || ''}" required>
                            </div>
                            <div>
                                <label for="editStatus">Status:</label>
                                <select id="editStatus" required>
                                    <option value="Pendente" ${record.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Resolvido" ${record.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                </select>
                            </div>
                            <div>
                                <label for="editCurricularComponents">Componentes Curriculares Abaixo da M√©dia:</label>
                                <input type="number" id="editCurricularComponents" value="${record.curricularComponents || ''}" min="0" required>
                            </div>
                        </div>
                        
                        <!-- Disciplinas Abaixo da M√©dia -->
                        <div style="margin-top: 15px;">
                            <label>Disciplinas Abaixo da M√©dia:</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editPortuguese" ${record.subjects && record.subjects.portuguese ? 'checked' : ''}>
                                    <span>L√≠ngua Portuguesa</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editMathematics" ${record.subjects && record.subjects.mathematics ? 'checked' : ''}>
                                    <span>Matem√°tica</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editHistory" ${record.subjects && record.subjects.history ? 'checked' : ''}>
                                    <span>Hist√≥ria</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editGeography" ${record.subjects && record.subjects.geography ? 'checked' : ''}>
                                    <span>Geografia</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editScience" ${record.subjects && record.subjects.science ? 'checked' : ''}>
                                    <span>Ci√™ncias</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editPhysicalEducation" ${record.subjects && record.subjects.physicalEducation ? 'checked' : ''}>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editArts" ${record.subjects && record.subjects.arts ? 'checked' : ''}>
                                        <span>Arte</span>
                                    </label>
                                    <label style="display: flex-items: center; gap: 5px;">
                                        <input type="checkbox" id="editEnglish" ${record.subjects && record.subjects.english ? 'checked' : ''}>
                                        <span>Ingl√™s</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editPhilosophy" ${record.subjects && record.subjects.philosophy ? 'checked' : ''}>
                                        <span>Filosofia</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editSociology" ${record.subjects && record.subjects.sociology ? 'checked' : ''}>
                                        <span>Sociologia</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editBiology" ${record.subjects && record.subjects.biology ? 'checked' : ''}>
                                        <span>Biologia</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editPhysics" ${record.subjects && record.subjects.physics ? 'checked' : ''}>
                                        <span>F√≠sica</span>
                                    </label>
                                    <label style="checkbox" id="editChemistry" ${record.subjects && record.subjects.chemistry ? 'checked' : ''}>
                                        <span>Qu√≠mica</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editLiterature" ${record.subjects && record.subjects.literature ? 'checked' : ''}>
                                        <span>Literatura</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editSpanish" ${record.subjects && record.subjects.spanish ? 'checked' : ''}>
                                        <span>Espanhol</span>
                                    </label>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editOthers" ${record.subjects && record.subjects.others ? 'checked' : ''} onchange="toggleOtherSubjects()">
                                        <span>Outros:</span>
                                    </label>
                                    <input type="text" id="editOtherSubjects" value="${record.subjects && record.subjects.otherSubjects ? record.subjects.otherSubjects : ''}" placeholder="Especifique quais disciplinas" style="margin-top: 5px; width: 100%;" ${record.subjects && record.subjects.others ? '' : 'disabled'}>
                                </div>
                            </div>
                        `;
                }
            } else if (record.indicator === 'Busca Ativa') {
                // Verificar se √© o novo formato com turmas din√¢micas
                if (record.turmas && record.turmas.length > 0) {
                    editForm += `
                        <h3>Editar Turmas - Busca Ativa</h3>
                        <div id="editTurmasContainer">
                            ${record.turmas.map((turma, index) => `
                                <div class="edit-turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label>Nome da Turma:</label>
                                            <input type="text" id="editTurmaNome_${index}" value="${turma.nome || ''}" required>
                                        </div>
                                        <div>
                                            <label>Total de Estudantes:</label>
                                            <input type="number" id="editTurmaTotalEstudantes_${index}" value="${turma.totalEstudantes || 0}" min="0" required>
                                        </div>
                                        <div>
                                            <label>Etapa:</label>
                                            <select id="editTurmaEtapa_${index}" required>
                                                <option value="">Selecione</option>
                                                <option value="Ensino Fundamental" ${turma.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                                <option value="Ensino M√©dio" ${turma.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                                <option value="Ensino Fundamental e Ensino M√©dio" ${turma.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                                <option value="EJA" ${turma.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                                <option value="Ensino Fundamental e EJA" ${turma.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                                <option value="Ensino M√©dio e EJA" ${turma.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Status:</label>
                                            <select id="editTurmaStatus_${index}" required>
                                                <option value="Pendente" ${turma.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="Resolvido" ${turma.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                            </select>
                                        </div>
                                        <div style="grid-column: 1 / -1;">
                                            <label>Bimestres:</label>
                                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                                                <label style="display: flex; align-items: center; gap: 5px;">
                                                    <input type="checkbox" id="editTurmaBimestre1_${index}" value="1¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('1¬∫ Bimestre') ? 'checked' : ''}>
                                                    1¬∫ Bimestre
                                                </label>
                                                <label style="display: flex; align-items: center; gap: 5px;">
                                                    <input type="checkbox" id="editTurmaBimestre2_${index}" value="2¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('2¬∫ Bimestre') ? 'checked' : ''}>
                                                    2¬∫ Bimestre
                                                </label>
                                                <label style="display: flex; align-items: center; gap: 5px;">
                                                    <input type="checkbox" id="editTurmaBimestre3_${index}" value="3¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('3¬∫ Bimestre') ? 'checked' : ''}>
                                                    3¬∫ Bimestre
                                                </label>
                                                <label style="display: flex; align-items: center; gap: 5px;">
                                                    <input type="checkbox" id="editTurmaBimestre4_${index}" value="4¬∫ Bimestre" ${turma.bimestres && turma.bimestres.includes('4¬∫ Bimestre') ? 'checked' : ''}>
                                                    4¬∫ Bimestre
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Estudantes da Turma -->
                                    <h5 style="color: #6c757d; margin: 15px 0 10px 0;">üë• Estudantes da Turma</h5>
                                    <div id="editEstudantesContainer_${index}">
                                        ${turma.estudantes && turma.estudantes.length > 0 ? turma.estudantes.map((estudante, estudanteIndex) => `
                                            <div class="edit-estudante-section" style="background: white; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin: 10px 0;">
                                                <h6 style="color: #495057; margin-bottom: 10px;">üë§ Estudante ${estudanteIndex + 1}: ${estudante.nome}</h6>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                                    <div>
                                                        <label>Nome:</label>
                                                        <input type="text" id="editEstudanteNome_${index}_${estudanteIndex}" value="${estudante.nome || ''}" required>
                                                    </div>
                                                    <div>
                                                        <label>N¬∫ de Faltas:</label>
                                                        <input type="number" id="editEstudanteFaltas_${index}_${estudanteIndex}" value="${estudante.faltas || 0}" min="0" required>
                                                    </div>
                                                    <div>
                                                        <label>PCD:</label>
                                                        <input type="checkbox" id="editEstudantePCD_${index}_${estudanteIndex}" ${estudante.pcd ? 'checked' : ''}>
                                                    </div>
                                                    <div>
                                                        <label>Minist√©rio P√∫blico:</label>
                                                        <input type="checkbox" id="editEstudanteMinisterioPublico_${index}_${estudanteIndex}" ${estudante.ministerioPublico ? 'checked' : ''}>
                                                    </div>
                                                    <div>
                                                        <label>Menor de Idade:</label>
                                                        <input type="checkbox" id="editEstudanteMenorIdade_${index}_${estudanteIndex}" ${estudante.menorIdade ? 'checked' : ''}>
                                                    </div>
                                                    <div>
                                                        <label>Atestado M√©dico:</label>
                                                        <input type="checkbox" id="editEstudanteAtestadoMedico_${index}_${estudanteIndex}" ${estudante.atestadoMedico ? 'checked' : ''}>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('') : '<p style="color: #666; font-style: italic;">Nenhum estudante registrado</p>'}
                                    </div>
                                    
                                    <!-- Bot√µes para gerenciar estudantes -->
                                    <div style="margin-top: 15px; text-align: center;">
                                        <button type="button" class="btn btn-secondary" onclick="addNewEstudante(${index})" style="margin-right: 10px;">‚ûï Adicionar Estudante</button>
                                        <button type="button" class="btn btn-danger" onclick="removeLastEstudante(${index})">‚ûñ Remover √öltimo Estudante</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Bot√µes para gerenciar turmas -->
                        <div style="margin-top: 20px; text-align: center;">
                            <button type="button" class="btn btn-secondary" onclick="addNewTurma()" style="margin-right: 10px;">‚ûï Adicionar Nova Turma</button>
                            <button type="button" class="btn btn-danger" onclick="removeLastTurma()">‚ûñ Remover √öltima Turma</button>
                        </div>
                    `;
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    editForm += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <label for="editStudentName">Nome do Estudante:</label>
                                <input type="text" id="editStudentName" value="${record.studentName || ''}" required>
                            </div>
                            <div>
                                <label for="editAbsenceDays">Dias de Aus√™ncia:</label>
                                <input type="number" id="editAbsenceDays" value="${record.absenceDays || ''}" required>
                            </div>
                            <div>
                                <label for="editSeries">S√©rie/Turma:</label>
                                <input type="text" id="editSeries" value="${record.series || ''}" required>
                            </div>
                            <div>
                                <label for="editStatus">Status:</label>
                                <select id="editStatus" required>
                                    <option value="Pendente" ${record.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Resolvido" ${record.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                                </select>
                            </div>
                        </div>
                    `;
                }
            } else if (record.indicator === 'Aulas Previstas e Aulas Dadas') {
                // Verificar se √© o novo formato com turmas din√¢micas
                if (record.turmas && record.turmas.length > 0) {
                    editForm += `
                        <h3>Editar Turmas - Aulas Previstas e Aulas Dadas</h3>
                        <div id="editTurmasContainer">
                            ${record.turmas.map((turma, index) => `
                                <div class="edit-turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                    <h4 style="color: #495057; margin-bottom: 15px;">Turma ${index + 1}: ${turma.nome || 'N/A'}</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label>Nome da Turma:</label>
                                            <input type="text" id="editTurmaNome_${index}" value="${turma.nome || ''}" required>
                                        </div>
                                        <div>
                                            <label>Turno:</label>
                                            <select id="editTurmaTurno_${index}" required>
                                                <option value="">Selecione</option>
                                                <option value="Matutino" ${turma.turno === 'Matutino' ? 'selected' : ''}>Matutino</option>
                                                <option value="Vespertino" ${turma.turno === 'Vespertino' ? 'selected' : ''}>Vespertino</option>
                                                <option value="Noturno" ${turma.turno === 'Noturno' ? 'selected' : ''}>Noturno</option>
                                                <option value="Integral" ${turma.turno === 'Integral' ? 'selected' : ''}>Integral</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Etapa:</label>
                                            <select id="editTurmaEtapa_${index}" required>
                                                <option value="">Selecione</option>
                                                <option value="Ensino Fundamental" ${turma.etapa === 'Ensino Fundamental' ? 'selected' : ''}>Ensino Fundamental</option>
                                                <option value="Ensino M√©dio" ${turma.etapa === 'Ensino M√©dio' ? 'selected' : ''}>Ensino M√©dio</option>
                                                <option value="Ensino Fundamental e Ensino M√©dio" ${turma.etapa === 'Ensino Fundamental e Ensino M√©dio' ? 'selected' : ''}>Ensino Fundamental e Ensino M√©dio</option>
                                                <option value="EJA" ${turma.etapa === 'EJA' ? 'selected' : ''}>EJA</option>
                                                <option value="Ensino Fundamental e EJA" ${turma.etapa === 'Ensino Fundamental e EJA' ? 'selected' : ''}>Ensino Fundamental e EJA</option>
                                                <option value="Ensino M√©dio e EJA" ${turma.etapa === 'Ensino M√©dio e EJA' ? 'selected' : ''}>Ensino M√©dio e EJA</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Status:</label>
                                            <select id="editTurmaStatus_${index}" required>
                                                <option value="Em andamento" ${turma.status === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                                                <option value="Conclu√≠do" ${turma.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                                                <option value="Pendente" ${turma.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="Suspenso" ${turma.status === 'Suspenso' ? 'selected' : ''}>Suspenso</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Componentes Curriculares da Turma -->
                                    <h5 style="color: #6c757d; margin: 15px 0 10px 0;">üìö Componentes Curriculares</h5>
                                    <div id="editComponentesContainer_${index}">
                                        ${turma.componentes && turma.componentes.length > 0 ? turma.componentes.map((componente, componenteIndex) => `
                                            <div class="edit-componente-section" style="background: white; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin: 10px 0;">
                                                <h6 style="color: #495057; margin-bottom: 10px;">üìñ Componente ${componenteIndex + 1}: ${componente.nome}</h6>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                                    <div>
                                                        <label>Nome do Componente:</label>
                                                        <input type="text" id="editComponenteNome_${index}_${componenteIndex}" value="${componente.nome || ''}" required>
                                                    </div>
                                                    <div>
                                                        <label>Aulas Previstas:</label>
                                                        <input type="number" id="editComponenteAulasPrevistas_${index}_${componenteIndex}" value="${componente.aulasPrevistas || 0}" min="0" required>
                                                    </div>
                                                    <div>
                                                        <label>Aulas Dadas:</label>
                                                        <input type="number" id="editComponenteAulasDadas_${index}_${componenteIndex}" value="${componente.aulasDadas || 0}" min="0" required>
                                                    </div>
                                                    <div>
                                                        <label>Motivo (se houver):</label>
                                                        <select id="editComponenteMotivo_${index}_${componenteIndex}">
                                                            <option value="">Nenhum</option>
                                                            <option value="Aus√™ncia do Professor" ${componente.motivo === 'Aus√™ncia do Professor' ? 'selected' : ''}>Aus√™ncia do Professor</option>
                                                            <option value="Evento Escolar" ${componente.motivo === 'Evento Escolar' ? 'selected' : ''}>Evento Escolar</option>
                                                            <option value="Feriado" ${componente.motivo === 'Feriado' ? 'selected' : ''}>Feriado</option>
                                                            <option value="Greve" ${componente.motivo === 'Greve' ? 'selected' : ''}>Greve</option>
                                                            <option value="SGE Indispon√≠vel" ${componente.motivo === 'SGE Indispon√≠vel' ? 'selected' : ''}>SGE Indispon√≠vel</option>
                                                            <option value="Professor n√£o Lan√ßou" ${componente.motivo === 'Professor n√£o Lan√ßou' ? 'selected' : ''}>Professor n√£o Lan√ßou</option>
                                                            <option value="Outros" ${componente.motivo === 'Outros' ? 'selected' : ''}>Outros</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('') : '<p style="color: #666; font-style: italic;">Nenhum componente curricular registrado</p>'}
                                    </div>
                                    
                                    <!-- Bot√µes para gerenciar componentes -->
                                    <div style="margin-top: 15px; text-align: center;">
                                        <button type="button" class="btn btn-secondary" onclick="addNewComponente(${index})" style="margin-right: 10px;">‚ûï Adicionar Componente</button>
                                        <button type="button" class="btn btn-danger" onclick="removeLastComponente(${index})">‚ûñ Remover √öltimo Componente</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Bot√µes para gerenciar turmas -->
                        <div style="margin-top: 20px; text-align: center;">
                            <button type="button" class="btn btn-secondary" onclick="addNewTurma()" style="margin-right: 10px;">‚ûï Adicionar Nova Turma</button>
                            <button type="button" class="btn btn-danger" onclick="removeLastTurma()">‚ûñ Remover √öltima Turma</button>
                        </div>
                    `;
                } else {
                    // FORMATO ANTIGO para compatibilidade
                    editForm += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <label for="editPlannedClasses">Aulas Previstas:</label>
                                <input type="number" id="editPlannedClasses" value="${record.plannedClasses || ''}" required>
                            </div>
                            <div>
                                <label for="editGivenClasses">Aulas Dadas:</label>
                                <input type="number" id="editGivenClasses" value="${record.givenClasses || ''}" required>
                            </div>
                            <div>
                                <label for="editSeries">S√©rie/Turma:</label>
                                <input type="text" id="editSeries" value="${record.series || ''}" required>
                            </div>
                            <div>
                                <label for="editStatus">Status:</label>
                                <select id="editStatus" required>
                                    <option value="Em andamento" ${record.status === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                                    <option value="Conclu√≠do" ${record.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                                    <option value="Pendente" ${record.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Suspenso" ${record.status === 'Suspenso' ? 'selected' : ''}>Suspenso</option>
                                </select>
                            </div>
                        </div>
                    `;
                }
            }

            // Campos comuns para todos os tipos de registro
            editForm += `
                <!-- Observa√ß√µes -->
                <div style="margin-top: 20px;">
                    <label for="editObservations">Observa√ß√µes:</label>
                    <textarea id="editObservations" rows="4" placeholder="Digite suas observa√ß√µes...">${record.observations || ''}</textarea>
                </div>
                
                <!-- Anexos -->
                <div style="margin-top: 15px;">
                    <label>Anexos:</label>
                    ${record.attachments && record.attachments.length > 0 ? 
                        `<div class="attachments-section">
                            ${record.attachments.map(attachment => {
                                const fileIcon = getFileIcon(attachment.type);
                                return `<div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                                    <span style="margin-right: 8px;">${fileIcon}</span>
                                    <a href="${attachment.downloadURL}" target="_blank" style="color: #007bff; text-decoration: none;">${attachment.name}</a>
                                    <small style="color: #666; margin-left: 8px;">(${(attachment.size / 1024).toFixed(1)} KB)</small>
                                </div>`;
                            }).join('')}
                        </div>
                        <small style="color: #666; font-size: 12px;">Os anexos n√£o podem ser editados. Para adicionar novos anexos, crie um novo registro.</small>` 
                        : 
                        `<p style="color: #666; font-style: italic;">Nenhum anexo encontrado</p>`
                    }
                </div>
                
                <div class="edit-actions">
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    `;

            modalBody.innerHTML = editForm;

            // Adicionar event listener para o formul√°rio
            const form = document.getElementById('editRecordForm');
            if (form) {
                form.addEventListener('submit', saveRecordChanges);
                console.log('Event listener adicionado ao formul√°rio');
            } else {
                console.error('Formul√°rio n√£o encontrado!');
            }
        }

        // Fun√ß√£o para salvar altera√ß√µes do registro
        async function saveRecordChanges(event) {
            console.log('saveRecordChanges chamada');
            event.preventDefault();
            
            if (!currentEditingRecord) {
                alert('Nenhum registro selecionado para edi√ß√£o!');
                return;
            }

            try {
                const recordId = currentEditingRecord.id;
                const updateData = {
                    school: document.getElementById('editSchool').value,
                    municipality: document.getElementById('editMunicipality').value,
                    technician: document.getElementById('editTechnician').value,
                    date: document.getElementById('editDate').value,
                    observations: document.getElementById('editObservations').value,
                    // documentLinks removido - anexos n√£o podem ser editados
                    updatedAt: serverTimestamp(),
                    updatedBy: localStorage.getItem('userCPF') || 'Usu√°rio n√£o identificado',
                    updatedByRole: localStorage.getItem('userRole') || 'N/A',
                    updatedByName: localStorage.getItem('userName') || 'N/A'
                };

                // Adicionar campos espec√≠ficos baseados no indicador
                if (currentEditingRecord.indicator === 'Frequ√™ncia dos Estudantes') {
                    if (currentEditingRecord.department === 'Supervis√£o') {
                        // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                        if (currentEditingRecord.turmas && currentEditingRecord.turmas.length > 0) {
                            // Capturar dados das turmas editadas
                            const turmasEditadas = [];
                            for (let i = 0; i < currentEditingRecord.turmas.length; i++) {
                                const turma = currentEditingRecord.turmas[i];
                                const turmaEditada = {
                                    id: turma.id,
                                    nome: document.getElementById(`editTurmaNome_${i}`).value,
                                    totalEstudantes: parseInt(document.getElementById(`editTurmaTotalEstudantes_${i}`).value) || 0,
                                    etapa: document.getElementById(`editTurmaEtapa_${i}`).value,
                                    status: document.getElementById(`editTurmaStatus_${i}`).value,
                                    bimestres: []
                                };
                                
                                // Capturar bimestres selecionados para esta turma
                                if (document.getElementById(`editTurmaBimestre1_${i}`).checked) turmaEditada.bimestres.push('1¬∫ Bimestre');
                                if (document.getElementById(`editTurmaBimestre2_${i}`).checked) turmaEditada.bimestres.push('2¬∫ Bimestre');
                                if (document.getElementById(`editTurmaBimestre3_${i}`).checked) turmaEditada.bimestres.push('3¬∫ Bimestre');
                                if (document.getElementById(`editTurmaBimestre4_${i}`).checked) turmaEditada.bimestres.push('4¬∫ Bimestre');
                                
                                turmasEditadas.push(turmaEditada);
                            }
                            updateData.turmas = turmasEditadas;
                        } else {
                            // FORMATO ANTIGO para compatibilidade
                            // Capturar bimestres selecionados
                            const selectedBimesters = [];
                            if (document.getElementById('editBimester1').checked) selectedBimesters.push('1¬∫ Bimestre');
                            if (document.getElementById('editBimester2').checked) selectedBimesters.push('2¬∫ Bimestre');
                            if (document.getElementById('editBimester3').checked) selectedBimesters.push('3¬∫ Bimestre');
                            if (document.getElementById('editBimester4').checked) selectedBimesters.push('4¬∫ Bimestre');
                            updateData.selectedBimesters = selectedBimesters;
                            
                            updateData.totalStudents = parseInt(document.getElementById('editTotalStudents').value);
                            updateData.etapa = document.getElementById('editEtapa').value;
                            updateData.turmaId = document.getElementById('editTurmaId').value;
                            updateData.status = document.getElementById('editStatus').value;
                        }
                    } else {
                        // Verificar se √© o novo formato com turmas din√¢micas
                        if (currentEditingRecord.turmas && currentEditingRecord.turmas.length > 0) {
                            // Capturar dados das turmas editadas
                            const turmasEditadas = [];
                            for (let i = 0; i < currentEditingRecord.turmas.length; i++) {
                                const turma = currentEditingRecord.turmas[i];
                                const turmaEditada = {
                                    id: turma.id,
                                    nome: document.getElementById(`editTurmaNome_${i}`).value,
                                    totalEstudantes: parseInt(document.getElementById(`editTurmaTotalEstudantes_${i}`).value) || 0,
                                    estudantesFrequenciaBaixa: parseInt(document.getElementById(`editTurmaEstudantesFrequenciaBaixa_${i}`).value) || 0,
                                    etapa: document.getElementById(`editTurmaEtapa_${i}`).value,
                                    status: document.getElementById(`editTurmaStatus_${i}`).value,
                                    bimestres: []
                                };
                                
                                // Capturar bimestres selecionados para esta turma
                                if (document.getElementById(`editTurmaBimestre1_${i}`).checked) turmaEditada.bimestres.push('1¬∫ Bimestre');
                                if (document.getElementById(`editTurmaBimestre2_${i}`).checked) turmaEditada.bimestres.push('2¬∫ Bimestre');
                                if (document.getElementById(`editTurmaBimestre3_${i}`).checked) turmaEditada.bimestres.push('3¬∫ Bimestre');
                                if (document.getElementById(`editTurmaBimestre4_${i}`).checked) turmaEditada.bimestres.push('4¬∫ Bimestre');
                                
                                turmasEditadas.push(turmaEditada);
                            }
                            updateData.turmas = turmasEditadas;
                            
                            // Atualizar status geral baseado nas turmas
                            if (turmasEditadas.every(t => t.status === 'Resolvido')) {
                                updateData.status = 'Resolvido';
                            } else {
                                updateData.status = 'Pendente';
                            }
                        } else {
                            // FORMATO ANTIGO para compatibilidade
                            // Capturar bimestres selecionados
                            const selectedBimesters = [];
                            if (document.getElementById('editBimester1').checked) selectedBimesters.push('1¬∫ Bimestre');
                            if (document.getElementById('editBimester2').checked) selectedBimesters.push('2¬∫ Bimestre');
                            if (document.getElementById('editBimester3').checked) selectedBimesters.push('3¬∫ Bimestre');
                            if (document.getElementById('editBimester4').checked) selectedBimesters.push('4¬∫ Bimestre');
                            updateData.selectedBimesters = selectedBimesters;
                            
                            updateData.studentName = document.getElementById('editStudentName').value;
                            updateData.totalAbsences = parseInt(document.getElementById('editAbsences').value);
                            updateData.etapa = document.getElementById('editEtapa').value;
                            updateData.turmaId = document.getElementById('editTurmaId').value;
                            updateData.status = document.getElementById('editStatus').value;
                        }
                    }
                } else if (currentEditingRecord.indicator === 'Estudantes Abaixo da M√©dia') {
                    // Verificar se √© o novo formato com turmas din√¢micas
                    if (currentEditingRecord.turmas && currentEditingRecord.turmas.length > 0) {
                        // Capturar dados das turmas editadas
                        const turmasEditadas = [];
                        for (let i = 0; i < currentEditingRecord.turmas.length; i++) {
                            const turma = currentEditingRecord.turmas[i];
                            const turmaEditada = {
                                id: turma.id,
                                nome: document.getElementById(`editTurmaNome_${i}`).value,
                                numeroEstudantes: parseInt(document.getElementById(`editTurmaNumeroEstudantes_${i}`).value) || 0,
                                componentesCurriculares: document.getElementById(`editTurmaComponentesCurriculares_${i}`).value,
                                componentesDetalhados: document.getElementById(`editTurmaComponentesDetalhados_${i}`).value,
                                situacao: document.getElementById(`editTurmaSituacao_${i}`).value,
                                etapa: document.getElementById(`editTurmaEtapa_${i}`).value
                            };
                            
                            turmasEditadas.push(turmaEditada);
                        }
                        updateData.turmas = turmasEditadas;
                        
                        // Atualizar status geral baseado nas turmas
                        if (turmasEditadas.every(t => t.situacao === 'Resolvido')) {
                            updateData.status = 'Resolvido';
                        } else {
                            updateData.status = 'Pendente';
                        }
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        updateData.studentName = document.getElementById('editStudentName').value;
                        updateData.grade = parseFloat(document.getElementById('editGrade').value);
                        updateData.series = document.getElementById('editSeries').value;
                        updateData.status = document.getElementById('editStatus').value;
                        updateData.curricularComponents = parseInt(document.getElementById('editCurricularComponents').value);
                        
                        // Capturar disciplinas selecionadas
                        const subjects = {
                            portuguese: document.getElementById('editPortuguese').checked,
                            mathematics: document.getElementById('editMathematics').checked,
                            history: document.getElementById('editHistory').checked,
                            geography: document.getElementById('editGeography').checked,
                            science: document.getElementById('editScience').checked,
                            physicalEducation: document.getElementById('editPhysicalEducation').checked,
                            arts: document.getElementById('editArts').checked,
                            english: document.getElementById('editEnglish').checked,
                            philosophy: document.getElementById('editPhilosophy').checked,
                            sociology: document.getElementById('editSociology').checked,
                            biology: document.getElementById('editBiology').checked,
                            physics: document.getElementById('editPhysics').checked,
                            chemistry: document.getElementById('editChemistry').checked,
                            literature: document.getElementById('editLiterature').checked,
                            spanish: document.getElementById('editSpanish').checked,
                            others: document.getElementById('editOthers').checked,
                            otherSubjects: document.getElementById('editOtherSubjects').value
                        };
                        updateData.subjects = subjects;
                    }
                } else if (currentEditingRecord.indicator === 'Busca Ativa') {
                    // Verificar se √© o novo formato com turmas din√¢micas
                    if (currentEditingRecord.turmas && currentEditingRecord.turmas.length > 0) {
                        // Capturar dados das turmas editadas
                        const turmasEditadas = [];
                        for (let i = 0; i < currentEditingRecord.turmas.length; i++) {
                            const turma = currentEditingRecord.turmas[i];
                            const turmaEditada = {
                                id: turma.id,
                                nome: document.getElementById(`editTurmaNome_${i}`).value,
                                totalEstudantes: parseInt(document.getElementById(`editTurmaTotalEstudantes_${i}`).value) || 0,
                                etapa: document.getElementById(`editTurmaEtapa_${i}`).value,
                                status: document.getElementById(`editTurmaStatus_${i}`).value,
                                bimestres: []
                            };
                            
                            // Capturar bimestres selecionados para esta turma
                            if (document.getElementById(`editTurmaBimestre1_${i}`).checked) turmaEditada.bimestres.push('1¬∫ Bimestre');
                            if (document.getElementById(`editTurmaBimestre2_${i}`).checked) turmaEditada.bimestres.push('2¬∫ Bimestre');
                            if (document.getElementById(`editTurmaBimestre3_${i}`).checked) turmaEditada.bimestres.push('3¬∫ Bimestre');
                            if (document.getElementById(`editTurmaBimestre4_${i}`).checked) turmaEditada.bimestres.push('4¬∫ Bimestre');
                            
                            // Capturar estudantes da turma
                            if (turma.estudantes && turma.estudantes.length > 0) {
                                const estudantesEditados = [];
                                for (let j = 0; j < turma.estudantes.length; j++) {
                                    const estudante = turma.estudantes[j];
                                    const estudanteEditado = {
                                        id: estudante.id,
                                        nome: document.getElementById(`editEstudanteNome_${i}_${j}`).value,
                                        faltas: parseInt(document.getElementById(`editEstudanteFaltas_${i}_${j}`).value) || 0,
                                        pcd: document.getElementById(`editEstudantePCD_${i}_${j}`).checked,
                                        ministerioPublico: document.getElementById(`editEstudanteMinisterioPublico_${i}_${j}`).checked,
                                        menorIdade: document.getElementById(`editEstudanteMenorIdade_${i}_${j}`).checked,
                                        atestadoMedico: document.getElementById(`editEstudanteAtestadoMedico_${i}_${j}`).checked
                                    };
                                    estudantesEditados.push(estudanteEditado);
                                }
                                turmaEditada.estudantes = estudantesEditados;
                            }
                            
                            turmasEditadas.push(turmaEditada);
                        }
                        updateData.turmas = turmasEditadas;
                        
                        // Atualizar status geral baseado nas turmas
                        if (turmasEditadas.every(t => t.status === 'Resolvido')) {
                            updateData.status = 'Resolvido';
                        } else {
                            updateData.status = 'Pendente';
                        }
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        updateData.studentName = document.getElementById('editStudentName').value;
                        updateData.absenceDays = parseInt(document.getElementById('editAbsenceDays').value);
                        updateData.series = document.getElementById('editSeries').value;
                        updateData.status = document.getElementById('editStatus').value;
                    }
                } else if (currentEditingRecord.indicator === 'Aulas Previstas e Aulas Dadas') {
                    // Verificar se √© o novo formato com turmas din√¢micas
                    if (currentEditingRecord.turmas && currentEditingRecord.turmas.length > 0) {
                        // Capturar dados das turmas editadas
                        const turmasEditadas = [];
                        for (let i = 0; i < currentEditingRecord.turmas.length; i++) {
                            const turma = currentEditingRecord.turmas[i];
                            const turmaEditada = {
                                id: turma.id,
                                nome: document.getElementById(`editTurmaNome_${i}`).value,
                                turno: document.getElementById(`editTurmaTurno_${i}`).value,
                                etapa: document.getElementById(`editTurmaEtapa_${i}`).value,
                                status: document.getElementById(`editTurmaStatus_${i}`).value,
                                componentes: []
                            };
                            
                            // Capturar componentes curriculares da turma
                            if (turma.componentes && turma.componentes.length > 0) {
                                const componentesEditados = [];
                                for (let j = 0; j < turma.componentes.length; j++) {
                                    const componente = turma.componentes[j];
                                    const componenteEditado = {
                                        id: componente.id,
                                        nome: document.getElementById(`editComponenteNome_${i}_${j}`).value,
                                        aulasPrevistas: parseInt(document.getElementById(`editComponenteAulasPrevistas_${i}_${j}`).value) || 0,
                                        aulasDadas: parseInt(document.getElementById(`editComponenteAulasDadas_${i}_${j}`).value) || 0,
                                        motivo: document.getElementById(`editComponenteMotivo_${i}_${j}`).value
                                    };
                                    componentesEditados.push(componenteEditado);
                                }
                                turmaEditada.componentes = componentesEditados;
                            }
                            
                            turmasEditadas.push(turmaEditada);
                        }
                        updateData.turmas = turmasEditadas;
                        
                        // Atualizar status geral baseado nas turmas
                        if (turmasEditadas.every(t => t.status === 'Conclu√≠do')) {
                            updateData.status = 'Conclu√≠do';
                        } else if (turmasEditadas.some(t => t.status === 'Suspenso')) {
                            updateData.status = 'Suspenso';
                        } else if (turmasEditadas.some(t => t.status === 'Em andamento')) {
                            updateData.status = 'Em andamento';
                        } else {
                            updateData.status = 'Pendente';
                        }
                    } else {
                        // FORMATO ANTIGO para compatibilidade
                        updateData.plannedClasses = parseInt(document.getElementById('editPlannedClasses').value);
                        updateData.givenClasses = parseInt(document.getElementById('editGivenClasses').value);
                        updateData.series = document.getElementById('editSeries').value;
                        updateData.status = document.getElementById('editStatus').value;
                    }
                }

                // Atualizar no Firebase
                await updateDoc(doc(db, 'records', recordId), updateData);
                
                alert('Registro atualizado com sucesso!');
                
                // Fechar modal e recarregar registros
                closeModal();
                await loadAllRecords();
                
            } catch (error) {
                console.error('Erro ao salvar altera√ß√µes:', error);
                alert('Erro ao salvar altera√ß√µes: ' + error.message);
            }
        }

        // Fun√ß√£o para cancelar edi√ß√£o
        function cancelEdit() {
            if (currentEditingRecord) {
                viewRecord(currentEditingRecord.id); // Volta para a visualiza√ß√£o
            }
        }

        // Fun√ß√£o para editar registro diretamente da lista (vers√£o do m√≥dulo)
        async function editRecordFromModule(recordId) {
            console.log('editRecordFromModule chamada com ID:', recordId);
            
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                alert('Registro n√£o encontrado!');
                return;
            }

            console.log('Registro encontrado:', record);

            // Armazenar o registro atual e abrir modal de edi√ß√£o
            currentEditingRecord = record;
            
            // Abrir modal
            const modal = document.getElementById('viewModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal aberto');
            } else {
                console.error('Modal n√£o encontrado!');
                alert('Erro: Modal n√£o encontrado!');
                return;
            }
            
            // Chamar fun√ß√£o de edi√ß√£o
            try {
                await editRecord();
                console.log('Fun√ß√£o editRecord executada com sucesso');
            } catch (error) {
                console.error('Erro ao executar editRecord:', error);
                alert('Erro ao abrir formul√°rio de edi√ß√£o: ' + error.message);
            }
        }

        // Tornar fun√ß√£o dispon√≠vel globalmente
        window.editRecordFromModule = editRecordFromModule;
        
        // Atualizar a vari√°vel global sempre que currentEditingRecord mudar
        Object.defineProperty(window, 'currentEditingRecord', {
            get: function() {
                return currentEditingRecord;
            },
            set: function(value) {
                currentEditingRecord = value;
            }
        });





        // Download Excel com m√∫ltiplas abas organizadas
        async function downloadExcel() {
            if (filteredRecords.length === 0) {
                alert('Nenhum registro para exportar!');
                return;
            }

            try {
                // Carregar a biblioteca SheetJS
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    // Separar registros por departamento
                    const curriculumRecords = filteredRecords.filter(record => record.department === 'Curr√≠culo');
                    const multiprofessionalRecords = filteredRecords.filter(record => record.department === 'Equipe Multiprofissional');
                    const supervisionRecords = filteredRecords.filter(record => record.department === 'Supervis√£o');

                    // Criar workbook com m√∫ltiplas abas
                    const workbook = XLSX.utils.book_new();

                    // Aba 1: Curr√≠culo
                    if (curriculumRecords.length > 0) {
                        const curriculumData = curriculumRecords.map(record => {
                            // Base comum para todos os registros
                            const baseData = {
                                'Departamento': record.department,
                                'Indicador': record.indicator,
                                'Escola': record.school,
                                'Munic√≠pio': record.municipality,
                                'T√©cnico': record.technician,
                                'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                                'Observa√ß√µes': record.observations || 'N/A'
                            };

                            // Dados espec√≠ficos por indicador
                            if (record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Curr√≠culo') {
                                // SEMPRE NOVO FORMATO para Curr√≠culo
                                return {
                                    ...baseData,
                                    'Bimestre': record.bimester || 'N/A',
                                    'N√∫mero de Turmas': record.turmas ? record.turmas.length : 0,
                                    'Situa√ß√£o Geral': record.studentSituation || 'N/A',
                                    'Turmas': record.turmas ? record.turmas.map(t => t.nome).join('; ') : 'N/A',
                                    'Estudantes': record.turmas ? record.turmas.map(t => t.estudantes).join('; ') : 'N/A',
                                    'Componentes por Turma': record.turmas ? record.turmas.map(t => t.componentesCurriculares).join('; ') : 'N/A',
                                    'Componentes Detalhados': record.turmas ? record.turmas.map(t => t.componentesDetalhados).join('; ') : 'N/A'
                                };
                            } else if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                                // FORMATO ANTIGO para outros departamentos
                                return {
                                    ...baseData,
                                    'Estudante': record.studentName || 'N/A',
                                    'Nota': record.studentGrade || 'N/A',
                                    'Situa√ß√£o Estudante': record.studentSituation || 'N/A',
                                    'S√©rie/Turma': record.seriesClass || 'N/A',
                                    'Componentes Curriculares Abaixo da M√©dia': record.curricularComponents || 'N/A',
                                    'L√≠ngua Portuguesa': record.subjects?.portuguese ? 'Sim' : 'N√£o',
                                    'Matem√°tica': record.subjects?.mathematics ? 'Sim' : 'N√£o',
                                    'Hist√≥ria': record.subjects?.history ? 'Sim' : 'N√£o',
                                    'Geografia': record.subjects?.geography ? 'Sim' : 'N√£o',
                                    'Ci√™ncias': record.subjects?.science ? 'Sim' : 'N√£o',
                                    'Educa√ß√£o F√≠sica': record.subjects?.physicalEducation ? 'Sim' : 'N√£o',
                                    'Arte': record.subjects?.arts ? 'Sim' : 'N√£o',
                                    'Ingl√™s': record.subjects?.english ? 'Sim' : 'N√£o',
                                    'Filosofia': record.subjects?.philosophy ? 'Sim' : 'N√£o',
                                    'Sociologia': record.subjects?.sociology ? 'Sim' : 'N√£o',
                                    'Biologia': record.subjects?.biology ? 'Sim' : 'N√£o',
                                    'F√≠sica': record.subjects?.physics ? 'Sim' : 'N√£o',
                                    'Qu√≠mica': record.subjects?.chemistry ? 'Sim' : 'N√£o',
                                    'Literatura': record.subjects?.literature ? 'Sim' : 'N√£o',
                                    'Espanhol': record.subjects?.spanish ? 'Sim' : 'N√£o',
                                    'Outros': record.subjects?.others ? 'Sim' : 'N√£o',
                                    'Especifica√ß√£o de Outros': record.subjects?.otherSubjects || 'N/A'
                                };
                            } else if (record.indicator === 'Frequ√™ncia dos Estudantes' && record.department === 'Curr√≠culo') {
                                // NOVO FORMATO para Curr√≠culo com turmas din√¢micas
                                return {
                                    ...baseData,
                                    'N√∫mero de Turmas': record.turmas ? record.turmas.length : 0,
                                    'Total de Estudantes': record.turmas ? record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0) : 0,
                                    'Estudantes com Frequ√™ncia Baixa': record.turmas ? record.turmas.reduce((total, t) => total + (parseInt(t.estudantesFrequenciaBaixa) || 0), 0) : 0,
                                    'Turmas': record.turmas ? record.turmas.map(t => t.nome).join('; ') : 'N/A',
                                    'Total por Turma': record.turmas ? record.turmas.map(t => t.totalEstudantes).join('; ') : 'N/A',
                                    'Frequ√™ncia Baixa por Turma': record.turmas ? record.turmas.map(t => t.estudantesFrequenciaBaixa).join('; ') : 'N/A',
                                    'Etapas por Turma': record.turmas ? record.turmas.map(t => t.etapa).join('; ') : 'N/A',
                                    'Bimestres por Turma': record.turmas ? record.turmas.map(t => t.bimestres && t.bimestres.length > 0 ? t.bimestres.join(', ') : 'N/A').join('; ') : 'N/A'
                                };
                            } else {
                                // Outros indicadores
                                return {
                                    ...baseData,
                                    'Estudante': record.department === 'Supervis√£o' ? 'N/A' : (record.studentName || 'N/A'),
                                    'N¬∫ de Faltas': record.department === 'Supervis√£o' ? 'N/A' : (record.totalAbsences || record.consecutiveAbsences || 'N/A'),
                                    'Total de Estudantes': record.department === 'Supervis√£o' ? (record.totalStudents || 'N/A') : 'N/A',
                                    'Bimestres': record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A',
                                    'Etapa': record.etapa || 'N/A',
                                    'ID Turma': record.turmaId || 'N/A',
                                    'Data Refer√™ncia': record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A',
                                    'ID Turma': record.classId || 'N/A',
                                    'Nome Turma': record.className || 'N/A',
                                    'Disciplina': record.discipline || 'N/A',
                                    'Per√≠odo Inicial': record.periodStart ? new Date(record.periodStart).toLocaleDateString('pt-BR') : 'N/A',
                                    'Per√≠odo Final': record.periodEnd ? new Date(record.periodEnd).toLocaleDateString('pt-BR') : 'N/A',
                                    'Professor': record.professorName || 'N/A',
                                    'Bimestre': record.bimester || 'N/A',
                                    'Situa√ß√£o': record.situation || 'N/A',
                                    'Falta Docente': record.teacherAbsence ? 'Sim' : 'N√£o',
                                    'Evento Escolar': record.schoolEvent ? 'Sim' : 'N√£o',
                                    'Feriado': record.holiday ? 'Sim' : 'N√£o',
                                    'Greve': record.strike ? 'Sim' : 'N√£o',
                                    'Indisponibilidade SGE': record.sgeUnavailable ? 'Sim' : 'N√£o',
                                    'N√£o Lan√ßamento SGE': record.professorNotLaunched ? 'Sim' : 'N√£o',
                                    'Outros': record.others ? 'Sim' : 'N√£o',
                                    'Faltas': record.absences || 'N/A',
                                    'Total Visitas': record.totalVisits || 'N/A',
                                    'PCD': record.pcd ? 'Sim' : 'N√£o',
                                    'Minist√©rio P√∫blico': record.ministerioPublico ? 'Sim' : 'N√£o',
                                    'Menor de Idade': record.menorIdade ? 'Sim' : 'N√£o',
                                    'Atestado M√©dico': record.atestadoMedico ? 'Sim' : 'N√£o',
                                    'Conselho Tutelar': record.conselhoTutelar ? 'Sim' : 'N√£o'
                                };
                            }
                        });

                        const curriculumSheet = XLSX.utils.json_to_sheet(curriculumData);
                        XLSX.utils.book_append_sheet(workbook, curriculumSheet, 'Curr√≠culo');
                    }

                    // Aba 2: Equipe Multiprofissional
                    if (multiprofessionalRecords.length > 0) {
                        const multiprofessionalData = multiprofessionalRecords.map(record => {
                            // Base comum para todos os registros
                            const baseData = {
                                'Departamento': record.department,
                                'Indicador': record.indicator,
                                'Escola': record.school,
                                'Munic√≠pio': record.municipality,
                                'T√©cnico': record.technician,
                                'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                                'Observa√ß√µes': record.observations || 'N/A'
                            };

                            // Dados espec√≠ficos por indicador
                            if (record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Equipe Multiprofissional') {
                                // NOVO FORMATO para Equipe Multiprofissional com turmas din√¢micas
                                if (record.turmas && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'Status Geral': record.turmas.some(t => t.situacao === 'Resolvido') ? 'Resolvido' : 'Pendente',
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Estudantes': record.turmas.reduce((total, t) => total + (parseInt(t.numeroEstudantes) || 0), 0),
                                        'Turmas': record.turmas.map(t => t.nome).join('; '),
                                        'N√∫mero de Estudantes por Turma': record.turmas.map(t => t.numeroEstudantes).join('; '),
                                        'Componentes Curriculares por Turma': record.turmas.map(t => t.componentesCurriculares).join('; '),
                                        'Situa√ß√£o por Turma': record.turmas.map(t => t.situacao).join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Estudante': record.studentName || 'N/A',
                                        'Nota': record.studentGrade || 'N/A',
                                        'Situa√ß√£o Estudante': record.studentSituation || 'N/A',
                                        'S√©rie/Turma': record.seriesClass || 'N/A',
                                        'Componentes Curriculares Abaixo da M√©dia': record.curricularComponents || 'N/A',
                                        'L√≠ngua Portuguesa': record.subjects?.portuguese ? 'Sim' : 'N√£o',
                                        'Matem√°tica': record.subjects?.mathematics ? 'Sim' : 'N√£o',
                                        'Hist√≥ria': record.subjects?.history ? 'Sim' : 'N√£o',
                                        'Geografia': record.subjects?.geography ? 'Sim' : 'N√£o',
                                        'Ci√™ncias': record.subjects?.science ? 'Sim' : 'N√£o',
                                        'Educa√ß√£o F√≠sica': record.subjects?.physicalEducation ? 'Sim' : 'N√£o',
                                        'Arte': record.subjects?.arts ? 'Sim' : 'N√£o',
                                        'Ingl√™s': record.subjects?.english ? 'Sim' : 'N√£o',
                                        'Filosofia': record.subjects?.philosophy ? 'Sim' : 'N√£o',
                                        'Sociologia': record.subjects?.sociology ? 'Sim' : 'N√£o',
                                        'Biologia': record.subjects?.biology ? 'Sim' : 'N√£o',
                                        'F√≠sica': record.subjects?.physics ? 'Sim' : 'N√£o',
                                        'Qu√≠mica': record.subjects?.chemistry ? 'Sim' : 'N√£o',
                                        'Literatura': record.subjects?.literature ? 'Sim' : 'N√£o',
                                        'Espanhol': record.subjects?.spanish ? 'Sim' : 'N√£o',
                                        'Outros': record.subjects?.others ? 'Sim' : 'N√£o',
                                        'Especifica√ß√£o de Outros': record.subjects?.otherSubjects || 'N/A'
                                    };
                                }
                            } else if (record.indicator === 'Frequ√™ncia dos Estudantes' && record.department === 'Equipe Multiprofissional') {
                                // NOVO FORMATO para Equipe Multiprofissional com turmas din√¢micas
                                if (record.turmas && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'Status Geral': record.turmas.some(t => t.status === 'Pendente') ? 'Com Pend√™ncias' : 'Todas Resolvidas',
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Estudantes Infrequentes': record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0),
                                        'Turmas': record.turmas.map(t => t.nome).join('; '),
                                        'Total por Turma': record.turmas.map(t => t.totalEstudantes).join('; '),
                                        'Estudantes com Frequ√™ncia Baixa por Turma': record.turmas.map(t => t.estudantesFrequenciaBaixa).join('; '),
                                        'Etapas por Turma': record.turmas.map(t => t.etapa).filter(Boolean).join('; '),
                                        'Status por Turma': record.turmas.map(t => t.status).join('; '),
                                        'Bimestres por Turma': record.turmas.map(t => t.bimestres && t.bimestres.length > 0 ? t.bimestres.join(', ') : 'N/A').join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Total de Estudantes': record.totalStudents || 'N/A',
                                        'Bimestres': record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A',
                                        'Etapa': record.etapa || 'N/A',
                                        'ID Turma': record.turmaId || 'N/A',
                                        'Status': record.status || 'N/A'
                                    };
                                }
                            } else if (record.indicator === 'Busca Ativa' && record.department === 'Equipe Multiprofissional') {
                                // NOVO FORMATO para Busca Ativa com turmas din√¢micas
                                if (record.turmas && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'Status Geral': record.turmas.some(t => t.estudantes.some(e => e.pcd || e.ministerioPublico || e.menorIdade || e.atestadoMedico || e.conselhoTutelar)) ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes',
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Estudantes': record.turmas.reduce((total, t) => total + t.estudantes.length, 0),
                                        'Total de Faltas': record.turmas.reduce((total, t) => total + t.estudantes.reduce((subTotal, e) => subTotal + (parseInt(e.faltas) || 0), 0), 0),
                                        'Total de Visitas': record.turmas.reduce((total, t) => total + t.estudantes.reduce((subTotal, e) => subTotal + ((e.visit1 ? 1 : 0) + (e.visit2 ? 1 : 0) + (e.visit3 ? 1 : 0)), 0), 0),
                                        'Turmas': record.turmas.map(t => t.nome).join('; '),
                                        'Estudantes por Turma': record.turmas.map(t => t.estudantes.length).join('; '),
                                        'Faltas por Turma': record.turmas.map(t => t.estudantes.reduce((total, e) => total + (parseInt(e.faltas) || 0), 0)).join('; '),
                                        'Visitas por Turma': record.turmas.map(t => t.estudantes.reduce((total, e) => total + ((e.visit1 ? 1 : 0) + (e.visit2 ? 1 : 0) + (e.visit3 ? 1 : 0)), 0)).join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Status': record.pcd || record.ministerioPublico || record.menorIdade || record.atestadoMedico || record.conselhoTutelar ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes',
                                        'Estudante': record.studentName || 'N/A',
                                        'Faltas': record.absences || 'N/A',
                                        'Total Visitas': record.totalVisits || 'N/A',
                                        'PCD': record.pcd ? 'Sim' : 'N√£o',
                                        'Minist√©rio P√∫blico': record.ministerioPublico ? 'Sim' : 'N√£o',
                                        'Menor de Idade': record.menorIdade ? 'Sim' : 'N√£o',
                                        'Atestado M√©dico': record.atestadoMedico ? 'Sim' : 'N√£o',
                                        'Conselho Tutelar': record.conselhoTutelar ? 'Sim' : 'N√£o'
                                    };
                                }
                            } else {
                                // Outros indicadores da Equipe Multiprofissional (formato antigo)
                                return {
                                    ...baseData,
                                    'Estudante': record.studentName || 'N/A',
                                    'N¬∫ de Faltas': record.totalAbsences || record.consecutiveAbsences || 'N/A',
                                    'Total de Estudantes': record.totalStudents || 'N/A',
                                    'Bimestres': record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A',
                                    'Etapa': record.etapa || 'N/A',
                                    'ID Turma': record.turmaId || 'N/A',
                                    'Data Refer√™ncia': record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A',
                                    'ID Turma': record.classId || 'N/A',
                                    'Nome Turma': record.className || 'N/A',
                                    'Disciplina': record.discipline || 'N/A',
                                    'Per√≠odo Inicial': record.periodStart ? new Date(record.periodStart).toLocaleDateString('pt-BR') : 'N/A',
                                    'Per√≠odo Final': record.periodEnd ? new Date(record.periodEnd).toLocaleDateString('pt-BR') : 'N/A',
                                    'Professor': record.professorName || 'N/A',
                                    'Bimestre': record.bimester || 'N/A',
                                    'Situa√ß√£o': record.situation || 'N/A',
                                    'Falta Docente': record.teacherAbsence ? 'Sim' : 'N√£o',
                                    'Evento Escolar': record.schoolEvent ? 'Sim' : 'N√£o',
                                    'Feriado': record.holiday ? 'Sim' : 'N√£o',
                                    'Greve': record.strike ? 'Sim' : 'N√£o',
                                    'Indisponibilidade SGE': record.sgeUnavailable ? 'Sim' : 'N√£o',
                                    'N√£o Lan√ßamento SGE': record.professorNotLaunched ? 'Sim' : 'N√£o',
                                    'Outros': record.others ? 'Sim' : 'N√£o',
                                    'Nota': record.studentGrade || 'N/A',
                                    'Situa√ß√£o Estudante': record.studentSituation || 'N/A',
                                    'S√©rie/Turma': record.seriesClass || 'N/A',
                                    'Componentes Curriculares Abaixo da M√©dia': record.curricularComponents || 'N/A',
                                    'L√≠ngua Portuguesa': record.subjects?.portuguese ? 'Sim' : 'N√£o',
                                    'Matem√°tica': record.subjects?.mathematics ? 'Sim' : 'N√£o',
                                    'Hist√≥ria': record.subjects?.history ? 'Sim' : 'N√£o',
                                    'Geografia': record.subjects?.geography ? 'Sim' : 'N√£o',
                                    'Ci√™ncias': record.subjects?.science ? 'Sim' : 'N√£o',
                                    'Educa√ß√£o F√≠sica': record.subjects?.physicalEducation ? 'Sim' : 'N√£o',
                                    'Arte': record.subjects?.arts ? 'Sim' : 'N√£o',
                                    'Ingl√™s': record.subjects?.english ? 'Sim' : 'N√£o',
                                    'Filosofia': record.subjects?.philosophy ? 'Sim' : 'N√£o',
                                    'Sociologia': record.subjects?.sociology ? 'Sim' : 'N√£o',
                                    'Biologia': record.subjects?.biology ? 'Sim' : 'N√£o',
                                    'F√≠sica': record.subjects?.physics ? 'Sim' : 'N√£o',
                                    'Qu√≠mica': record.subjects?.chemistry ? 'Sim' : 'N√£o',
                                    'Literatura': record.subjects?.literature ? 'Sim' : 'N√£o',
                                    'Espanhol': record.subjects?.spanish ? 'Sim' : 'N√£o',
                                    'Outros': record.subjects?.others ? 'Sim' : 'N√£o',
                                    'Especifica√ß√£o de Outros': record.subjects?.otherSubjects || 'N/A',
                                    'Faltas': record.absences || 'N/A',
                                    'Total Visitas': record.totalVisits || 'N/A',
                                    'PCD': record.pcd ? 'Sim' : 'N√£o',
                                    'Minist√©rio P√∫blico': record.ministerioPublico ? 'Sim' : 'N√£o',
                                    'Menor de Idade': record.menorIdade ? 'Sim' : 'N√£o',
                                    'Atestado M√©dico': record.atestadoMedico ? 'Sim' : 'N√£o',
                                    'Conselho Tutelar': record.conselhoTutelar ? 'Sim' : 'N√£o'
                                };
                            }
                        });

                        const multiprofessionalSheet = XLSX.utils.json_to_sheet(multiprofessionalData);
                        XLSX.utils.book_append_sheet(workbook, multiprofessionalSheet, 'Equipe Multiprofissional');
                    }

                    // Aba 3: Supervis√£o
                    if (supervisionRecords.length > 0) {
                        const supervisionData = supervisionRecords.map(record => {
                            // Base comum para todos os registros
                            const baseData = {
                                'Departamento': record.department,
                                'Indicador': record.indicator,
                                'Escola': record.school,
                                'Munic√≠pio': record.municipality,
                                'T√©cnico': record.technician,
                                'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                                'Observa√ß√µes': record.observations || 'N/A'
                            };

                            // Dados espec√≠ficos por indicador
                            if (record.indicator === 'Frequ√™ncia dos Estudantes' && record.department === 'Supervis√£o') {
                                // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                                if (record.turmas && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Estudantes': record.turmas.reduce((total, t) => total + (parseInt(t.totalEstudantes) || 0), 0),
                                        'Status Geral': record.turmas.some(t => t.status === 'Pendente') ? 'Com Pend√™ncias' : 'Todas Resolvidas',
                                        'Turmas': record.turmas.map(t => t.nome).join('; '),
                                        'Total por Turma': record.turmas.map(t => t.totalEstudantes).join('; '),
                                        'Etapas por Turma': record.turmas.map(t => t.etapa).join('; '),
                                        'Status por Turma': record.turmas.map(t => t.status).join('; '),
                                        'Bimestres por Turma': record.turmas.map(t => t.bimestres && t.bimestres.length > 0 ? t.bimestres.join(', ') : 'N/A').join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Total de Estudantes': record.totalStudents || 'N/A',
                                        'Etapa': record.etapa || 'N/A',
                                        'ID Turma': record.turmaId || 'N/A',
                                        'Bimestres': record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A',
                                        'Status': record.status || 'N/A'
                                    };
                                }
                            } else if (record.indicator === 'Estudantes Abaixo da M√©dia' && record.department === 'Supervis√£o') {
                                // NOVO FORMATO para Supervis√£o com turmas din√¢micas
                                if (record.turmas && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'Status Geral': record.turmas.some(t => t.situacao === 'Resolvido') ? 'Resolvido' : 'Pendente',
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Estudantes': record.turmas.reduce((total, t) => total + (parseInt(t.numeroEstudantes) || 0), 0),
                                        'Turmas': record.turmas.map(t => t.nome).join('; '),
                                        'N√∫mero de Estudantes por Turma': record.turmas.map(t => t.numeroEstudantes).join('; '),
                                        'Componentes Curriculares por Turma': record.turmas.map(t => t.componentesCurriculares).join('; '),
                                        'Situa√ß√£o por Turma': record.turmas.map(t => t.situacao).join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Estudante': record.studentName || 'N/A',
                                        'Nota': record.studentGrade || 'N/A',
                                        'Situa√ß√£o Estudante': record.studentSituation || 'N/A',
                                        'S√©rie/Turma': record.seriesClass || 'N/A',
                                        'Componentes Curriculares Abaixo da M√©dia': record.curricularComponents || 'N/A',
                                        'L√≠ngua Portuguesa': record.subjects?.portuguese ? 'Sim' : 'N√£o',
                                        'Matem√°tica': record.subjects?.mathematics ? 'Sim' : 'N√£o',
                                        'Hist√≥ria': record.subjects?.history ? 'Sim' : 'N√£o',
                                        'Geografia': record.subjects?.geography ? 'Sim' : 'N√£o',
                                        'Ci√™ncias': record.subjects?.science ? 'Sim' : 'N√£o',
                                        'Educa√ß√£o F√≠sica': record.subjects?.physicalEducation ? 'Sim' : 'N√£o',
                                        'Arte': record.subjects?.arts ? 'Sim' : 'N√£o',
                                        'Ingl√™s': record.subjects?.english ? 'Sim' : 'N√£o',
                                        'Filosofia': record.subjects?.philosophy ? 'Sim' : 'N√£o',
                                        'Sociologia': record.subjects?.sociology ? 'Sim' : 'N√£o',
                                        'Biologia': record.subjects?.biology ? 'Sim' : 'N√£o',
                                        'F√≠sica': record.subjects?.physics ? 'Sim' : 'N√£o',
                                        'Qu√≠mica': record.subjects?.chemistry ? 'Sim' : 'N√£o',
                                        'Literatura': record.subjects?.literature ? 'Sim' : 'N√£o',
                                        'Espanhol': record.subjects?.spanish ? 'Sim' : 'N√£o',
                                        'Outros': record.subjects?.others ? 'Sim' : 'N√£o',
                                        'Especifica√ß√£o de Outros': record.subjects?.otherSubjects || 'N/A'
                                    };
                                }
                            } else if (record.indicator === 'Aulas Previstas e Aulas Dadas' && record.department === 'Supervis√£o') {
                                // NOVO FORMATO para Aulas Previstas e Aulas Dadas com turmas din√¢micas
                                if (record.turmas && Array.isArray(record.turmas) && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Aulas Previstas': record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0),
                                        'Total de Aulas Realizadas': record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0),
                                        'Taxa de Cumprimento Geral': (() => {
                                            const totalPrevistas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0), 0);
                                            const totalDadas = record.turmas.reduce((total, t) => total + (t.componentes || []).reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0), 0);
                                            return totalPrevistas > 0 ? Math.round((totalDadas / totalPrevistas) * 100) + '%' : '0%';
                                        })(),
                                        'Turmas': record.turmas.map(t => t.idTurma).join('; '),
                                        'Bimestres por Turma': record.turmas.map(t => t.bimester).join('; '),
                                        'Situa√ß√£o por Turma': record.turmas.map(t => t.situation).join('; '),
                                        'Componentes por Turma': record.turmas.map(t => t.componentes ? t.componentes.map(c => c.nome).join(', ') : 'N/A').join('; '),
                                        'Aulas Previstas por Turma': record.turmas.map(t => t.componentes ? t.componentes.reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0) : 0).join('; '),
                                        'Aulas Dadas por Turma': record.turmas.map(t => t.componentes ? t.componentes.reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0) : 0).join('; '),
                                        'Taxa por Turma': record.turmas.map(t => {
                                            if (t.componentes && t.componentes.length > 0) {
                                                const previstas = t.componentes.reduce((sum, c) => sum + (parseInt(c.aulasPrevistas) || 0), 0);
                                                const dadas = t.componentes.reduce((sum, c) => sum + (parseInt(c.aulasDadas) || 0), 0);
                                                return previstas > 0 ? Math.round((dadas / previstas) * 100) + '%' : '0%';
                                            }
                                            return 'N/A';
                                        }).join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Turma': record.className || 'N/A',
                                        'Disciplina': record.discipline || 'N/A',
                                        'Professor': record.professorName || 'N/A',
                                        'Status': record.teacherAbsence || record.schoolEvent || record.holiday || record.strike || record.sgeUnavailable || record.professorNotLaunched || record.others ? 'Com Motivos' : 'Sem Motivos'
                                    };
                                }
                            } else if (record.indicator === 'Busca Ativa' && record.department === 'Supervis√£o') {
                                // NOVO FORMATO para Busca Ativa com turmas din√¢micas
                                if (record.turmas && record.turmas.length > 0) {
                                    return {
                                        ...baseData,
                                        'Status Geral': record.turmas.some(t => t.estudantes.some(e => e.pcd || e.ministerioPublico || e.menorIdade || e.atestadoMedico || e.conselhoTutelar)) ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes',
                                        'N√∫mero de Turmas': record.turmas.length,
                                        'Total de Estudantes': record.turmas.reduce((total, t) => total + t.estudantes.length, 0),
                                        'Total de Faltas': record.turmas.reduce((total, t) => total + t.estudantes.reduce((subTotal, e) => subTotal + (parseInt(e.faltas) || 0), 0), 0),
                                        'Total de Visitas': record.turmas.reduce((total, t) => total + t.estudantes.reduce((subTotal, e) => subTotal + ((e.visit1 ? 1 : 0) + (e.visit2 ? 1 : 0) + (e.visit3 ? 1 : 0)), 0), 0),
                                        'Turmas': record.turmas.map(t => t.nome).join('; '),
                                        'Estudantes por Turma': record.turmas.map(t => t.estudantes.length).join('; '),
                                        'Faltas por Turma': record.turmas.map(t => t.estudantes.reduce((total, e) => total + (parseInt(e.faltas) || 0), 0)).join('; '),
                                        'Visitas por Turma': record.turmas.map(t => t.estudantes.reduce((total, e) => total + ((e.visit1 ? 1 : 0) + (e.visit2 ? 1 : 0) + (e.visit3 ? 1 : 0)), 0)).join('; ')
                                    };
                                } else {
                                    // FORMATO ANTIGO para compatibilidade
                                    return {
                                        ...baseData,
                                        'Status': record.pcd || record.ministerioPublico || record.menorIdade || record.atestadoMedico || record.conselhoTutelar ? 'Com Observa√ß√µes' : 'Sem Observa√ß√µes'
                                    };
                                }
                            } else {
                                // Outros indicadores da Supervis√£o
                                return {
                                    ...baseData,
                                    'Estudante': record.studentName || 'N/A',
                                    'N¬∫ de Faltas': record.totalAbsences || record.consecutiveAbsences || 'N/A',
                                    'Total de Estudantes': record.totalStudents || 'N/A',
                                    'Bimestres': record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A',
                                    'Etapa': record.etapa || 'N/A',
                                    'ID Turma': record.turmaId || 'N/A',
                                    'Data Refer√™ncia': record.referenceDate ? new Date(record.referenceDate).toLocaleDateString('pt-BR') : 'N/A',
                                    'ID Turma': record.classId || 'N/A',
                                    'Nome Turma': record.className || 'N/A',
                                    'Disciplina': record.discipline || 'N/A',
                                    'Per√≠odo Inicial': record.periodStart ? new Date(record.periodStart).toLocaleDateString('pt-BR') : 'N/A',
                                    'Per√≠odo Final': record.periodEnd ? new Date(record.periodEnd).toLocaleDateString('pt-BR') : 'N/A',
                                    'Professor': record.professorName || 'N/A',
                                    'Bimestre': record.bimester || 'N/A',
                                    'Situa√ß√£o': record.situation || 'N/A',
                                    'Falta Docente': record.teacherAbsence ? 'Sim' : 'N√£o',
                                    'Evento Escolar': record.schoolEvent ? 'Sim' : 'N√£o',
                                    'Feriado': record.holiday ? 'Sim' : 'N√£o',
                                    'Greve': record.strike ? 'Sim' : 'N√£o',
                                    'Indisponibilidade SGE': record.sgeUnavailable ? 'Sim' : 'N√£o',
                                    'N√£o Lan√ßamento SGE': record.professorNotLaunched ? 'Sim' : 'N√£o',
                                    'Outros': record.others ? 'Sim' : 'N√£o',
                                    'Nota': record.studentGrade || 'N/A',
                                    'Situa√ß√£o Estudante': record.studentSituation || 'N/A',
                                    'S√©rie/Turma': record.seriesClass || 'N/A',
                                    'Componentes Curriculares Abaixo da M√©dia': record.curricularComponents || 'N/A',
                                    'L√≠ngua Portuguesa': record.subjects?.portuguese ? 'Sim' : 'N√£o',
                                    'Matem√°tica': record.subjects?.mathematics ? 'Sim' : 'N√£o',
                                    'Hist√≥ria': record.subjects?.history ? 'Sim' : 'N√£o',
                                    'Geografia': record.subjects?.geography ? 'Sim' : 'N√£o',
                                    'Ci√™ncias': record.subjects?.science ? 'Sim' : 'N√£o',
                                    'Educa√ß√£o F√≠sica': record.subjects?.physicalEducation ? 'Sim' : 'N√£o',
                                    'Arte': record.subjects?.arts ? 'Sim' : 'N√£o',
                                    'Ingl√™s': record.subjects?.english ? 'Sim' : 'N√£o',
                                    'Filosofia': record.subjects?.philosophy ? 'Sim' : 'N√£o',
                                    'Sociologia': record.subjects?.sociology ? 'Sim' : 'N√£o',
                                    'Biologia': record.subjects?.biology ? 'Sim' : 'N√£o',
                                    'F√≠sica': record.subjects?.physics ? 'Sim' : 'N√£o',
                                    'Qu√≠mica': record.subjects?.chemistry ? 'Sim' : 'N√£o',
                                    'Literatura': record.subjects?.literature ? 'Sim' : 'N√£o',
                                    'Espanhol': record.subjects?.spanish ? 'Sim' : 'N√£o',
                                    'Outros': record.subjects?.others ? 'Sim' : 'N√£o',
                                    'Especifica√ß√£o de Outros': record.subjects?.otherSubjects || 'N/A',
                                    'Faltas': record.absences || 'N/A',
                                    'Total Visitas': record.totalVisits || 'N/A',
                                    'PCD': record.pcd ? 'Sim' : 'N√£o',
                                    'Minist√©rio P√∫blico': record.ministerioPublico ? 'Sim' : 'N√£o',
                                    'Menor de Idade': record.menorIdade ? 'Sim' : 'N√£o',
                                    'Atestado M√©dico': record.atestadoMedico ? 'Sim' : 'N√£o',
                                    'Conselho Tutelar': record.conselhoTutelar ? 'Sim' : 'N√£o'
                                };
                            }
                        });

                        const supervisionSheet = XLSX.utils.json_to_sheet(supervisionData);
                        XLSX.utils.book_append_sheet(workbook, supervisionSheet, 'Supervis√£o');
                    }

                    // Aba 4: Resumo Geral
                    const summaryData = filteredRecords.map(record => ({
                        'Departamento': record.department,
                        'Indicador': record.indicator,
                        'Escola': record.school,
                        'Munic√≠pio': record.municipality,
                        'T√©cnico': record.technician,
                        'Data': record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A',
                        'Estudante': record.department === 'Supervis√£o' ? 'N/A' : (record.studentName || 'N/A'),
                        'N¬∫ de Faltas': record.department === 'Supervis√£o' ? 'N/A' : (record.totalAbsences || record.consecutiveAbsences || 'N/A'),
                        'Total de Estudantes': record.department === 'Supervis√£o' ? (record.totalStudents || 'N/A') : 'N/A',
                        'Bimestres': record.selectedBimesters ? record.selectedBimesters.join(', ') : 'N/A',
                        'Etapa': record.etapa || 'N/A',
                        'ID Turma': record.turmaId || 'N/A',
                        'Observa√ß√µes': record.observations || 'N/A'
                    }));

                    const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(workbook, summarySheet, 'Resumo Geral');

                    // Ajustar largura das colunas automaticamente
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const columnWidths = [];
                        
                        // Calcular largura m√°xima para cada coluna
                        XLSX.utils.sheet_to_json(worksheet, { header: 1 }).forEach(row => {
                            row.forEach((cell, index) => {
                                const cellLength = cell ? cell.toString().length : 0;
                                columnWidths[index] = Math.max(columnWidths[index] || 0, cellLength);
                            });
                        });

                        // Aplicar largura das colunas
                        worksheet['!cols'] = columnWidths.map(width => ({ width: Math.min(Math.max(width + 2, 10), 50) }));
                    });

                    // Gerar e baixar o arquivo Excel
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `registros_unificados_${new Date().toISOString().split('T')[0]}.xlsx`;
                    link.click();
                    URL.revokeObjectURL(url);

                    // Remover o script ap√≥s o uso
                    document.head.removeChild(script);
                };

                script.onerror = () => {
                    alert('Erro ao carregar a biblioteca de exporta√ß√£o Excel. Tente novamente.');
                };

            } catch (error) {
                console.error('Erro na exporta√ß√£o Excel:', error);
                alert('Erro ao exportar para Excel. Tente novamente.');
            }
        }

        // Download PDF profissional com todas as informa√ß√µes
        async function downloadPDF() {
            if (filteredRecords.length === 0) {
                alert('Nenhum registro para exportar!');
                return;
            }

            try {
                // Carregar a biblioteca jsPDF
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    const { jsPDF } = window.jspdf;
                    
                    // Criar novo documento PDF
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 20;
                    const contentWidth = pageWidth - (2 * margin);
                    
                    let yPosition = 30;
                    let currentPage = 1;

                    // Fun√ß√£o para adicionar nova p√°gina
                    const addNewPage = () => {
                        doc.addPage();
                        currentPage++;
                        yPosition = 30;
                        
                        // Cabe√ßalho da nova p√°gina
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text('SRE GURUPI - Sistema de Registros', pageWidth / 2, 20, { align: 'center' });
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`P√°gina ${currentPage}`, pageWidth - margin, 20, { align: 'right' });
                    };

                    // Cabe√ßalho principal
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RELAT√ìRIO DE REGISTROS UNIFICADOS', pageWidth / 2, yPosition, { align: 'center' });
                    yPosition += 15;

                    // Informa√ß√µes do relat√≥rio
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Total de registros: ${filteredRecords.length}`, margin, yPosition);
                    yPosition += 8;
                    doc.text(`Data de gera√ß√£o: ${new Date().toLocaleString('pt-BR')}`, margin, yPosition);
                    yPosition += 15;

                    // Separar registros por departamento
                    const curriculumRecords = filteredRecords.filter(record => record.department === 'Curr√≠culo');
                    const multiprofessionalRecords = filteredRecords.filter(record => record.department === 'Equipe Multiprofissional');
                    const supervisionRecords = filteredRecords.filter(record => record.department === 'Supervis√£o');

                    // Fun√ß√£o para verificar se precisa de nova p√°gina
                    const checkPageBreak = (requiredSpace) => {
                        if (yPosition + requiredSpace > pageHeight - margin) {
                            addNewPage();
                        }
                    };

                    // Fun√ß√£o para adicionar t√≠tulo de se√ß√£o
                    const addSectionTitle = (title) => {
                        checkPageBreak(15);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(title, margin, yPosition);
                        yPosition += 10;
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                    };

                    // Fun√ß√£o para adicionar registro detalhado
                    const addDetailedRecord = (record, index) => {
                        const recordHeight = 80; // Altura estimada para cada registro
                        checkPageBreak(recordHeight);

                        // N√∫mero do registro
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${record.indicator}`, margin, yPosition);
                        yPosition += 6;

                        // Informa√ß√µes b√°sicas
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Departamento: ${record.department}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Escola: ${record.school}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Munic√≠pio: ${record.municipality}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`T√©cnico: ${record.technician}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`Data: ${record.date ? new Date(record.date).toLocaleDateString('pt-BR') : 'N/A'}`, margin, yPosition);
                        yPosition += 5;

                        // Estudante se existir
                        if (record.department === 'Supervis√£o') {
                            if (record.totalStudents) {
                                doc.text(`Total de Estudantes: ${record.totalStudents}`, margin, yPosition);
                                yPosition += 5;
                            }
                        } else if (record.studentName) {
                            doc.text(`Estudante: ${record.studentName}`, margin, yPosition);
                            yPosition += 5;
                        }

                        // Observa√ß√µes se existir
                        if (record.observations && record.observations !== 'N/A') {
                            doc.text(`Observa√ß√µes: ${record.observations}`, margin, yPosition);
                            yPosition += 5;
                        }

                        // Informa√ß√µes espec√≠ficas por indicador
                        if (record.indicator === 'Busca Ativa') {
                            if (record.pcd || record.ministerioPublico || record.menorIdade || record.atestadoMedico || record.conselhoTutelar) {
                                doc.text('Informa√ß√µes Espec√≠ficas:', margin, yPosition);
                                yPosition += 5;
                                if (record.pcd) doc.text('‚Ä¢ PCD: Sim', margin + 5, yPosition), yPosition += 4;
                                if (record.ministerioPublico) doc.text('‚Ä¢ Minist√©rio P√∫blico: Sim', margin + 5, yPosition), yPosition += 4;
                                if (record.menorIdade) doc.text('‚Ä¢ Menor de Idade: Sim', margin + 5, yPosition), yPosition += 4;
                                if (record.atestadoMedico) doc.text('‚Ä¢ Atestado M√©dico: Sim', margin + 5, yPosition), yPosition += 4;
                                if (record.conselhoTutelar) doc.text('‚Ä¢ Conselho Tutelar: Sim', margin + 5, yPosition), yPosition += 4;
                            }
                            if (record.totalVisits) {
                                doc.text(`Total de Visitas: ${record.totalVisits}`, margin, yPosition);
                                yPosition += 5;
                            }
                            if (record.absences) {
                                doc.text(`Faltas: ${record.absences}`, margin, yPosition);
                                yPosition += 5;
                            }
                        }

                        if (record.indicator === 'Aulas Previstas e Aulas Dadas') {
                            if (record.referenceDate || record.classId || record.discipline) {
                                doc.text('Detalhes das Aulas:', margin, yPosition);
                                yPosition += 5;
                                if (record.referenceDate) doc.text(`‚Ä¢ Data Refer√™ncia: ${new Date(record.referenceDate).toLocaleDateString('pt-BR')}`, margin + 5, yPosition), yPosition += 4;
                                if (record.classId) doc.text(`‚Ä¢ ID Turma: ${record.classId}`, margin + 5, yPosition), yPosition += 4;
                                if (record.discipline) doc.text(`‚Ä¢ Disciplina: ${record.discipline}`, margin + 5, yPosition), yPosition += 4;
                                if (record.professorName) doc.text(`‚Ä¢ Professor: ${record.professorName}`, margin + 5, yPosition), yPosition += 4;
                                if (record.bimester) doc.text(`‚Ä¢ Bimestre: ${record.bimester}`, margin + 5, yPosition), yPosition += 4;
                            }
                        }

                        if (record.indicator === 'Estudantes Abaixo da M√©dia') {
                            if (record.studentGrade || record.studentSituation) {
                                doc.text('Informa√ß√µes do Estudante:', margin, yPosition);
                                yPosition += 5;
                                if (record.studentGrade) doc.text(`‚Ä¢ Nota: ${record.studentGrade}`, margin + 5, yPosition), yPosition += 4;
                                if (record.studentSituation) doc.text(`‚Ä¢ Situa√ß√£o: ${record.studentSituation}`, margin + 5, yPosition), yPosition += 4;
                                if (record.series) doc.text(`‚Ä¢ S√©rie/Turma: ${record.series}`, margin + 5, yPosition), yPosition += 4;
                            }
                        }

                        yPosition += 8; // Espa√ßo entre registros
                    };

                    // Se√ß√£o Curr√≠culo
                    if (curriculumRecords.length > 0) {
                        addSectionTitle('CURR√çCULO');
                        curriculumRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Se√ß√£o Equipe Multiprofissional
                    if (multiprofessionalRecords.length > 0) {
                        addSectionTitle('EQUIPE MULTIPROFISSIONAL');
                        multiprofessionalRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Se√ß√£o Supervis√£o
                    if (supervisionRecords.length > 0) {
                        addSectionTitle('SUPERVIS√ÉO');
                        supervisionRecords.forEach((record, index) => {
                            addDetailedRecord(record, index);
                        });
                    }

                    // Rodap√© na √∫ltima p√°gina
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Relat√≥rio gerado automaticamente pelo Sistema SRE GURUPI', pageWidth / 2, pageHeight - 10, { align: 'center' });

                    // Salvar o PDF
                    doc.save(`relatorio_registros_unificados_${new Date().toISOString().split('T')[0]}.pdf`);

                    // Remover o script ap√≥s o uso
                    document.head.removeChild(script);
                };

                script.onerror = () => {
                    alert('Erro ao carregar a biblioteca de exporta√ß√£o PDF. Tente novamente.');
                };

            } catch (error) {
                console.error('Erro na exporta√ß√£o PDF:', error);
                alert('Erro ao exportar para PDF. Tente novamente.');
            }
        }

        // Inicializar
        checkAuth();
        loadAllRecords();

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('viewModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Fun√ß√µes para gerenciar turmas dinamicamente
        function addNewTurma() {
            const container = document.getElementById('editTurmasContainer');
            if (!container) return;
            
            const currentTurmas = container.children.length;
            const newTurmaIndex = currentTurmas;
            
            const newTurmaHTML = `
                <div class="edit-turma-section" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                    <h4 style="color: #495057; margin-bottom: 15px;">Nova Turma ${newTurmaIndex + 1}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label>Nome da Turma:</label>
                            <input type="text" id="editTurmaNome_${newTurmaIndex}" value="" required>
                        </div>
                        <div>
                            <label>N√∫mero de Estudantes Abaixo da M√©dia:</label>
                            <input type="number" id="editTurmaNumeroEstudantes_${newTurmaIndex}" value="0" min="0" required>
                        </div>
                        <div>
                            <label>Componentes Curriculares:</label>
                            <input type="text" id="editTurmaComponentesCurriculares_${newTurmaIndex}" value="" placeholder="Ex: Matem√°tica, Portugu√™s">
                        </div>
                        <div>
                            <label>Componentes Detalhados:</label>
                            <input type="text" id="editTurmaComponentesDetalhados_${newTurmaIndex}" value="" placeholder="Ex: √Ålgebra, Geometria, Gram√°tica">
                        </div>
                        <div>
                            <label>Situa√ß√£o:</label>
                            <select id="editTurmaSituacao_${newTurmaIndex}" required>
                                <option value="Acompanhamento" selected>Acompanhamento</option>
                                <option value="Resolvido">Resolvido</option>
                                <option value="Pendente">Pendente</option>
                            </select>
                        </div>
                        <div>
                            <label>Etapa:</label>
                            <select id="editTurmaEtapa_${newTurmaIndex}" required>
                                <option value="">Selecione</option>
                                <option value="Ensino Fundamental">Ensino Fundamental</option>
                                <option value="Ensino M√©dio">Ensino M√©dio</option>
                                <option value="Ensino Fundamental e Ensino M√©dio">Ensino Fundamental e Ensino M√©dio</option>
                                <option value="EJA">EJA</option>
                                <option value="Ensino Fundamental e EJA">Ensino Fundamental e EJA</option>
                                <option value="Ensino M√©dio e EJA">Ensino M√©dio e EJA</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newTurmaHTML);
        }

        function removeLastTurma() {
            const container = document.getElementById('editTurmasContainer');
            if (!container || container.children.length <= 1) {
                alert('Deve haver pelo menos uma turma!');
                return;
            }
            
            container.removeChild(container.lastElementChild);
        }

        function addNewEstudante(turmaIndex) {
            const container = document.getElementById(`editEstudantesContainer_${turmaIndex}`);
            if (!container) return;
            
            const currentEstudantes = container.children.length;
            const newEstudanteIndex = currentEstudantes;
            
            const newEstudanteHTML = `
                <div class="edit-estudante-section" style="background: white; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin: 10px 0;">
                    <h6 style="color: #495057; margin-bottom: 10px;">üë§ Novo Estudante ${newEstudanteIndex + 1}</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Nome:</label>
                            <input type="text" id="editEstudanteNome_${turmaIndex}_${newEstudanteIndex}" value="" required>
                        </div>
                        <div>
                            <label>N¬∫ de Faltas:</label>
                            <input type="number" id="editEstudanteFaltas_${turmaIndex}_${newEstudanteIndex}" value="0" min="0" required>
                        </div>
                        <div>
                            <label>PCD:</label>
                            <input type="checkbox" id="editEstudantePCD_${turmaIndex}_${newEstudanteIndex}">
                        </div>
                        <div>
                            <label>Minist√©rio P√∫blico:</label>
                            <input type="checkbox" id="editEstudanteMinisterioPublico_${turmaIndex}_${newEstudanteIndex}">
                        </div>
                        <div>
                            <label>Menor de Idade:</label>
                            <input type="checkbox" id="editEstudanteMenorIdade_${turmaIndex}_${newEstudanteIndex}">
                        </div>
                        <div>
                            <label>Atestado M√©dico:</label>
                            <input type="checkbox" id="editEstudanteAtestadoMedico_${turmaIndex}_${newEstudanteIndex}">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newEstudanteHTML);
        }

        function removeLastEstudante(turmaIndex) {
            const container = document.getElementById(`editEstudantesContainer_${turmaIndex}`);
            if (!container || container.children.length <= 0) {
                alert('N√£o h√° estudantes para remover!');
                return;
            }
            
            container.removeChild(container.lastElementChild);
        }

        function addNewComponente(turmaIndex) {
            const container = document.getElementById(`editComponentesContainer_${turmaIndex}`);
            if (!container) return;
            
            const currentComponentes = container.children.length;
            const newComponenteIndex = currentComponentes;
            
            const newComponenteHTML = `
                <div class="edit-componente-section" style="background: white; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin: 10px 0;">
                    <h6 style="color: #495057; margin-bottom: 10px;">üìñ Novo Componente ${newComponenteIndex + 1}</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Nome do Componente:</label>
                            <input type="text" id="editComponenteNome_${turmaIndex}_${newComponenteIndex}" value="" required>
                        </div>
                        <div>
                            <label>Aulas Previstas:</label>
                            <input type="number" id="editComponenteAulasPrevistas_${turmaIndex}_${newComponenteIndex}" value="0" min="0" required>
                        </div>
                        <div>
                            <label>Aulas Dadas:</label>
                            <input type="number" id="editComponenteAulasDadas_${turmaIndex}_${newComponenteIndex}" value="0" min="0" required>
                        </div>
                        <div>
                            <label>Motivo (se houver):</label>
                            <select id="editComponenteMotivo_${turmaIndex}_${newComponenteIndex}">
                                <option value="">Nenhum</option>
                                <option value="Aus√™ncia do Professor">Aus√™ncia do Professor</option>
                                <option value="Evento Escolar">Evento Escolar</option>
                                <option value="Feriado">Feriado</option>
                                <option value="Greve">Greve</option>
                                <option value="SGE Indispon√≠vel">SGE Indispon√≠vel</option>
                                <option value="Professor n√£o Lan√ßou">Professor n√£o Lan√ßou</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newComponenteHTML);
        }

        function removeLastComponente(turmaIndex) {
            const container = document.getElementById(`editComponentesContainer_${turmaIndex}`);
            if (!container || container.children.length <= 0) {
                alert('N√£o h√° componentes para remover!');
                return;
            }
            
            container.removeChild(container.lastElementChild);
        }

        // Exportar fun√ß√µes para o escopo global
        window.logout = logout;
        window.viewRecord = viewRecord;
        window.closeModal = closeModal;
        window.clearAllFilters = clearAllFilters;
        window.refreshRecords = refreshRecords;
        window.downloadExcel = downloadExcel;
        window.downloadPDF = downloadPDF;
        window.deleteRecord = deleteRecord; // Adiciona a fun√ß√£o deleteRecord ao escopo global
        window.markAsResolved = markAsResolved; // Adiciona a fun√ß√£o markAsResolved ao escopo global
        window.getFileIcon = getFileIcon; // Adiciona a fun√ß√£o getFileIcon ao escopo global
        window.addNewTurma = addNewTurma; // Adiciona a fun√ß√£o addNewTurma ao escopo global
        window.removeLastTurma = removeLastTurma; // Adiciona a fun√ß√£o removeLastTurma ao escopo global
        window.addNewEstudante = addNewEstudante; // Adiciona a fun√ß√£o addNewEstudante ao escopo global
        window.removeLastEstudante = removeLastEstudante; // Adiciona a fun√ß√£o removeLastEstudante ao escopo global
        window.addNewComponente = addNewComponente; // Adiciona a fun√ß√£o addNewComponente ao escopo global
        window.removeLastComponente = removeLastComponente; // Adiciona a fun√ß√£o removeLastComponente ao escopo global
    </script>
</body>
</html>
