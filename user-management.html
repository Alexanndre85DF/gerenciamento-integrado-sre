<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Novo Usuário - SRE GURUPI</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <h1>Cadastrar Novo Usuário</h1>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Formulário de Cadastro</h2>
            
            <form id="userForm" class="form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Nome Completo</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" name="cpf" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Função</label>
                        <select id="role" name="role" required>
                            <option value="">Selecione uma função</option>
                            <option value="admin">Administrador</option>
                            <option value="coordinator">Coordenador</option>
                            <option value="teacher">Professor</option>
                            <option value="supervisor">Supervisor</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="school">Escola</label>
                        <input type="text" id="school" name="school" required>
                    </div>
                    <div class="form-group">
                        <label for="department">Departamento</label>
                        <select id="department" name="department" required>
                            <option value="">Selecione um departamento</option>
                            <option value="curriculum">Currículo</option>
                            <option value="supervision">Supervisão</option>
                            <option value="multiprofessional">Equipe Multiprofissional</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar Senha</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">Cadastrar Usuário</button>
                    <a href="admin-panel.html" class="btn btn-secondary">Voltar ao Painel</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABEloTfC_nT5vfDHpeqYdDjNoPCKwE-Eo",
            authDomain: "projeto-alex-aaadf.firebaseapp.com",
            projectId: "projeto-alex-aaadf",
            storageBucket: "projeto-alex-aaadf.firebasestorage.app",
            messagingSenderId: "720032595137",
            appId: "1:720032595137:web:85834232e770a942216840"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Verificar se é super admin
        if (localStorage.getItem('userRole') !== 'super_admin') {
            window.location.href = 'index.html';
        }

        // Função de logout
        window.logout = async function() {
            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erro no logout:', error);
                localStorage.clear();
                window.location.href = 'index.html';
            }
        };

        // Form handler
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                name: formData.get('name'),
                cpf: formData.get('cpf'),
                email: formData.get('email'),
                role: formData.get('role'),
                school: formData.get('school'),
                department: formData.get('department'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword')
            };
            
            // Validações
            if (userData.password !== userData.confirmPassword) {
                alert('As senhas não coincidem!');
                return;
            }
            
            if (userData.password.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres!');
                return;
            }
            
            try {
                // Verificar se CPF já existe
                const cpfQuery = query(collection(db, 'users'), where('cpf', '==', userData.cpf));
                const cpfSnapshot = await getDocs(cpfQuery);
                
                if (!cpfSnapshot.empty) {
                    alert('Este CPF já está cadastrado no sistema!');
                    return;
                }
                
                // Verificar se email já existe
                const emailQuery = query(collection(db, 'users'), where('email', '==', userData.email));
                const emailSnapshot = await getDocs(emailQuery);
                
                if (!emailSnapshot.empty) {
                    alert('Este e-mail já está cadastrado no sistema!');
                    return;
                }
                
                // Criar ID único para o usuário
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Salvar dados do usuário no Firestore (sem Firebase Auth)
                await setDoc(doc(db, 'users', userId), {
                    id: userId,
                    name: userData.name,
                    cpf: userData.cpf,
                    email: userData.email,
                    role: userData.role,
                    school: userData.school,
                    department: userData.department,
                    password: userData.password, // Senha armazenada localmente
                    createdAt: new Date(),
                    createdBy: localStorage.getItem('userCPF'),
                    status: 'active'
                });
                
                alert('Usuário cadastrado com sucesso!');
                e.target.reset();
                
            } catch (error) {
                console.error('Erro ao cadastrar usuário:', error);
                alert('Erro ao cadastrar usuário: ' + error.message);
            }
        });
    </script>
</body>
</html>
